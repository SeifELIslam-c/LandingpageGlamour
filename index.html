<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boutique Glamour</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- تحميل مكتبة الأيقونات Lucide -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.min.js"></script>
    <!-- خطوط Cairo و Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- أيقونة الموقع (اختياري) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🛍️</text></svg>">

    <style>
        /* إعدادات الخطوط الافتراضية */
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            background-color: #f8fafc; /* لون خلفية أفتح قليلاً */
        }

        /* تنسيقات إضافية */
        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .color-swatch.selected::after {
            content: '';
            position: absolute;
            top: -4px; right: -4px; bottom: -4px; left: -4px;
            border: 2px solid #3b82f6; /* لون أزرق للإشارة للاختيار */
            border-radius: 50%;
        }
         .color-swatch:hover {
            transform: scale(1.1);
        }

        .size-tag {
            border: 1px solid #cbd5e1;
            padding: 6px 16px;
            border-radius: 99px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            background-color: white;
        }
         .size-tag:hover:not(.selected):not(:disabled) {
             background-color: #f1f5f9;
         }
        .size-tag.selected {
            background-color: #1f2937;
            color: #fff;
            border-color: #1f2937;
        }
         .size-tag:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #e2e8f0;
         }

        /* لإخفاء وإظهار الصفحات */
        .page {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* مودال (Modal) */
        .modal {
            transition: opacity 0.3s ease;
        }

        /* تحميل (Spinner) */
        .loader {
            border: 4px solid #e5e7eb; /* Light gray */
            border-top: 4px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
         .loader.btn-loader { /* Spinner for buttons */
             border-color: rgba(255, 255, 255, 0.3);
             border-top-color: #fff;
         }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* تصميم كروت الراديو للاختيار بين التوصيل */
        .radio-card-group label input[type="radio"] { display: none; }
        .radio-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem 1rem;
            text-align: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            background-color: white;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .radio-card-group label input[type="radio"]:checked + .radio-card {
            border-color: #3b82f6; /* Blue */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background-color: #eff6ff; /* Light Blue */
        }
        .radio-card-group label:hover input[type="radio"]:not(:checked) + .radio-card {
             border-color: #9ca3af; /* Gray */
        }
        .radio-card-group label.disabled .radio-card {
             opacity: 0.5;
             cursor: not-allowed;
             background-color: #f3f4f6;
        }
        .radio-card .icon {
             margin-bottom: 0.75rem;
             color: #6b7280; /* Gray */
             transition: color 0.2s ease-in-out;
        }
         .radio-card-group label input[type="radio"]:checked + .radio-card .icon {
             color: #3b82f6; /* Blue */
         }

        /* زر حذف الصورة */
        .remove-image-btn {
            position: absolute;
            top: -8px;
            left: -8px; /* For RTL */
            background-color: #ef4444; /* Red */
            color: white;
            border-radius: 50%;
            padding: 2px;
            display: none;
            cursor: pointer;
            z-index: 10;
        }
        .image-preview-item:hover .remove-image-btn {
            display: block;
        }

        /* تحسين عرض كرت المنتج */
        .product-card-image-container {
            aspect-ratio: 1 / 1; /* نسبة عرض إلى ارتفاع مربعة */
            overflow: hidden;
            background-color: #f1f5f9; /* لون خلفية للصور الشفافة أو التي لا تملأ */
        }
        .product-card-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* لملء الحاوية مع الحفاظ على الأبعاد وقص الزائد */
            transition: transform 0.3s ease-in-out;
        }
        .group:hover .product-card-image-container img {
            transform: scale(1.05); /* تكبير بسيط عند المرور */
        }

    </style>
</head>
<body class="bg-gray-100">

    <!-- بداية حاوية التطبيق الرئيسية -->
    <div id="app" class="min-h-screen flex flex-col">

        <!-- ====================================================== -->
        <!-- =========== رأس الصفحة (Header) للعميل =========== -->
        <!-- ====================================================== -->
        <header id="customer-header" class="bg-white shadow-sm sticky top-0 z-40">
            <nav class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- اللوجو -->
                    <a href="#/" class="text-2xl font-bold text-gray-900">Boutique Glamour</a>

                    <!-- روابط التنقل -->
                    <div class="flex items-center space-x-6" dir="ltr">
                        <a href="#/" class="text-gray-600 hover:text-blue-600 font-medium transition-colors">المتجر</a>
                        <a href="#/cart" class="relative text-gray-600 hover:text-blue-600 transition-colors">
                            <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                            <span id="cart-count-badge" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        </a>
                        <!-- رابط الأدمن - يمكن إخفاؤه لاحقاً إذا أردت -->
                        <a href="#/admin" class="text-gray-400 hover:text-gray-700 transition-colors" title="لوحة التحكم">
                            <i data-lucide="user-cog" class="w-6 h-6"></i>
                        </a>
                    </div>
                </div>
            </nav>
        </header>

        <!-- ====================================================== -->
        <!-- =========== رأس الصفحة (Header) للأدمن =========== -->
        <!-- ====================================================== -->
        <header id="admin-header" class="bg-gray-900 text-white shadow-md sticky top-0 z-40 hidden">
            <nav class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="#/admin/dashboard" class="text-xl font-bold">لوحة تحكم الأدمن</a>
                    <div class="flex items-center space-x-6" dir="ltr">
                        <a href="#/admin/products" class="text-gray-300 hover:text-white transition-colors">المنتجات</a>
                        <a href="#/admin/orders" class="text-gray-300 hover:text-white transition-colors">الطلبات</a>
                        <!-- <a href="#/admin/settings" class="text-gray-300 hover:text-white transition-colors">الإعدادات</a> --> <!-- تم إخفاؤه مؤقتاً -->
                        <a href="#/" id="admin-logout-btn" class="text-red-400 hover:text-red-300 transition-colors" title="تسجيل الخروج">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </a>
                    </div>
                </div>
            </nav>
        </header>

        <!-- ====================================================== -->
        <!-- ================== حاوية الصفحات ================== -->
        <!-- ====================================================== -->
        <main class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8 flex-grow">

            <!-- صفحة المتجر (عرض المنتجات) -->
            <section id="page-shop" class="page">
                <h1 class="text-3xl font-bold text-gray-900 mb-8 text-center">منتجاتنا</h1>
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <!-- سيتم ملء المنتجات هنا عبر JS -->
                    <div id="shop-loader" class="col-span-full flex justify-center items-center h-64">
                         <div class="loader"></div>
                    </div>
                    <p id="no-products-message" class="col-span-full text-center text-gray-500 py-10 hidden"></p>
                </div>
            </section>

            <!-- صفحة تفاصيل المنتج -->
            <section id="page-product-detail" class="page">
                 <!-- المحتوى سيعرض هنا مع Loader داخلي -->
                 <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
            </section>

            <!-- صفحة السلة -->
            <section id="page-cart" class="page">
                 <!-- المحتوى سيعرض هنا -->
                 <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
            </section>

            <!-- صفحة الدفع (Checkout) -->
            <section id="page-checkout" class="page">
                 <!-- المحتوى سيعرض هنا مع Loader داخلي -->
                 <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
            </section>

            <!-- صفحة تسجيل دخول الأدمن -->
            <section id="page-admin-login" class="page">
                <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md mt-10 border border-gray-200">
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">تسجيل دخول الأدمن</h2>
                    <form id="admin-login-form">
                        <div class="mb-4">
                            <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور</label>
                            <input type="password" id="admin-password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <p id="admin-login-error" class="text-red-600 text-sm mb-4 hidden"></p>
                        <button type="submit" class="w-full bg-gray-900 text-white py-2 px-4 rounded-md font-medium hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 transition-colors">
                            دخول
                        </button>
                    </form>
                </div>
            </section>

            <!-- لوحة تحكم الأدمن (الرئيسية) -->
            <section id="page-admin-dashboard" class="page">
                <h1 class="text-3xl font-bold text-gray-900 mb-8">أهلاً بك في لوحة التحكم</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <a href="#/admin/products" class="block bg-white p-6 rounded-lg shadow border border-gray-200 hover:shadow-lg hover:border-blue-500 transition-all duration-300">
                        <i data-lucide="package" class="w-10 h-10 text-blue-600 mb-3"></i>
                        <h3 class="text-xl font-semibold mb-1 text-gray-800">إدارة المنتجات</h3>
                        <p class="text-gray-600">إضافة وتعديل المنتجات والمخزون.</p>
                    </a>
                    <a href="#/admin/orders" class="block bg-white p-6 rounded-lg shadow border border-gray-200 hover:shadow-lg hover:border-green-500 transition-all duration-300">
                        <i data-lucide="shopping-bag" class="w-10 h-10 text-green-600 mb-3"></i>
                        <h3 class="text-xl font-semibold mb-1 text-gray-800">عرض الطلبات</h3>
                        <p class="text-gray-600">متابعة الطلبات الجديدة والحالية.</p>
                    </a>
                    <!--
                    <a href="#/admin/settings" class="block bg-white p-6 rounded-lg shadow border border-gray-200 hover:shadow-lg hover:border-gray-500 transition-all duration-300">
                        <i data-lucide="settings" class="w-10 h-10 text-gray-600 mb-3"></i>
                        <h3 class="text-xl font-semibold mb-1 text-gray-800">الإعدادات</h3>
                        <p class="text-gray-600">إعدادات الشحن (Yalidine) وغيرها.</p>
                    </a>
                     -->
                </div>
            </section>

            <!-- صفحة عرض منتجات الأدمن -->
            <section id="page-admin-products" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">المنتجات</h1>
                    <a href="#/admin/products/new" class="bg-blue-600 text-white py-2 px-4 rounded-md font-medium hover:bg-blue-700 flex items-center space-x-2 space-x-reverse transition-colors">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        <span>إضافة منتج جديد</span>
                    </a>
                </div>
                <div class="bg-white shadow-md rounded-lg overflow-x-auto border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المنتج</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">السعر</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المخزون</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="admin-product-list" class="bg-white divide-y divide-gray-200">
                            <!-- سيتم ملء المنتجات هنا -->
                            <tr><td colspan="4" class="text-center p-8 text-gray-500"><div class="loader mx-auto"></div></td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- (يمكن إضافة Pagination هنا لاحقاً) -->
            </section>

            <!-- صفحة إضافة/تعديل منتج للأدمن -->
            <section id="page-admin-product-form" class="page">
                 <!-- المحتوى سيعرض هنا -->
                 <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
            </section>

            <!-- صفحة عرض طلبات الأدمن -->
            <section id="page-admin-orders" class="page">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">الطلبات</h1>
                <div class="bg-white shadow-md rounded-lg overflow-x-auto border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">العميل</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجمالي</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                            </tr>
                        </thead>
                        <tbody id="admin-order-list" class="bg-white divide-y divide-gray-200">
                            <!-- سيتم ملء الطلبات هنا -->
                            <tr><td colspan="6" class="text-center p-8 text-gray-500"><div class="loader mx-auto"></div></td></tr>
                        </tbody>
                    </table>
                </div>
                 <!-- (يمكن إضافة Pagination هنا لاحقاً) -->
            </section>

            <!-- صفحة تفاصيل طلب للأدمن -->
            <section id="page-admin-order-detail" class="page">
                 <!-- المحتوى سيعرض هنا -->
                 <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
            </section>

            <!-- صفحة إعدادات الأدمن (ياليدين) - تم إخفاؤها لأن المفاتيح في Netlify -->
            <!--
            <section id="page-admin-settings" class="page">
                 <h1 class="text-3xl font-bold text-gray-900 mb-6">الإعدادات</h1>
                 <p class="text-gray-600 bg-yellow-100 p-4 rounded-md border border-yellow-300">
                      تم نقل إعدادات Yalidine API إلى متغيرات البيئة في Netlify لزيادة الأمان.
                      لم تعد هذه الصفحة تُستخدم لإدخال المفاتيح.
                 </p>
            </section>
             -->

        </main>

        <!-- ====================================================== -->
        <!-- ================== المودال (Modal) ================== -->
        <!-- ====================================================== -->
        <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden opacity-0 modal" style="transition: opacity 0.3s ease;"></div>
        <div id="modal-container" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden opacity-0 scale-95 modal" style="transition: opacity 0.3s ease, transform 0.3s ease;">
            <div id="modal-content" class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center transform transition-all">
                <!-- سيتم ملء محتوى المودال هنا -->
                 <div class="loader mx-auto"></div>
            </div>
        </div>

        <!-- Toast Notification Container -->
         <div id="toast-container" class="fixed bottom-5 left-5 z-[70] space-y-3"></div>

    </div> <!-- نهاية حاوية التطبيق -->

    <!-- ====================================================== -->
    <!-- ================== بداية كود JavaScript ================== -->
    <!-- ====================================================== -->

    <!-- Firebase SDK - سيتم استبدال هذا بالإعدادات من بيئة العمل -->
    <!-- <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // !! هام: سيتم استخدام __firebase_config بدلاً من هذا !!
        const firebaseConfig = {
           // ... (بيانات الإعداد الخاصة بك)
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        window._firebaseApp = app; // Make it globally accessible for the main script
    </script> -->

    <!-- السكربت الرئيسي للتطبيق -->
    <script type="module" defer>
        // استيراد دوال Firebase Firestore و Auth
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, writeBatch, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { enableIndexedDbPersistence, CACHE_SIZE_UNLIMITED } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; // For offline persistence

        // ==========================================
        // إعداد Firebase
        // ==========================================
        let app, db, auth, userId = null;
        let productsUnsubscribe = null; // لإلغاء الاستماع للمنتجات
        let ordersUnsubscribe = null; // لإلغاء الاستماع للطلبات

        async function initializeFirebase() {
    try {
        // استخدام الإعدادات والتكن من بيئة العمل
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        if (!firebaseConfig) {
            console.error("Firebase config not found!");
            showToast("خطأ في إعداد قاعدة البيانات. لا يمكن تحميل التطبيق.", "error", 10000);
            // يمكنك عرض رسالة خطأ للمستخدم هنا
            document.body.innerHTML = '<p class="text-center text-red-600 p-10">خطأ حرج: لم يتم العثور على إعدادات قاعدة البيانات.</p>';
            return false;
        }

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // *** هذا هو التعديل الصحيح: تعريف المسارات هنا الآن بعد تهيئة db ***
        productsCollection = collection(db, 'products');
        ordersCollection = collection(db, 'orders');
        // *** نهاية التعديل ***

        // تفعيل التخزين المحلي (Offline Persistence) - اختياري لكن مفيد
        try {
            await enableIndexedDbPersistence(db, { cacheSizeBytes: CACHE_SIZE_UNLIMITED });
            console.log("Firebase offline persistence enabled.");
        } catch (err) {
            if (err.code == 'failed-precondition') {
                console.warn("Multiple tabs open, persistence can only be enabled in one tab at a a time.");
            } else if (err.code == 'unimplemented') {
                console.warn("The current browser does not support all of the features required to enable persistence.");
            } else {
                console.error("Error enabling offline persistence:", err);
            }
        }


        // محاولة تسجيل الدخول بالتكن أو كمجهول
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // المستخدم مسجل دخوله (سواء بتكن أو مجهول)
                userId = user.uid;
                console.log("User is signed in:", userId);
                if (user.isAnonymous) {
                    console.log("User is anonymous.");
                } else {
                    console.log("User signed in with custom token.");
                }
                // الآن بعد التأكد من تسجيل الدخول، ابدأ بالاستماع للبيانات
                setupFirestoreListeners();
                initializeAppUI(); // تهيئة واجهة المستخدم والراوتر
            } else {
                // لا يوجد مستخدم، حاول تسجيل الدخول
                console.log("No user signed in, attempting sign in...");
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                    // onAuthStateChanged سيُستدعى مرة أخرى بعد نجاح تسجيل الدخول
                } catch (error) {
                    console.error("Error signing in:", error);
                    showToast("خطأ في الاتصال بقاعدة البيانات.", "error", 10000);
                    document.body.innerHTML = '<p class="text-center text-red-600 p-10">خطأ حرج: فشل الاتصال بقاعدة البيانات.</p>';
                }
            }
        });

        return true;

    } catch (error) {
        console.error("Firebase Initialization Error:", error);
        showToast("فشل تهيئة قاعدة البيانات.", "error", 10000);
        document.body.innerHTML = '<p class="text-center text-red-600 p-10">خطأ حرج: فشل تهيئة قاعدة البيانات.</p>';
        return false;
    }
}


        // ==========================================
        // النظام الأساسي: التخزين، الحالة، والراوتر
        // ==========================================

        // 1. كلمة سر الأدمن (غيّرها أو انقلها لـ environment variable لاحقاً!)
        const ADMIN_PASSWORD = 'admin123';

        // 2. محاكاة قاعدة البيانات (Database) باستخدام localStorage للسلة والإعدادات المؤقتة فقط
        const localDb = {
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.error(`Failed to get from localStorage: ${key}`, e);
                    return defaultValue;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.error(`Failed to save to localStorage: ${key}`, e);
                }
            }
        };

        // 3. الحالة العامة للتطبيق (In-Memory State - ستُملأ من Firestore)
        const state = {
            products: [], // ستُملأ من Firestore
            orders: [], // ستُملأ من Firestore
            cart: localDb.get('cart', []), // السلة تبقى محلية مؤقتاً
            yalidineSettings: {}, // لم تعد تُستخدم للمفاتيح، لكن قد تُستخدم لإعدادات أخرى لاحقاً
            lastFetched: { // لتخزين وقت آخر جلب لبيانات Yalidine
                wilayas: 0,
                communes: {}, // wilayaId: timestamp
                fees: {},    // wilayaId: timestamp
                centers: {}    // wilayaId: timestamp
            },
            cache: { // لتخزين بيانات Yalidine مؤقتاً
                 wilayas: localDb.get('yalidine_wilayas_cache'),
                 communes: localDb.get('yalidine_communes_cache', {}),
                 fees: localDb.get('yalidine_fees_cache', {}),
                 centers: localDb.get('yalidine_centers_cache', {})
            },
            appReady: false // لتتبع جاهزية التطبيق بعد تحميل البيانات الأولية
        };
        const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 ساعة بالميلي ثانية

        // مسارات Firestore (استخدم مساراً بسيطاً الآن، يمكن تغييره لاحقاً)
        let productsCollection;
        let ordersCollection;

        // 4. إعداد مستمعي Firestore (للتحديثات الحية)
        function setupFirestoreListeners() {
            // إلغاء المستمعين القدامى إن وجدوا
            if (productsUnsubscribe) productsUnsubscribe();
            if (ordersUnsubscribe) ordersUnsubscribe();

            // الاستماع للمنتجات
            productsUnsubscribe = onSnapshot(productsCollection, (snapshot) => {
                console.log("Products updated from Firestore");
                const productsFromDb = [];
                snapshot.forEach((doc) => {
                    productsFromDb.push({ ...doc.data(), id: doc.id }); // إضافة ID المستند
                });
                state.products = productsFromDb;
                // إعادة عرض الصفحة الحالية إذا كانت تعتمد على المنتجات
                rerenderCurrentPageIfProductDependent();
                state.appReady = true; // اعتبر التطبيق جاهزاً بعد أول تحميل للمنتجات
            }, (error) => {
                console.error("Error listening to products:", error);
                showToast("خطأ في تحميل المنتجات.", "error");
                state.appReady = true; // اعتبره جاهزاً حتى لو فشل، لعرض رسالة الخطأ
                rerenderCurrentPageIfProductDependent(); // لعرض رسالة "لا يوجد منتجات"
            });

            // الاستماع للطلبات (فقط إذا كان المستخدم أدمن؟ أو للكل؟ لنفترض للكل مؤقتاً)
            // ملاحظة: قد تحتاج لقواعد أمان لتحديد من يمكنه قراءة الطلبات
            ordersUnsubscribe = onSnapshot(ordersCollection, (snapshot) => {
                console.log("Orders updated from Firestore");
                const ordersFromDb = [];
                snapshot.forEach((doc) => {
                    ordersFromDb.push({ ...doc.data(), id: doc.id });
                });
                state.orders = ordersFromDb;
                 // إعادة عرض الصفحة الحالية إذا كانت تعتمد على الطلبات (مثل صفحة طلبات الأدمن)
                rerenderCurrentPageIfOrderDependent();
            }, (error) => {
                console.error("Error listening to orders:", error);
                // لا تعرض رسالة خطأ للمستخدم العادي عن فشل تحميل الطلبات
                // showToast("خطأ في تحميل الطلبات.", "error");
            });
        }

        // دالة لإعادة عرض الصفحة الحالية إذا كانت تحتاج لبيانات المنتجات المحدثة
        function rerenderCurrentPageIfProductDependent() {
            const currentHash = window.location.hash || '#/';
            if (currentHash === '#/' || currentHash.startsWith('#/product/') || currentHash === '#/admin/products' || currentHash.startsWith('#/admin/products/edit/') || currentHash === '#/admin/products/new' || currentHash === '#/cart' || currentHash === '#/checkout') {
                 router(); // استدعاء الراوتر سيعيد عرض الصفحة بالبيانات الجديدة
            }
             // تحديث Loader أو رسالة عدم وجود منتجات في صفحة المتجر
             const shopLoader = document.getElementById('shop-loader');
             const noProductsMsg = document.getElementById('no-products-message');
             if (shopLoader && noProductsMsg) {
                  shopLoader.classList.add('hidden');
                  const hasProducts = state.products.length > 0;
                  noProductsMsg.classList.toggle('hidden', hasProducts);
                  if (!hasProducts) {
                       noProductsMsg.textContent = `لا توجد منتجات لعرضها حالياً. ${isAdmin() ? '<a href="#/admin/products/new" class="text-blue-600 font-medium hover:underline">أضف منتجاً</a>' : ''}`;
                  }
             }
        }
         // دالة لإعادة عرض الصفحة الحالية إذا كانت تحتاج لبيانات الطلبات المحدثة
        function rerenderCurrentPageIfOrderDependent() {
            const currentHash = window.location.hash || '#/';
            if (currentHash === '#/admin/orders' || currentHash.startsWith('#/admin/orders/')) {
                 router(); // استدعاء الراوتر سيعيد عرض الصفحة بالبيانات الجديدة
            }
        }


        // 5. الراوتر (Router) لإدارة الصفحات
        const router = () => {
             // لا تقم بتشغيل الراوتر قبل جاهزية التطبيق (تحميل البيانات الأولية)
             if (!state.appReady && !(window.location.hash.startsWith('#/admin'))) {
                  console.log("App not ready, router execution delayed.");
                  return;
             }

            // إخفاء جميع الصفحات
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

            // التحقق من حالة تسجيل دخول الأدمن
            const admin = isAdmin();
             // التأكد من وجود العناصر قبل محاولة تعديلها
             const customerHeader = document.getElementById('customer-header');
             const adminHeader = document.getElementById('admin-header');
             if (customerHeader) customerHeader.classList.toggle('hidden', admin);
             if (adminHeader) adminHeader.classList.toggle('hidden', !admin);


            const hash = window.location.hash || '#/';
            let pageId = '';
            let params = null;

            // --- توجيه العميل ---
            if (hash === '#/') {
                pageId = 'page-shop';
                renderShopPage();
            } else if (hash.startsWith('#/product/')) {
                pageId = 'page-product-detail';
                params = hash.split('/')[2];
                renderProductDetailPage(params); // ستعرض Loader داخلياً وتجلب المنتج
            } else if (hash === '#/cart') {
                pageId = 'page-cart';
                renderCartPage(); // تقرأ من state.cart (localStorage)
            } else if (hash === '#/checkout') {
                pageId = 'page-checkout';
                renderCheckoutPage(); // تحتاج لجلب الولايات
            }
            // --- توجيه الأدمن ---
            else if (hash === '#/admin') {
                pageId = 'page-admin-login';
                if (admin) { goTo('#/admin/dashboard'); return; } // إعادة توجيه إذا كان مسجلاً
                // ربط مستمع فورم تسجيل الدخول عند عرض الصفحة
                setTimeout(() => {
                    const loginForm = document.getElementById('admin-login-form');
                     // إزالة المستمع القديم إن وجد لمنع التكرار
                     const newLoginForm = loginForm?.cloneNode(true);
                     if(loginForm && newLoginForm) {
                          loginForm.parentNode.replaceChild(newLoginForm, loginForm);
                          newLoginForm.addEventListener('submit', handleAdminLogin);
                     }
                }, 0);
            } else if (hash === '#/admin/dashboard') {
                pageId = 'page-admin-dashboard';
                if (!admin) { goTo('#/admin'); return; }
                // لا يوجد تحميل بيانات خاص لهذه الصفحة حالياً
            } else if (hash === '#/admin/products') {
                pageId = 'page-admin-products';
                if (!admin) { goTo('#/admin'); return; }
                renderAdminProductList(); // تقرأ من state.products (Firestore)
            } else if (hash === '#/admin/products/new') {
                pageId = 'page-admin-product-form';
                if (!admin) { goTo('#/admin'); return; }
                renderProductForm(); // وضع الإضافة
            } else if (hash.startsWith('#/admin/products/edit/')) {
                 pageId = 'page-admin-product-form';
                 params = hash.split('/')[4];
                 if (!admin) { goTo('#/admin'); return; }
                 // المنتج سيتم جلبه داخل renderProductForm بناءً على params
                 renderProductForm(params); // وضع التعديل - تمرير ID
            } else if (hash === '#/admin/orders') {
                pageId = 'page-admin-orders';
                if (!admin) { goTo('#/admin'); return; }
                renderAdminOrderList(); // تقرأ من state.orders (Firestore)
            } else if (hash.startsWith('#/admin/orders/')) {
                pageId = 'page-admin-order-detail';
                params = hash.split('/')[3];
                if (!admin) { goTo('#/admin'); return; }
                 // الطلب سيتم جلبه داخل renderOrderDetailPage بناءً على params
                renderOrderDetailPage(params); // تمرير ID
            }
            /* // قسم الإعدادات لم يعد مستخدماً للمفاتيح
            else if (hash === '#/admin/settings') {
                pageId = 'page-admin-settings';
                if (!admin) { goTo('#/admin'); return; }
                renderSettingsPage();
            }
             */
             else {
                 // إذا لم يتطابق أي مسار، انتقل للمتجر
                 goTo('#/');
                 return; // أوقف التنفيذ هنا لتجنب إظهار صفحة خاطئة
            }

            // إظهار الصفحة المحددة
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.add('active');
            } else {
                // صفحة خطأ 404 أو العودة للرئيسية (احتياطي)
                console.error("Page not found for hash:", hash);
                const shopPage = document.getElementById('page-shop');
                if (shopPage) {
                     shopPage.classList.add('active');
                     renderShopPage();
                }
            }

            // إعادة الأيقونات والانتقال للأعلى
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            window.scrollTo(0, 0);
        };

        // 6. وظائف مساعدة (Helpers)
        const goTo = (hash) => window.location.hash = hash;
        const isAdmin = () => sessionStorage.getItem('isAdmin') === 'true';

        // عرض المودال
        const showModal = (content, size = 'max-w-sm') => {
             const modalContent = document.getElementById('modal-content');
             modalContent.innerHTML = content;
             modalContent.className = `bg-white rounded-lg shadow-xl w-full p-6 text-center transform transition-all ${size}`; // Apply size class

             const backdrop = document.getElementById('modal-backdrop');
             const container = document.getElementById('modal-container');

             backdrop.classList.remove('hidden');
             container.classList.remove('hidden');

             // Force reflow to enable transition
             void container.offsetWidth;

             backdrop.classList.add('opacity-100');
             container.classList.add('opacity-100', 'scale-100');
             container.classList.remove('opacity-0', 'scale-95');
             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             } // Render icons inside modal
        };

         // إخفاء المودال
         const hideModal = () => {
             const backdrop = document.getElementById('modal-backdrop');
             const container = document.getElementById('modal-container');

             backdrop.classList.remove('opacity-100');
             container.classList.remove('opacity-100', 'scale-100');
             container.classList.add('opacity-0', 'scale-95');

             setTimeout(() => {
                 backdrop.classList.add('hidden');
                 container.classList.add('hidden');
                 document.getElementById('modal-content').innerHTML = '<div class="loader mx-auto"></div>'; // Reset content
             }, 300); // Match transition duration
        };

        // عرض رسالة (Toast)
        const showToast = (message, type = 'success', duration = 3000) => {
             const container = document.getElementById('toast-container');
             const toast = document.createElement('div');
             const bgColor = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-blue-600');
             const icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'x-circle' : 'info');

             toast.className = `flex items-center space-x-3 space-x-reverse ${bgColor} text-white py-3 px-5 rounded-lg shadow-xl transition-all duration-300 transform translate-y-full opacity-0`;
             toast.innerHTML = `
                 <i data-lucide="${icon}" class="w-5 h-5"></i>
                 <p>${message}</p>
                 <button class="ml-auto -mr-1 p-1 hover:bg-black/20 rounded-full">
                     <i data-lucide="x" class="w-4 h-4"></i>
                 </button>
             `;
             container.appendChild(toast);
             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             }

             // Add close button listener
             toast.querySelector('button').addEventListener('click', () => {
                 toast.classList.add('opacity-0', 'translate-y-full');
                 setTimeout(() => toast.remove(), 300);
             });

             // Animate in
             setTimeout(() => {
                 toast.classList.remove('translate-y-full', 'opacity-0');
                 toast.classList.add('translate-y-0', 'opacity-100');
             }, 100);

             // Auto dismiss
             setTimeout(() => {
                  toast.classList.add('opacity-0', 'translate-y-full');
                  setTimeout(() => {
                       // Ensure toast still exists before removing
                       if (toast.parentNode === container) {
                            toast.remove();
                       }
                  }, 300);
             }, duration);
        };

        // دالة fetch مع معالجة الأخطاء الأساسية (لـ Yalidine Proxy)
        // دالة fetch مع معالجة الأخطاء الأساسية (لـ Yalidine Proxy)
         const apiFetch = async (endpoint, options = {}) => {
             // المفاتيح السرية لم تعد تُرسل من هنا، بل من Netlify Function
             const headers = {
                 'Content-Type': 'application/json',
                'Accept': 'application/json',
                 ...options.headers,
                 };

               // استخدام بروكسي Netlify
               const YALIDINE_BASE_URL = '/yalidine-api'; // هذا المسار سيوجه الطلب إلى الدالة netlify/functions/yalidine-proxy.js
               const url = `${YALIDINE_BASE_URL}${endpoint}`; // استخدام المسار النسبي للبروكسي

               try {
                     console.log(`Fetching via Proxy: ${url} with params:`, options.params);
                     const queryParams = new URLSearchParams(options.params || {}).toString();
                     // تمرير البارامترات في الرابط للدالة (الدالة ستفصل المسار عن البارامترات)
                     const fullUrl = queryParams ? `${url}?${queryParams}` : url;

                     // *** بداية التعديل لحل مشكلة 400 Bad Request ***
                     const fetchOptions = {
                           method: options.method || 'GET',
                           headers: headers,
                     };

                     // أضف الـ body فقط إذا كان موجوداً ولم يكن الطلب GET
                     if (options.body && fetchOptions.method !== 'GET') {
                           fetchOptions.body = JSON.stringify(options.body);
                     }
                     
                     const response = await fetch(fullUrl, fetchOptions);
                     // *** نهاية التعديل ***

                     if (!response.ok) {
                           let errorData;
                           try {
                              errorData = await response.json();
                           } catch(e) {
                               // Fallback if response is not JSON
                               errorData = { message: `خطأ ${response.status}: ${response.statusText || 'فشل الاتصال بخادم الشحن'}` };
                           }
                           console.error('API Error Response (from browser fetch):', errorData, 'Status:', response.status);
                           // استخدم رسالة الخطأ من البروكسي إن وجدت، أو رسالة عامة
                           throw new Error(errorData.message || `خطأ ${response.status} عند الاتصال بخادم الشحن.`);
                     }
                     const data = await response.json();
                     console.log('API Success Response (from browser fetch):', data);
                     return data;

               } catch (error) {
                     console.error(`API Fetch Error (${url}):`, error);
                     // لا تعرض رسالة toast هنا دائماً، قد يتم التعامل معها في مكان الاستدعاء
                     // showToast(`خطأ في الاتصال بخادم الشحن: ${error.message}`, 'error');
                     throw error; // أعد رمي الخطأ ليتم التعامل معه
               }
            };


        // دالة لجلب بيانات Yalidine مع التخزين المؤقت (Caching)
        const fetchYalidineData = async (type, params = {}) => {
             const now = Date.now();
             let cacheKey = type;
             let lastFetchTime = state.lastFetched[type];
             let cachedData = state.cache[type];
             let endpoint = '';
             let specificCacheKey = null; // للمفاتيح المعتمدة على parameters مثل wilaya_id

             switch (type) {
                 case 'wilayas':
                     endpoint = '/wilayas';
                     params.page_size = params.page_size || 60; // Ensure page size
                     break;
                 case 'communes':
                     endpoint = '/communes';
                     params.page_size = params.page_size || 1600;
                     if (!params.wilaya_id) throw new Error("wilaya_id is required for communes");
                     specificCacheKey = params.wilaya_id.toString();
                     lastFetchTime = state.lastFetched.communes[specificCacheKey] || 0;
                     cachedData = state.cache.communes[specificCacheKey];
                     break;
                 case 'fees':
                     endpoint = '/fees';
                     params.from_wilaya_id = 16; // افترض دائماً الشحن من ولاية الجزائر (16)
                     if (!params.to_wilaya_id) throw new Error("to_wilaya_id is required for fees");
                     specificCacheKey = params.to_wilaya_id.toString();
                     lastFetchTime = state.lastFetched.fees[specificCacheKey] || 0;
                     cachedData = state.cache.fees[specificCacheKey];
                     break;
                 case 'centers':
                     endpoint = '/communes'; // Centers are communes with has_stop_desk = true
                     params.page_size = params.page_size || 1600;
                      params.has_stop_desk = true; // اطلب فقط البلديات التي تحتوي على مكتب
                     if (!params.wilaya_id) throw new Error("wilaya_id is required for centers");
                     specificCacheKey = params.wilaya_id.toString();
                     lastFetchTime = state.lastFetched.centers[specificCacheKey] || 0;
                     cachedData = state.cache.centers[specificCacheKey];
                     break;
                 default:
                     throw new Error(`Invalid Yalidine data type: ${type}`);
             }

             // Check cache
             if (cachedData && (now - lastFetchTime < CACHE_DURATION)) {
                  console.log(`Using cached data for ${type}` + (specificCacheKey ? ` (${specificCacheKey})` : ''));
                  // لا نحتاج لفلترة المراكز هنا إذا طلبناها مباشرة بـ has_stop_desk=true
                 return cachedData;
             }

              console.log(`Fetching fresh data for ${type}` + (specificCacheKey ? ` (${specificCacheKey})` : ''));

             // Fetch fresh data
             try {
                 const data = await apiFetch(endpoint, { params: params });

                  // Update cache and last fetched time
                  if (specificCacheKey) {
                      state.cache[type][specificCacheKey] = data;
                      state.lastFetched[type][specificCacheKey] = now;
                  } else {
                      state.cache[type] = data;
                      state.lastFetched[type] = now;
                  }
                   // Persist cache
                  if (type === 'wilayas') localDb.set('yalidine_wilayas_cache', state.cache.wilayas);
                  else if (type === 'communes') localDb.set('yalidine_communes_cache', state.cache.communes);
                  else if (type === 'fees') localDb.set('yalidine_fees_cache', state.cache.fees);
                  else if (type === 'centers') localDb.set('yalidine_centers_cache', state.cache.centers);

                  return data;


             } catch (error) {
                 console.error(`Failed to fetch Yalidine ${type}:`, error);
                 // Return old cached data if fetch fails, but log error
                  if (cachedData) {
                      console.warn(`Returning stale cached data for ${type}` + (specificCacheKey ? ` (${specificCacheKey})` : ''));
                      return cachedData;
                  }
                 throw error; // Re-throw if no cache available
             }
        };

        // تهيئة واجهة المستخدم والراوتر (تُستدعى بعد نجاح تسجيل الدخول في Firebase)
        const initializeAppUI = () => {
            // إضافة مستمعين للأحداث العامة التي تحتاج للتشغيل مرة واحدة
            window.addEventListener('hashchange', router);
            document.addEventListener('DOMContentLoaded', router); // استدعاء الراوتر عند تحميل DOM

            // مستمع عام للأحداث (Event Delegation)
            document.body.addEventListener('click', (e) => {
                // لإغلاق المودال
                if (e.target.id === 'modal-backdrop' || e.target.closest('.modal-close-btn')) {
                    hideModal();
                }
            });

             // مستمع زر تسجيل الخروج
             const logoutBtn = document.getElementById('admin-logout-btn');
             if (logoutBtn) {
                  // إزالة المستمع القديم إن وجد
                  const newLogoutBtn = logoutBtn.cloneNode(true);
                  logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);
                  newLogoutBtn.addEventListener('click', handleAdminLogout);
             }


            // تحديث عدد السلة عند التحميل
            updateCartBadge();

            // تنفيذ الراوتر لأول مرة بعد تهيئة UI الأساسية
            if (!state.appReady) {
                 // قد لا تكون البيانات جاهزة بعد، اعرض loader عام أو انتظر
                 console.log("Initial data not ready yet, delaying first route...");
                 // يمكن عرض loader رئيسي هنا إذا أردت
            } else {
                 router();
            }
        };

        // ==========================================
        // منطق الأدمن (Admin Logic) - مع Firebase
        // ==========================================

        // 1. تسجيل دخول الأدمن
        const handleAdminLogin = (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('isAdmin', 'true');
                if(errorEl) errorEl.classList.add('hidden');
                goTo('#/admin/dashboard');
            } else {
                 if(errorEl) {
                      errorEl.textContent = 'كلمة المرور غير صحيحة.';
                      errorEl.classList.remove('hidden');
                 }
            }
        };

        // 2. تسجيل خروج الأدمن
        const handleAdminLogout = (e) => {
            e.preventDefault();
            sessionStorage.removeItem('isAdmin');
            goTo('#/'); // سيعيد الراوتر تحديث الهيدر تلقائياً
        };

        // 3. عرض صفحة إعدادات ياليدين (لم تعد مستخدمة للمفاتيح)
        const renderSettingsPage = () => {
             // يمكن عرض رسالة هنا بدلاً من الفورم
        };

        // 4. حفظ إعدادات ياليدين (لم تعد مستخدمة للمفاتيح)
        const handleYalidineSettingsSubmit = (e) => {
             e.preventDefault();
             // لم يعد هناك شيء للحفظ هنا بخصوص المفاتيح
             showToast('تم نقل إعدادات API إلى Netlify.', 'info');
        };

         // دالة لمسح كاش ياليدين
         const clearYalidineCache = () => {
             state.lastFetched = { wilayas: 0, communes: {}, fees: {}, centers: {} };
             state.cache = { wilayas: null, communes: {}, fees: {}, centers: {} };
             localStorage.removeItem('yalidine_wilayas_cache');
             localStorage.removeItem('yalidine_communes_cache');
             localStorage.removeItem('yalidine_fees_cache');
             localStorage.removeItem('yalidine_centers_cache');
             console.log("Yalidine cache cleared.");
         };

        // 5. عرض قائمة منتجات الأدمن (تقرأ من state.products المحدثة من Firestore)
        const renderAdminProductList = () => {
            const listEl = document.getElementById('admin-product-list');
            if (!listEl) return;

             // إزالة المستمعين القدامى
             const newListEl = listEl.cloneNode(false); // Clone without children
             listEl.parentNode.replaceChild(newListEl, listEl);


            if (state.products.length === 0) {
                newListEl.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-500">لا توجد منتجات. <a href="#/admin/products/new" class="text-blue-600 font-medium hover:underline">أضف منتجاً جديداً</a></td></tr>`;
                return;
            }

            newListEl.innerHTML = state.products.map(product => {
                const defaultVariant = product.variants?.find(v => v.is_default) || product.variants?.[0] || { price: 0, stock_quantity: 0 };
                const totalStock = product.variants?.reduce((acc, v) => acc + (v.stock_quantity || 0), 0) ?? 0;
                 // تعديل للحصول على الصورة الأولى بشكل آمن
                 const firstGeneralImage = product.generalImages?.[0]?.url;
                 const firstVariantImage = Object.values(product.variantImages || {})?.[0]?.[0]?.url;
                 const displayImage = firstGeneralImage || firstVariantImage || 'https://placehold.co/48x48/e2e8f0/a0aec0?text=??';


                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-12 w-12">
                                    <img class="h-12 w-12 rounded-md object-cover border" src="${displayImage}" alt="${product.title || 'منتج'}">
                                </div>
                                <div class="mr-4">
                                    <div class="text-sm font-medium text-gray-900">${product.title}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${defaultVariant.price?.toLocaleString('fr-DZ')} د.ج</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${totalStock > 0 ? 'text-green-600' : 'text-red-600'} font-medium">${totalStock} في المخزون</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-left" dir="ltr">
                            <a href="#/admin/products/edit/${product.id}" class="text-blue-600 hover:text-blue-900 transition-colors">تعديل</a>
                            <button data-delete-product-id="${product.id}" class="text-red-600 hover:text-red-900 ml-3 transition-colors">حذف</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // إضافة مستمعين للحذف
            newListEl.querySelectorAll('[data-delete-product-id]').forEach(btn => {
                btn.addEventListener('click', async (e) => { // Async for Firestore delete
                    e.preventDefault();
                    const idToDelete = e.currentTarget.dataset.deleteProductId;
                    const productTitle = state.products.find(p => p.id == idToDelete)?.title || 'المنتج المحدد';
                    showModal(`
                        <div class="p-4 text-center">
                             <i data-lucide="alert-triangle" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                             <h3 class="text-lg font-semibold mb-2">تأكيد الحذف</h3>
                             <p class="text-gray-600 mb-6">هل أنت متأكد من حذف المنتج "${productTitle}"؟ لا يمكن التراجع عن هذا الإجراء.</p>
                             <div class="flex justify-center space-x-4 space-x-reverse">
                                 <button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-5 rounded-md font-medium hover:bg-red-700 transition-colors">
                                     نعم، حذف
                                 </button>
                                 <button class="modal-close-btn bg-gray-200 text-gray-800 py-2 px-5 rounded-md font-medium hover:bg-gray-300 transition-colors">
                                     إلغاء
                                 </button>
                             </div>
                         </div>
                    `);
                    document.getElementById('confirm-delete-btn').onclick = async () => {
                         hideModal();
                         showToast('جاري حذف المنتج...', 'info', 2000);
                         try {
                              const productRef = doc(db, 'products', idToDelete);
                              await deleteDoc(productRef);
                              showToast('تم حذف المنتج بنجاح.', 'success');
                              // لا تحتاج لاستدعاء renderAdminProductList() هنا
                              // onSnapshot سيقوم بتحديث الواجهة تلقائياً
                         } catch (error) {
                              console.error("Error deleting product:", error);
                              showToast('فشل حذف المنتج.', 'error');
                         }
                    };
                });
            });
             if (typeof lucide !== 'undefined') { // Render icons in the list
                 lucide.createIcons();
             }
        };

        // 6. عرض قائمة طلبات الأدمن (تقرأ من state.orders المحدثة من Firestore)
        const renderAdminOrderList = () => {
            const listEl = document.getElementById('admin-order-list');
             if (!listEl) return;

             // إزالة المستمعين القدامى
             const newListEl = listEl.cloneNode(false); // Clone without children
             listEl.parentNode.replaceChild(newListEl, listEl);

            const sortedOrders = [...state.orders].sort((a, b) => {
                 // Sort by creation time (assuming timestamp field exists)
                 const timeA = a.createdAt?.seconds || 0;
                 const timeB = b.createdAt?.seconds || 0;
                 return timeB - timeA; // Newest first
            });

            if (sortedOrders.length === 0) {
                newListEl.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">لا توجد طلبات لعرضها.</td></tr>`;
                return;
            }

            newListEl.innerHTML = sortedOrders.map(order => {
                const statusInfo = getStatusBadge(order.status);
                // Format date safely
                 let orderDate = 'N/A';
                 if (order.createdAt && order.createdAt.seconds) {
                      try {
                          orderDate = new Date(order.createdAt.seconds * 1000).toLocaleDateString('ar-DZ', { day: 'numeric', month: 'short', year: 'numeric'});
                      } catch (e) { console.error("Error formatting date:", e); }
                 } else if (typeof order.createdAt === 'string') { // Handle ISO string from old localStorage data if needed
                      try {
                          orderDate = new Date(order.createdAt).toLocaleDateString('ar-DZ', { day: 'numeric', month: 'short', year: 'numeric'});
                      } catch(e) { /* ignore */ }
                 }

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">#${order.id.slice(-6)}</td> <!-- Show partial ID -->
                        <td class="px-6 py-4 whitespace-nowrap">
                             <div class="text-sm font-medium text-gray-900">${order.name}</div>
                             <div class="text-sm text-gray-500">${order.phone}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-semibold">${order.grand_total?.toLocaleString('fr-DZ')} د.ج</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm"><span class="${statusInfo.class} inline-block">${statusInfo.text}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${orderDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-left" dir="ltr">
                             <a href="#/admin/orders/${order.id}" class="text-blue-600 hover:text-blue-900 transition-colors inline-flex items-center space-x-1">
                                 <i data-lucide="eye" class="w-4 h-4"></i>
                                 <span>عرض</span>
                             </a>
                        </td>
                    </tr>
                `;
            }).join('');
            if (typeof lucide !== 'undefined') { // Render icons
                lucide.createIcons();
            }
        };

        // 7. عرض تفاصيل الطلب للأدمن (تقرأ من state.orders)
        const renderOrderDetailPage = (orderId) => {
            const pageEl = document.getElementById('page-admin-order-detail');
            if (!pageEl) return;

            const order = state.orders.find(o => o.id == orderId);

            if (!order) {
                pageEl.innerHTML = `<div class="bg-white p-6 rounded-lg shadow text-center"><h1 class="text-2xl font-bold text-red-600 mb-4">لم يتم العثور على الطلب.</h1><a href="#/admin/orders" class="text-blue-600 hover:underline">&larr; العودة لقائمة الطلبات</a></div>`;
                return;
            }

            const statusInfo = getStatusBadge(order.status);
            const subTotal = order.cart?.reduce((acc, item) => acc + (item.price * item.quantity), 0) ?? 0;
            const orderDate = order.createdAt?.seconds ? new Date(order.createdAt.seconds * 1000).toLocaleString('ar-DZ', { dateStyle: 'full', timeStyle: 'short' }) : 'N/A';

            pageEl.innerHTML = `
                <div class="flex justify-between items-center mb-6 pb-4 border-b">
                    <h1 class="text-2xl lg:text-3xl font-bold text-gray-900">تفاصيل الطلب #${order.id.slice(-6)}</h1>
                    <a href="#/admin/orders" class="text-blue-600 hover:text-blue-800 flex items-center space-x-2 space-x-reverse transition-colors">
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        <span>العودة للطلبات</span>
                    </a>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- العمود الأيمن (الرئيسي) -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                                <h3 class="text-lg font-semibold text-gray-800">المنتجات المطلوبة</h3>
                                <span class="${statusInfo.class} inline-block">${statusInfo.text}</span>
                            </div>
                            <div class="space-y-4">
                                ${order.cart?.map(item => `
                                    <div class="flex items-center space-x-4 space-x-reverse">
                                        <img src="${item.image_url || 'https://placehold.co/64x80'}" alt="${item.title}" class="w-16 h-20 rounded-md object-cover border flex-shrink-0">
                                        <div class="flex-1 min-w-0">
                                            <p class="font-semibold text-gray-900 truncate">${item.title}</p>
                                            <p class="text-sm text-gray-500 truncate">${item.optionsText}</p>
                                            <p class="text-sm text-gray-500">الكمية: ${item.quantity}</p>
                                        </div>
                                        <div class="text-left flex-shrink-0" dir="ltr">
                                            <p class="font-semibold text-gray-900">${(item.price * item.quantity).toLocaleString('fr-DZ')} د.ج</p>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-gray-500">لا توجد منتجات في هذا الطلب.</p>'}
                            </div>
                            <!-- ملخص السعر -->
                            <div class="mt-6 pt-6 border-t border-gray-200 text-sm" dir="ltr">
                                <div class="flex justify-between text-gray-600">
                                    <span>Subtotal</span>
                                    <span>${subTotal.toLocaleString('fr-DZ')} DZD</span>
                                </div>
                                <div class="flex justify-between text-gray-600 mt-2">
                                    <span>Shipping</span>
                                    <span>${order.shipping_cost?.toLocaleString('fr-DZ')} DZD</span>
                                </div>
                                <div class="flex justify-between text-base font-bold text-gray-900 mt-4 pt-4 border-t border-gray-300">
                                    <span>Total</span>
                                    <span>${order.grand_total?.toLocaleString('fr-DZ')} DZD</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- العمود الأيسر (الجانبي) -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4 pb-4 border-b text-gray-800">معلومات العميل</h3>
                            <div class="space-y-2 text-sm text-gray-700">
                                <p><strong>الاسم:</strong> ${order.name}</p>
                                <p><strong>الهاتف:</strong> <a href="tel:${order.phone}" class="text-blue-600 hover:underline">${order.phone}</a></p>
                                <p><strong>الولاية:</strong> ${order.wilaya}</p>
                                <p><strong>البلدية/المكتب:</strong> ${order.commune}</p>
                                <p><strong>العنوان/الملاحظة:</strong> ${order.address}</p>
                                <p><strong>نوع التوصيل:</strong> ${order.delivery_type === 'home' ? 'للمنزل' : 'مكتب Yalidine'}</p>
                                <p><strong>تاريخ الطلب:</strong> ${orderDate}</p>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4 pb-4 border-b text-gray-800">إجراءات الطلب</h3>
                            <div id="order-actions" class="space-y-3">
                                <!-- سيتم ملء الأزرار هنا -->
                                 <div class="loader mx-auto"></div>
                            </div>
                        </div>

                         <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                             <h3 class="text-lg font-semibold mb-4 pb-4 border-b text-gray-800">تتبع الشحن (محاكاة)</h3>
                             <div id="yalidine-tracking-info" class="space-y-3 text-sm">
                                 <!-- سيتم ملء معلومات الشحن هنا -->
                                  <p class="text-gray-500">جاري تحميل المعلومات...</p>
                             </div>
                         </div>
                    </div>
                </div>
            `;

            renderOrderActions(order); // استدعاء لعرض الأزرار
            if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
            }
        };

        // 8. عرض أزرار إجراءات الطلب (كما هي تقريباً، ستستدعي handleUpdateOrderStatus)
        const renderOrderActions = (order) => {
             const container = document.getElementById('order-actions');
             const trackingContainer = document.getElementById('yalidine-tracking-info');
             if (!container || !trackingContainer) return;

             let buttons = '';
             let trackingInfo = `<p class="text-gray-500">لم يتم شحن الطلب بعد.</p>`;

             // بناء الأزرار بناءً على الحالة
             if (order.status === 'pending') {
                 buttons = `
                     <button data-action="confirmed" class="w-full bg-green-600 text-white py-2 px-4 rounded-md font-medium hover:bg-green-700 flex items-center justify-center space-x-2 space-x-reverse transition-colors">
                         <i data-lucide="check" class="w-4 h-4"></i> <span>تأكيد الطلب</span>
                     </button>
                     <button data-action="cancelled" class="w-full bg-red-600 text-white py-2 px-4 rounded-md font-medium hover:bg-red-700 flex items-center justify-center space-x-2 space-x-reverse transition-colors">
                         <i data-lucide="x" class="w-4 h-4"></i> <span>إلغاء الطلب</span>
                     </button>
                 `;
             } else if (order.status === 'confirmed') {
                 buttons = `
                     <button data-action="shipped" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-medium hover:bg-blue-700 flex items-center justify-center space-x-2 space-x-reverse transition-colors">
                         <i data-lucide="truck" class="w-4 h-4"></i> <span>تم الشحن (إنشاء تتبع وهمي)</span>
                     </button>
                      <p class="text-xs text-center text-gray-500 mt-2">سيؤدي هذا إلى إنشاء رقم تتبع وهمي.</p>
                     <button data-action="cancelled" class="w-full bg-red-600 text-white py-2 px-4 rounded-md font-medium hover:bg-red-700 flex items-center justify-center space-x-2 space-x-reverse transition-colors mt-2">
                         <i data-lucide="x" class="w-4 h-4"></i> <span>إلغاء الطلب</span>
                     </button>
                 `;
             } else if (order.status === 'shipped') {
                 buttons = `
                     <button data-action="delivered" class="w-full bg-green-600 text-white py-2 px-4 rounded-md font-medium hover:bg-green-700 flex items-center justify-center space-x-2 space-x-reverse transition-colors">
                         <i data-lucide="check-check" class="w-4 h-4"></i> <span>تم التسليم</span>
                     </button>
                     <button data-action="returned" class="w-full bg-yellow-600 text-gray-800 py-2 px-4 rounded-md font-medium hover:bg-yellow-500 flex items-center justify-center space-x-2 space-x-reverse transition-colors mt-2">
                         <i data-lucide="rotate-ccw" class="w-4 h-4"></i> <span>إرجاع الطلب</span>
                     </button>
                 `;
                  if(order.yalidine_tracking_id) {
                      trackingInfo = `
                          <p><strong>رقم التتبع:</strong></p>
                          <p class="text-base font-bold text-blue-700 mb-2">${order.yalidine_tracking_id}</p>
                          <p class="text-xs text-gray-500">(هذا رقم تتبع وهمي للمحاكاة)</p>
                      `;
                  }
             } else if (order.status === 'delivered') {
                 buttons = `<p class="text-center font-medium text-green-600 py-2 px-4 bg-green-100 rounded-md">✅ تم تسليم هذا الطلب.</p>`;
                  if(order.yalidine_tracking_id) trackingInfo = `<p><strong>رقم التتبع:</strong> ${order.yalidine_tracking_id}</p><p class="text-green-600 font-medium">تم التسليم</p>`;
             } else if (order.status === 'cancelled') {
                 buttons = `<p class="text-center font-medium text-red-600 py-2 px-4 bg-red-100 rounded-md">❌ تم إلغاء هذا الطلب.</p>`;
                 trackingInfo = `<p class="text-red-600 font-medium">ملغي</p>`
             } else if (order.status === 'returned') {
                 buttons = `<p class="text-center font-medium text-yellow-700 py-2 px-4 bg-yellow-100 rounded-md">↩️ تم إرجاع هذا الطلب.</p>`;
                  if(order.yalidine_tracking_id) trackingInfo = `<p><strong>رقم التتبع:</strong> ${order.yalidine_tracking_id}</p><p class="text-yellow-700 font-medium">تم الإرجاع</p>`;
             }

             container.innerHTML = buttons;
             trackingContainer.innerHTML = trackingInfo;
             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             }

             // إضافة مستمعين للأزرار
             container.querySelectorAll('button[data-action]').forEach(btn => {
                  // إزالة المستمعين القدامى المحتملين
                  const newBtn = btn.cloneNode(true);
                  btn.parentNode.replaceChild(newBtn, btn);

                 newBtn.addEventListener('click', () => {
                     const newStatus = newBtn.dataset.action;
                     let confirmMsg = `هل أنت متأكد من تغيير حالة الطلب إلى "${getStatusBadge(newStatus).text}"؟`;
                     if (newStatus === 'cancelled' || newStatus === 'returned') {
                         confirmMsg += "\nسيتم محاولة استعادة المخزون للمنتجات في هذا الطلب.";
                     }

                     showModal(`
                         <div class="p-4 text-center">
                             <i data-lucide="help-circle" class="w-16 h-16 text-blue-500 mx-auto mb-4"></i>
                             <h3 class="text-lg font-semibold mb-2">تأكيد الإجراء</h3>
                             <p class="text-gray-600 mb-6 whitespace-pre-line">${confirmMsg}</p> <!-- Added whitespace-pre-line -->
                             <div class="flex justify-center space-x-4 space-x-reverse">
                                 <button id="confirm-action-btn" class="bg-blue-600 text-white py-2 px-5 rounded-md font-medium hover:bg-blue-700 transition-colors">
                                     نعم، تغيير الحالة
                                 </button>
                                 <button class="modal-close-btn bg-gray-200 text-gray-800 py-2 px-5 rounded-md font-medium hover:bg-gray-300 transition-colors">
                                     إلغاء
                                 </button>
                             </div>
                         </div>
                     `);
                     document.getElementById('confirm-action-btn').onclick = () => {
                          hideModal();
                          handleUpdateOrderStatus(order.id, newStatus); // استدعاء دالة التحديث
                     };
                 });
             });
        };

        // 9. تحديث حالة الطلب (مع منطق استعادة المخزون) - باستخدام Firebase
        const handleUpdateOrderStatus = async (orderId, newStatus) => {
             const orderRef = doc(db, 'orders', orderId);
             showToast('جاري تحديث حالة الطلب...', 'info', 2000);

             try {
                 await runTransaction(db, async (transaction) => {
                     const orderSnap = await transaction.get(orderRef);
                     if (!orderSnap.exists()) {
                         throw "لم يتم العثور على الطلب!";
                     }

                     const orderData = orderSnap.data();
                     const originalStatus = orderData.status;

                     if (originalStatus === newStatus) return; // لا تغيير

                     const shouldRestoreStock = (newStatus === 'cancelled' || newStatus === 'returned');
                     const wasStockRemoved = (originalStatus !== 'cancelled' && originalStatus !== 'returned' && originalStatus !== 'pending');
                     let trackingId = orderData.yalidine_tracking_id; // Keep existing tracking ID

                      // Generate fake tracking ID if moving to shipped
                      if (newStatus === 'shipped' && !trackingId) {
                           trackingId = `YAL-${Date.now().toString().slice(-7)}`;
                      }

                     // منطق تحديث المخزون
                     if (shouldRestoreStock && wasStockRemoved) {
                         // استعادة المخزون
                         for (const item of orderData.cart) {
                             const productRef = doc(db, 'products', item.product_id);
                             const productSnap = await transaction.get(productRef);
                             if (productSnap.exists()) {
                                  const productData = productSnap.data();
                                  const variantIndex = productData.variants.findIndex(v => v.id == item.variant_id);
                                  if (variantIndex > -1) {
                                       productData.variants[variantIndex].stock_quantity += item.quantity;
                                       transaction.update(productRef, { variants: productData.variants });
                                  } else { console.warn(`Variant ${item.variant_id} not found in product ${item.product_id} for stock restore.`); }
                             } else { console.warn(`Product ${item.product_id} not found for stock restore.`); }
                         }
                         console.log("Stock restored for order:", orderId);
                     } else if (!shouldRestoreStock && !wasStockRemoved && (newStatus === 'confirmed' || newStatus === 'shipped')) {
                         // إزالة المخزون (يجب أن يكون قد تم إزالته عند إنشاء الطلب الآن)
                         // يمكن إضافة تحقق إضافي هنا إذا أردت، لكننا سنفترض أنه تم بالفعل
                         console.log("Stock assumed to be already reduced for order:", orderId);
                     }

                     // تحديث حالة الطلب ورقم التتبع إن وجد
                     transaction.update(orderRef, {
                          status: newStatus,
                          yalidine_tracking_id: trackingId // Update tracking ID if generated
                     });
                 });

                 showToast(`تم تحديث حالة الطلب إلى: ${getStatusBadge(newStatus).text}`, 'success');
                  // onSnapshot سيهتم بإعادة العرض
                 // renderOrderDetailPage(orderId); // No longer needed
             } catch (error) {
                 console.error("Error updating order status:", error);
                 showToast(`فشل تحديث حالة الطلب: ${error}`, 'error');
             }
        };


        // 10. عرض شارة الحالة (Badge) - كما هي
        const getStatusBadge = (status) => {
            const statuses = {
                 pending: { class: 'px-3 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800 border border-yellow-300', text: 'قيد الانتظار' },
                 confirmed: { class: 'px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800 border border-blue-300', text: 'مؤكد' },
                 shipped: { class: 'px-3 py-1 text-xs font-medium rounded-full bg-indigo-100 text-indigo-800 border border-indigo-300', text: 'تم الشحن' },
                 delivered: { class: 'px-3 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800 border border-green-300', text: 'تم التسليم' },
                 cancelled: { class: 'px-3 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800 border border-red-300', text: 'ملغي' },
                 returned: { class: 'px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800 border border-gray-300', text: 'مرتجع' }
            };
            return statuses[status] || { class: 'px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800 border border-gray-300', text: status };
        };


        // ==========================================
        // منطق إضافة/تعديل منتج (Product Form Logic) - مع Firebase
        // ==========================================

        let currentProductId = null; // لتحديد ما إذا كنا نضيف أو نعدل
        let currentGeneralImages = []; // { id: '...', url: 'base64...' }
        let currentColorSpecificData = {}; // { "#ffffff": { images: [], sizes: [] } }
        let currentSelectedColors = []; // [ { name: "White", hex: "#ffffff" } ]

        const PREDEFINED_COLORS = [
             { name: "White", hex: "#FFFFFF" }, { name: "Black", hex: "#000000" }, { name: "Red", hex: "#FF0000" },
             { name: "Green", hex: "#008000" }, { name: "Blue", hex: "#0000FF" }, { name: "Yellow", hex: "#FFFF00" },
             { name: "Purple", hex: "#800080" }, { name: "Pink", hex: "#FFC0CB" }, { name: "Orange", hex: "#FFA500" },
             { name: "Brown", hex: "#A52A2A" }, { name: "Gray", hex: "#808080" }, { name: "Beige", hex: "#F5F5DC" },
             // يمكنك إضافة المزيد
         ];
        const SIZES = ['STANDARD', 'S', 'M', 'L', 'XL', 'XXL', 'XXXL']; // المقاسات المتاحة

        // 1. عرض صفحة الفورم (إضافة أو تعديل) - تحتاج لجلب المنتج إذا كان تعديل
        const renderProductForm = async (productIdOrNull = null) => {
            const pageEl = document.getElementById('page-admin-product-form');
             if (!pageEl) return;
             pageEl.innerHTML = '<div class="flex justify-center items-center h-64"><div class="loader"></div></div>'; // Loader

            let productToEdit = null;
            currentProductId = productIdOrNull; // Set current ID for saving later

            // إعادة تعيين الحالة المؤقتة
            currentGeneralImages = [];
            currentColorSpecificData = {};
            currentSelectedColors = [];

            if (currentProductId) {
                 // وضع التعديل - جلب المنتج من Firestore
                 try {
                     const productRef = doc(db, 'products', currentProductId);
                     const productSnap = await getDoc(productRef);
                     if (productSnap.exists()) {
                         productToEdit = { ...productSnap.data(), id: productSnap.id };
                     } else {
                         showToast('لم يتم العثور على المنتج المطلوب للتعديل.', 'error');
                         goTo('#/admin/products');
                         return;
                     }
                 } catch (error) {
                     console.error("Error fetching product to edit:", error);
                     showToast('خطأ في تحميل بيانات المنتج.', 'error');
                     goTo('#/admin/products');
                     return;
                 }
            }

             // --- بناء HTML للفورم (الكود الطويل هنا) ---
             // هذا الجزء كبير جداً، سأستخدم الكود الأصلي مع تعديلات طفيفة جداً
             pageEl.innerHTML = `
                 <form id="product-form" class="space-y-6">
                      <div class="flex justify-between items-center mb-6 pb-4 border-b">
                           <h1 id="product-form-title" class="text-2xl lg:text-3xl font-bold text-gray-900">${productToEdit ? 'تعديل المنتج' : 'إضافة منتج جديد'}</h1>
                           <div>
                                <a href="#/admin/products" class="text-gray-600 hover:text-gray-900 mr-4 transition-colors">إلغاء</a>
                                <button type="submit" id="save-product-btn" class="bg-blue-600 text-white py-2 px-5 rounded-md font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-600 transition-colors inline-flex items-center justify-center">
                                     <span class="btn-text">حفظ المنتج</span>
                                     <div class="loader btn-loader hidden ml-2" style="width: 20px; height:20px; border-width: 3px;"></div>
                                </button>
                           </div>
                      </div>

                      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                           <!-- العمود الأيمن (الرئيسي) -->
                           <div class="lg:col-span-2 space-y-6">
                               <!-- معلومات المنتج الأساسية -->
                               <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                                   <h3 class="text-lg font-semibold mb-4 text-gray-800">المعلومات الأساسية</h3>
                                    <div class="mb-4">
                                        <label for="product-title" class="block text-sm font-medium text-gray-700 mb-1">عنوان المنتج <span class="text-red-600">*</span></label>
                                        <input type="text" id="product-title" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                                    </div>
                                    <div>
                                        <label for="product-description" class="block text-sm font-medium text-gray-700 mb-1">الوصف</label>
                                        <textarea id="product-description" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                                    </div>
                               </div>

                               <!-- الصور العامة -->
                               <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                                   <h3 class="text-lg font-semibold mb-3 text-gray-800">الصور العامة</h3>
                                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-3 mb-3 rounded-r-md text-sm" role="alert">
                                         <strong>ملاحظة:</strong> يتم حفظ الصور كبيانات Base64 مباشرة. هذا قد يؤدي إلى بطء وبلوغ حدود حجم المستند في Firestore مع الوقت. الحل الأمثل هو استخدام Firebase Storage (غير مطبق حالياً).
                                    </div>
                                   <div id="general-image-dropzone" class="border-2 border-dashed border-gray-300 rounded-md p-6 text-center hover:border-blue-500 transition-colors">
                                       <label for="general-image-upload" class="cursor-pointer">
                                           <i data-lucide="upload-cloud" class="w-10 h-10 text-gray-400 mx-auto mb-2"></i>
                                           <span class="text-blue-600 font-medium">اختر صورًا</span>
                                           <p class="text-xs text-gray-500 mt-1">أو اسحبها وأفلتها هنا (حد أقصى 5MB للصورة)</p>
                                           <input type="file" id="general-image-upload" multiple class="hidden" accept="image/*">
                                       </label>
                                   </div>
                                   <div id="general-image-preview" class="mt-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                                       <!-- سيتم عرض الصور هنا -->
                                   </div>
                               </div>

                               <!-- الخيارات (الألوان والمقاسات) -->
                               <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                                   <h3 class="text-lg font-semibold mb-4 text-gray-800">الخيارات (Variants)</h3>
                                   <!-- اختيار الألوان -->
                                   <div class="mb-5">
                                       <label class="block text-sm font-medium text-gray-700 mb-2">الألوان المتاحة</label>
                                       <div id="color-picker-container" class="flex flex-wrap gap-3 items-center">
                                           <!-- سيتم ملء الألوان هنا -->
                                       </div>
                                       <div class="mt-3">
                                           <label for="custom-color-input" class="inline-flex items-center space-x-2 space-x-reverse text-sm text-gray-600 cursor-pointer hover:text-blue-600">
                                                <input type="color" id="custom-color-input" class="w-7 h-7 border-none p-0 cursor-pointer rounded-full shadow" title="اختر لون مخصص">
                                                <span>إضافة لون مخصص</span>
                                           </label>
                                       </div>
                                   </div>

                                   <!-- حاوية إدارة المتغيرات حسب اللون -->
                                   <div id="color-variant-managers" class="space-y-5 mt-6 pt-5 border-t border-gray-200">
                                       <!-- سيتم ملء مدير كل لون هنا -->
                                   </div>
                               </div>
                           </div>

                           <!-- العمود الأيسر (الجانبي) -->
                           <div class="lg:col-span-1 space-y-6">
                               <!-- التسعير والمخزون -->
                               <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                                   <h3 class="text-lg font-semibold mb-4 text-gray-800">التسعير والمخزون</h3>
                                   <!-- جدول المتغيرات (يظهر عند اختيار ألوان) -->
                                   <div id="variants-table-container" class="hidden">
                                       <p class="text-xs text-gray-500 mb-3">أدخل سعر وكمية كل متغير متاح.</p>
                                       <div class="overflow-x-auto max-h-96">
                                           <table class="min-w-full text-sm border-collapse border border-gray-200">
                                               <thead class="bg-gray-100 sticky top-0">
                                                   <tr>
                                                       <th class="p-2 text-right border border-gray-200">المتغير</th>
                                                       <th class="p-2 text-right border border-gray-200">السعر (دج) <span class="text-red-600">*</span></th>
                                                       <th class="p-2 text-right border border-gray-200">المخزون <span class="text-red-600">*</span></th>
                                                   </tr>
                                               </thead>
                                               <tbody id="variants-table-body" class="divide-y divide-gray-200">
                                                   <!-- سيتم ملء الصفوف هنا -->
                                                   <tr><td colspan="3" class="p-3 text-center text-gray-500 text-xs">اختر الألوان والمقاسات أولاً.</td></tr>
                                               </tbody>
                                           </table>
                                       </div>
                                   </div>
                                   <!-- تسعير المنتج البسيط (يظهر إن لم يكن هناك ألوان) -->
                                   <div id="simple-pricing-container" class="space-y-4">
                                        <div>
                                            <label for="simple-price" class="block text-sm font-medium text-gray-700 mb-1">سعر البيع (دج) <span class="text-red-600">*</span></label>
                                            <input type="number" id="simple-price" step="0.01" min="0" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label for="simple-stock" class="block text-sm font-medium text-gray-700 mb-1">الكمية في المخزون <span class="text-red-600">*</span></label>
                                            <input type="number" id="simple-stock" min="0" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        </div>
                                   </div>
                               </div>
                           </div>
                      </div>
                 </form>
             `;

             // --- ملء الفورم بالبيانات (إذا كان وضع التعديل) ---
             const titleInput = document.getElementById('product-title');
             const descInput = document.getElementById('product-description');
             if (productToEdit) {
                  titleInput.value = productToEdit.title || '';
                  descInput.value = productToEdit.description || '';
                  currentGeneralImages = [...(productToEdit.generalImages || [])];
                  currentColorSpecificData = JSON.parse(JSON.stringify(productToEdit.variantSpecificData || {}));
                  currentSelectedColors = [...(productToEdit.product_options?.find(opt => opt.name === 'Couleur')?.values.map(v => ({name: v.value, hex: v.hex_code})) || [])];
             }

             // إعادة عرض المكونات الفرعية للفورم بالبيانات الحالية
             renderImagePreview('#general-image-preview', currentGeneralImages, 'general');
             renderColorPicker();
             renderColorVariantManagers(); // سيعرض المديرين بناءً على currentSelectedColors
             updatePricingUI(); // سيعرض جدول المتغيرات أو التسعير البسيط ويملاْ القيم

             // --- إعادة ربط المستمعين للفورم الجديد ---
             const newForm = document.getElementById('product-form');
             newForm?.addEventListener('submit', handleProductFormSubmit);
             document.getElementById('general-image-upload')?.addEventListener('change', (e) => handleImageUpload(e, 'general'));
             document.getElementById('custom-color-input')?.addEventListener('change', handleAddCustomColor);

             // إعادة رسم الأيقونات
             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             }
        };

        // 2. عرض منتقي الألوان - كما هي تقريباً
        const renderColorPicker = () => {
             const container = document.getElementById('color-picker-container');
             if (!container) return;
             const selectedHex = new Set(currentSelectedColors.map(c => c.hex));

             container.innerHTML = PREDEFINED_COLORS.map(color => `
                 <button type="button" class="color-swatch ${selectedHex.has(color.hex) ? 'selected' : ''}" style="background-color: ${color.hex};" data-color-hex="${color.hex}" data-color-name="${color.name}" title="${color.name}">
                     ${selectedHex.has(color.hex) ? `<i data-lucide="check" class="w-4 h-4 pointer-events-none" style="color: ${['#FFFFFF', '#FFFF00'].includes(color.hex) ? '#000' : '#FFF'};"></i>` : ''}
                 </button>
             `).join('');

             // إضافة الألوان المخصصة التي تم اختيارها (إن وجدت)
             currentSelectedColors.filter(c => !PREDEFINED_COLORS.find(p => p.hex === c.hex)).forEach(color => {
                 container.innerHTML += `
                     <button type="button" class="color-swatch selected" style="background-color: ${color.hex};" data-color-hex="${color.hex}" data-color-name="${color.name}" title="${color.name}">
                         <i data-lucide="check" class="w-4 h-4 pointer-events-none" style="color: ${calculateContrastColor(color.hex)};"></i>
                     </button>
                 `;
             });

             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             }

             // إضافة مستمعين للألوان
             container.querySelectorAll('.color-swatch').forEach(swatch => {
                 swatch.addEventListener('click', (e) => {
                     e.preventDefault();
                     const hex = e.currentTarget.dataset.colorHex;
                     const name = e.currentTarget.dataset.colorName;
                     toggleColor({ name, hex });
                 });
             });
        };

        // دالة لحساب لون التباين - كما هي
        const calculateContrastColor = (hex) => {
             if (!hex || hex.length < 7) return '#ffffff'; // Added length check
             try {
                  const r = parseInt(hex.slice(1, 3), 16);
                  const g = parseInt(hex.slice(3, 5), 16);
                  const b = parseInt(hex.slice(5, 7), 16);
                  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                  return luminance > 0.5 ? '#000000' : '#ffffff';
             } catch (e) {
                  console.error("Error calculating contrast color for:", hex, e);
                  return '#ffffff';
             }
        };

        // 3. إضافة لون مخصص - كما هي
        const handleAddCustomColor = (e) => {
             const hex = e.target.value.toUpperCase(); // Ensure uppercase hex
             const name = `لون مخصص ${hex}`;
             const exists = currentSelectedColors.some(c => c.hex === hex) || PREDEFINED_COLORS.some(c => c.hex === hex);
             if (!exists) {
                 toggleColor({ name, hex });
             } else {
                 showToast('هذا اللون موجود بالفعل.', 'info');
             }
        };

        // 4. تبديل (إضافة/إزالة) لون - كما هي تقريباً
        const toggleColor = (color) => {
             const index = currentSelectedColors.findIndex(c => c.hex === color.hex);
             if (index > -1) {
                 // تأكيد الإزالة
                 showModal(`
                     <div class="p-4 text-center">
                          <i data-lucide="alert-triangle" class="w-16 h-16 text-yellow-500 mx-auto mb-4"></i>
                          <h3 class="text-lg font-semibold mb-2">تأكيد الإزالة</h3>
                          <p class="text-gray-600 mb-6">هل أنت متأكد من إزالة اللون "${color.name}" وكل بياناته (الصور والمقاسات)؟</p>
                          <div class="flex justify-center space-x-4 space-x-reverse">
                              <button id="confirm-remove-color" class="bg-red-600 text-white py-2 px-5 rounded-md font-medium hover:bg-red-700 transition-colors">
                                  نعم، إزالة
                              </button>
                              <button class="modal-close-btn bg-gray-200 text-gray-800 py-2 px-5 rounded-md font-medium hover:bg-gray-300 transition-colors">
                                  إلغاء
                              </button>
                          </div>
                      </div>
                 `);
                  document.getElementById('confirm-remove-color').onclick = () => {
                      currentSelectedColors.splice(index, 1);
                      delete currentColorSpecificData[color.hex];
                      hideModal();
                      refreshProductFormUI(); // تحديث كامل لواجهة الفورم
                  };
             } else {
                 // إضافة اللون
                 currentSelectedColors.push(color);
                 if (!currentColorSpecificData[color.hex]) {
                     currentColorSpecificData[color.hex] = { images: [], sizes: [] };
                 }
                 refreshProductFormUI(); // تحديث كامل لواجهة الفورم
             }
        };

        // دالة لتحديث واجهة الفورم بالكامل - كما هي
        const refreshProductFormUI = () => {
             renderColorPicker();
             renderColorVariantManagers();
             updatePricingUI();
        };

        // 5. عرض مديري المتغيرات (الصور والمقاسات لكل لون) - كما هي تقريباً
        const renderColorVariantManagers = () => {
             const container = document.getElementById('color-variant-managers');
              if (!container) return;

             if (currentSelectedColors.length === 0) {
                 container.innerHTML = '<p class="text-sm text-center text-gray-500 py-4">اختر لونًا أولاً لإدارة صوره ومقاساته.</p>';
                 return;
             }

             // الحفاظ على قيم الأسعار والمخزون المؤقتة
             const tempVariantData = {};
             document.querySelectorAll('#variants-table-body tr[data-variant-key]').forEach(row => {
                 const key = row.dataset.variantKey;
                 tempVariantData[key] = {
                     price: row.querySelector('[data-variant-input="price"]')?.value, // Added safe navigation
                     stock: row.querySelector('[data-variant-input="stock"]')?.value // Added safe navigation
                 };
             });


             container.innerHTML = currentSelectedColors.map(color => {
                 const data = currentColorSpecificData[color.hex] || { images: [], sizes: [] };
                 return `
                     <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
                         <div class="flex justify-between items-center p-3 bg-gray-50 border-b border-gray-200" style="border-right: 4px solid ${color.hex};">
                             <h4 class="font-semibold text-gray-700">متغيرات اللون: ${color.name} (${color.hex})</h4>
                             <button type="button" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100" data-remove-color="${color.hex}" title="إزالة هذا اللون وكل بياناته">
                                 <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                             </button>
                         </div>
                         <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                             <!-- قسم الصور للون -->
                             <div>
                                 <h5 class="text-sm font-medium text-gray-700 mb-2">صور هذا اللون</h5>
                                 <label class="border-2 border-dashed border-gray-300 rounded-md p-4 text-center block cursor-pointer text-blue-600 hover:border-blue-500 hover:bg-blue-50 transition-colors text-sm">
                                      <i data-lucide="image-plus" class="w-6 h-6 mx-auto mb-1 text-gray-400"></i>
                                     + إضافة صور
                                     <input type="file" class="hidden" multiple accept="image/*" data-color-hex-upload="${color.hex}">
                                 </label>
                                 <div class="mt-4 grid grid-cols-3 gap-3" data-image-preview-for="${color.hex}">
                                     ${data.images.map((img, index) => `
                                         <div class="relative group image-preview-item">
                                             <img src="${img.url}" class="w-full h-24 object-cover rounded-md border border-gray-200">
                                             <button type="button" class="remove-image-btn" data-remove-image="${color.hex}" data-image-id="${img.id}">
                                                 <i data-lucide="x" class="w-4 h-4 pointer-events-none"></i>
                                             </button>
                                         </div>
                                     `).join('')}
                                      ${data.images.length === 0 ? '<p class="col-span-3 text-xs text-center text-gray-400">لم يتم إضافة صور لهذا اللون.</p>' : ''}
                                 </div>
                             </div>
                             <!-- قسم المقاسات للون -->
                             <div>
                                 <h5 class="text-sm font-medium text-gray-700 mb-2">المقاسات المتاحة لهذا اللون</h5>
                                 <div class="flex flex-wrap gap-2">
                                     ${SIZES.map(size => `
                                         <button type="button" class="size-tag ${data.sizes?.includes(size) ? 'selected' : ''}" data-size="${size}" data-color-hex-size="${color.hex}">
                                             ${size}
                                         </button>
                                     `).join('')}
                                 </div>
                                  ${SIZES.length === 0 ? '<p class="text-xs text-gray-400 mt-2">لا توجد مقاسات محددة.</p>' : ''}
                             </div>
                         </div>
                     </div>
                 `;
             }).join('');

             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             }

             // إعادة ربط المستمعين
             container.querySelectorAll('[data-remove-color]').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.preventDefault();
                     const hex = e.currentTarget.dataset.removeColor;
                     const color = currentSelectedColors.find(c => c.hex === hex);
                     if (color) toggleColor(color); // toggleColor now handles confirmation
                 });
             });

             container.querySelectorAll('[data-color-hex-upload]').forEach(input => {
                 input.addEventListener('change', (e) => handleImageUpload(e, e.currentTarget.dataset.colorHexUpload));
             });

             container.querySelectorAll('[data-remove-image]').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.preventDefault();
                     const hex = e.currentTarget.dataset.removeImage;
                     const imgId = e.currentTarget.dataset.imageId;
                      if(currentColorSpecificData[hex]) {
                          currentColorSpecificData[hex].images = currentColorSpecificData[hex].images.filter(img => img.id != imgId);
                           // إعادة عرض مدير هذا اللون فقط
                           renderSingleColorVariantManager(hex);
                      }
                 });
             });

             container.querySelectorAll('[data-color-hex-size]').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.preventDefault();
                     const hex = e.currentTarget.dataset.colorHexSize;
                     const size = e.currentTarget.dataset.size;
                      if(currentColorSpecificData[hex]) {
                          const sizes = currentColorSpecificData[hex].sizes || [];
                          const sizeIndex = sizes.indexOf(size);
                          if (sizeIndex > -1) {
                              sizes.splice(sizeIndex, 1); // Remove size
                          } else {
                              sizes.push(size); // Add size
                              sizes.sort((a, b) => SIZES.indexOf(a) - SIZES.indexOf(b)); // Keep order consistent
                          }
                          currentColorSpecificData[hex].sizes = sizes;
                          e.currentTarget.classList.toggle('selected');
                          updateVariantsTable(tempVariantData); // تحديث جدول الأسعار مع الحفاظ على القيم
                      }
                 });
             });
              // استعادة قيم الأسعار والمخزون بعد إعادة العرض
             updateVariantsTable(tempVariantData);
        };

        // دالة لإعادة عرض مدير متغيرات لون واحد - كما هي تقريباً
        const renderSingleColorVariantManager = (hex) => {
             const managerDiv = document.querySelector(`[style*="border-right: 4px solid ${hex}"]`)?.closest('.border.border-gray-200');
              if (!managerDiv) return;

             const color = currentSelectedColors.find(c => c.hex === hex);
             if (!color) return; // Should not happen if div exists

             const data = currentColorSpecificData[color.hex] || { images: [], sizes: [] };

             // إعادة بناء محتوى الصور والمقاسات فقط لهذا اللون
             const imagePreviewContainer = managerDiv.querySelector(`[data-image-preview-for="${hex}"]`);
             const sizeContainer = managerDiv.querySelector(`[data-color-hex-size="${hex}"]`)?.parentElement; // Get the flex container

             if (imagePreviewContainer) {
                 imagePreviewContainer.innerHTML = data.images.map((img, index) => `
                     <div class="relative group image-preview-item">
                         <img src="${img.url}" class="w-full h-24 object-cover rounded-md border border-gray-200">
                         <button type="button" class="remove-image-btn" data-remove-image="${color.hex}" data-image-id="${img.id}">
                             <i data-lucide="x" class="w-4 h-4 pointer-events-none"></i>
                         </button>
                     </div>
                 `).join('') + (data.images.length === 0 ? '<p class="col-span-3 text-xs text-center text-gray-400">لم يتم إضافة صور لهذا اللون.</p>' : '');

                  // Re-attach listeners for remove buttons within this specific preview
                  imagePreviewContainer.querySelectorAll('[data-remove-image]').forEach(btn => {
                      btn.addEventListener('click', (e) => {
                          e.preventDefault();
                          const currentHex = e.currentTarget.dataset.removeImage;
                          const imgId = e.currentTarget.dataset.imageId;
                          if(currentColorSpecificData[currentHex]) {
                              currentColorSpecificData[currentHex].images = currentColorSpecificData[currentHex].images.filter(img => img.id != imgId);
                              renderSingleColorVariantManager(currentHex); // Re-render this section again
                          }
                      });
                  });
             }

             if (sizeContainer) {
                  sizeContainer.innerHTML = SIZES.map(size => `
                      <button type="button" class="size-tag ${data.sizes?.includes(size) ? 'selected' : ''}" data-size="${size}" data-color-hex-size="${color.hex}">
                          ${size}
                      </button>
                  `).join('');
                  // Re-attach listeners for size buttons within this specific container
                  sizeContainer.querySelectorAll('[data-color-hex-size]').forEach(btn => {
                      btn.addEventListener('click', (e) => {
                           e.preventDefault();
                           const currentHex = e.currentTarget.dataset.colorHexSize;
                           const currentSize = e.currentTarget.dataset.size;
                            if(currentColorSpecificData[currentHex]) {
                                const sizes = currentColorSpecificData[currentHex].sizes || [];
                                const sizeIndex = sizes.indexOf(currentSize);
                                if (sizeIndex > -1) sizes.splice(sizeIndex, 1);
                                else {
                                     sizes.push(currentSize);
                                     sizes.sort((a, b) => SIZES.indexOf(a) - SIZES.indexOf(b));
                                }
                                currentColorSpecificData[currentHex].sizes = sizes;
                                e.currentTarget.classList.toggle('selected');

                                // Preserve existing table data before updating
                                const tempVariantData = {};
                                 document.querySelectorAll('#variants-table-body tr[data-variant-key]').forEach(row => {
                                     const key = row.dataset.variantKey;
                                     tempVariantData[key] = {
                                         price: row.querySelector('[data-variant-input="price"]')?.value,
                                         stock: row.querySelector('[data-variant-input="stock"]')?.value
                                     };
                                 });
                                updateVariantsTable(tempVariantData);
                            }
                      });
                  });
             }
              if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
              }
        };

        // 6. معالجة رفع الصور - كما هي
        const handleImageUpload = (event, type) => {
            const files = event.target.files;
            if (!files) return;

            const MAX_SIZE = 5 * 1024 * 1024; // 5MB limit per image

            for (const file of files) {
                 if (file.size > MAX_SIZE) {
                     showToast(`حجم الصورة ${file.name} يتجاوز الحد المسموح (5MB).`, 'error');
                     continue; // Skip this file
                 }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const url = e.target.result; // Base64 Data URL
                    const id = Date.now() + '-' + Math.random().toString(36).substring(2, 9); // Unique ID
                    const image = { id, url };

                    if (type === 'general') {
                        currentGeneralImages.push(image);
                        renderImagePreview('#general-image-preview', currentGeneralImages, 'general');
                    } else { // type is hex
                        if(currentColorSpecificData[type]) {
                            currentColorSpecificData[type].images.push(image);
                             renderSingleColorVariantManager(type); // Update specific color manager
                        }
                    }
                };
                 reader.onerror = (error) => {
                     console.error("FileReader error: ", error);
                     showToast(`حدث خطأ أثناء قراءة الملف ${file.name}.`, 'error');
                 };
                reader.readAsDataURL(file);
            }

            // Reset input field
            event.target.value = null;
        };

        // 7. عرض الصور المصغرة - كما هي
        const renderImagePreview = (containerSelector, images, type) => {
             const container = document.querySelector(containerSelector);
             if (!container) return;

             container.innerHTML = images.map(img => `
                 <div class="relative group image-preview-item">
                     <img src="${img.url}" class="w-full h-24 object-cover rounded-md border border-gray-200">
                     <button type="button" class="remove-image-btn" data-remove-image-id="${img.id}" data-type="${type}" title="إزالة الصورة">
                         <i data-lucide="x" class="w-4 h-4 pointer-events-none"></i>
                     </button>
                 </div>
             `).join('');
             // Message if list is empty
              if (images.length === 0 && type === 'general') {
                  container.innerHTML = '<p class="col-span-full text-xs text-center text-gray-400 py-4">لم يتم إضافة صور عامة.</p>';
              } else if (images.length === 0) {
                  // Message for color manager is in renderSingleColorVariantManager
              }


             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             }

             // Re-attach delete listeners for this container only
             container.querySelectorAll('[data-remove-image-id]').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.preventDefault();
                     const id = e.currentTarget.dataset.removeImageId;
                     const imgType = e.currentTarget.dataset.type;

                     if (imgType === 'general') {
                         currentGeneralImages = currentGeneralImages.filter(img => img.id != id);
                         renderImagePreview('#general-image-preview', currentGeneralImages, 'general'); // Re-render only general previews
                     } else { // imgType is hex
                          if(currentColorSpecificData[imgType]) {
                              currentColorSpecificData[imgType].images = currentColorSpecificData[imgType].images.filter(img => img.id != id);
                               renderSingleColorVariantManager(imgType); // Re-render specific color manager
                          }
                     }
                 });
             });
        };

        // 8. تحديث واجهة التسعير - مع ملء القيم عند التعديل
        const updatePricingUI = () => {
            const hasVariants = currentSelectedColors.length > 0;
            const tableContainer = document.getElementById('variants-table-container');
            const simpleContainer = document.getElementById('simple-pricing-container');

             if (!tableContainer || !simpleContainer) return;

             tableContainer.classList.toggle('hidden', !hasVariants);
             simpleContainer.classList.toggle('hidden', hasVariants);

            let tempVariantData = {}; // To store values to fill table/simple fields

             // If editing, try to get existing values from product data
             if (currentProductId) {
                  const product = state.products.find(p => p.id == currentProductId);
                  if (product && product.variants) {
                       if (product.variants.length === 1 && product.variants[0].is_default && !hasVariants) {
                            // Simple product being edited
                            tempVariantData['simple'] = {
                                 price: product.variants[0].price || '',
                                 stock: product.variants[0].stock_quantity || ''
                            };
                       } else {
                            // Product with variants being edited
                            product.variants.forEach(variant => {
                                 const colorName = variant.options?.Couleur;
                                 const sizeName = variant.options?.Taille;
                                 const color = product.product_options?.find(opt => opt.name === 'Couleur')
                                                            ?.values.find(v => v.value === colorName);
                                 if (color) {
                                      const key = `${color.hex_code}|${sizeName || ''}`;
                                      tempVariantData[key] = {
                                           price: variant.price || '',
                                           stock: variant.stock_quantity ?? '' // Use ?? for 0 stock
                                      };
                                 }
                            });
                       }
                  }
             }


            if (hasVariants) {
                 // Preserve currently entered table data if it exists (overrides fetched data)
                 document.querySelectorAll('#variants-table-body tr[data-variant-key]').forEach(row => {
                      const key = row.dataset.variantKey;
                      const currentPrice = row.querySelector('[data-variant-input="price"]')?.value;
                      const currentStock = row.querySelector('[data-variant-input="stock"]')?.value;
                      if (currentPrice || currentStock) { // Only override if user entered something
                           tempVariantData[key] = { price: currentPrice, stock: currentStock };
                      }
                 });
                 updateVariantsTable(tempVariantData);
            } else {
                 // Fill simple fields if editing simple or just cleared variants
                 document.getElementById('simple-price').value = tempVariantData['simple']?.price || '';
                 document.getElementById('simple-stock').value = tempVariantData['simple']?.stock || '';
            }
        };


        // 9. تحديث جدول الأسعار والمخزون - كما هي تقريباً
        const updateVariantsTable = (previousData = {}) => {
             const tableBody = document.getElementById('variants-table-body');
             if (!tableBody) return;

             const generatedVariants = [];
             let showSizeColumn = false;

             currentSelectedColors.forEach(color => {
                 const sizes = currentColorSpecificData[color.hex]?.sizes || [];
                 if (sizes.length > 0) {
                     showSizeColumn = true;
                     sizes.forEach(size => {
                         generatedVariants.push({
                             key: `${color.hex}|${size}`,
                             colorName: color.name,
                             sizeName: size,
                             options: { Couleur: color.name, Taille: size }
                         });
                     });
                 } else {
                     // Color without specific sizes (e.g., STANDARD or only color option)
                     generatedVariants.push({
                         key: `${color.hex}|`, // Empty size part in key
                         colorName: color.name,
                         sizeName: null, // No size name
                         options: { Couleur: color.name }
                     });
                      // Check if ANY color has sizes to determine if size column is needed
                      if (Object.values(currentColorSpecificData).some(data => data.sizes && data.sizes.length > 0)) {
                           showSizeColumn = true;
                      }
                 }
             });

              // Sort variants for consistent order (by color name, then size)
              generatedVariants.sort((a, b) => {
                   if (a.colorName < b.colorName) return -1;
                   if (a.colorName > b.colorName) return 1;
                   // If colors are the same, sort by size index
                   const sizeAIndex = a.sizeName ? SIZES.indexOf(a.sizeName) : -1;
                   const sizeBIndex = b.sizeName ? SIZES.indexOf(b.sizeName) : -1;
                   return sizeAIndex - sizeBIndex;
              });


             // Update table headers
             const thead = tableBody.closest('table')?.querySelector('thead tr');
             if(thead) {
                 const oldSizeTh = thead.querySelector('.size-column');
                 if(oldSizeTh) oldSizeTh.remove(); // Remove if exists

                 if(showSizeColumn) {
                      const sizeTh = document.createElement('th');
                      sizeTh.className = 'p-2 text-right border border-gray-200 size-column';
                      sizeTh.textContent = 'المقاس';
                      thead.children[0].insertAdjacentElement('afterend', sizeTh); // Insert after Color column
                 }
             }

             if (generatedVariants.length === 0) {
                 const colspan = showSizeColumn ? 4 : 3;
                 tableBody.innerHTML = `<tr><td colspan="${colspan}" class="p-3 text-center text-gray-500 text-xs">اختر لونًا على الأقل.</td></tr>`;
                 return;
             }

             tableBody.innerHTML = generatedVariants.map(variant => {
                 const prev = previousData[variant.key] || { price: '', stock: ''};
                 const rowContent = `
                      <td class="p-2 align-top border border-gray-200">${variant.colorName}</td>
                      ${showSizeColumn ? `<td class="p-2 align-top border border-gray-200">${variant.sizeName || '-'}</td>` : ''}
                      <td class="p-2 align-top border border-gray-200">
                          <input type="number" data-variant-input="price" value="${prev.price}" class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:border-blue-500 focus:ring-blue-500" placeholder="0.00" required step="0.01" min="0">
                      </td>
                      <td class="p-2 align-top border border-gray-200">
                          <input type="number" data-variant-input="stock" value="${prev.stock}" class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:border-blue-500 focus:ring-blue-500" placeholder="0" required min="0" step="1">
                      </td>
                 `;
                  return `<tr data-variant-key="${variant.key}">${rowContent}</tr>`;
             }).join('');
        };

        // 10. حفظ المنتج (Submit - إضافة وتعديل) - باستخدام Firebase
        const handleProductFormSubmit = async (e) => {
             e.preventDefault();
             const saveBtn = document.getElementById('save-product-btn');
             const btnText = saveBtn?.querySelector('.btn-text');
             const btnLoader = saveBtn?.querySelector('.btn-loader');

             // Disable button and show loader
             if(saveBtn) saveBtn.disabled = true;
             if(btnText) btnText.classList.add('hidden');
             if(btnLoader) btnLoader.classList.remove('hidden');

             const titleInput = document.getElementById('product-title');
             const descriptionInput = document.getElementById('product-description');

             if (!titleInput.value.trim()) {
                 showToast('عنوان المنتج مطلوب!', 'error');
                 titleInput.focus();
                 if(saveBtn) saveBtn.disabled = false;
                 if(btnText) btnText.classList.remove('hidden');
                 if(btnLoader) btnLoader.classList.add('hidden');
                 return;
             }

             const hasVariants = currentSelectedColors.length > 0;
             const productData = {
                 // ID سيتم إنشاؤه بواسطة Firestore عند الإضافة، أو استخدام currentProductId للتحديث
                 title: titleInput.value.trim(),
                 description: descriptionInput.value.trim(),
                 generalImages: currentGeneralImages, // Array of { id, url: base64 }
                 variantImages: {}, // Object: { "#hex": [ { id, url: base64 } ] }
                 variantSpecificData: JSON.parse(JSON.stringify(currentColorSpecificData)), // Store sizes linked to colors
                 product_options: [],
                 variants: [],
                  createdAt: serverTimestamp(), // Add server timestamp
                  updatedAt: serverTimestamp()
             };

             if (hasVariants) {
                 // --- Build options ---
                 productData.product_options.push({
                     name: 'Couleur',
                     values: currentSelectedColors.map(c => ({ value: c.name, hex_code: c.hex }))
                 });
                 const allSizes = [...new Set(Object.values(currentColorSpecificData).flatMap(d => d.sizes || []))];
                  if (allSizes.length > 0) {
                     allSizes.sort((a, b) => SIZES.indexOf(a) - SIZES.indexOf(b)); // Sort sizes
                     productData.product_options.push({
                         name: 'Taille',
                         values: allSizes.map(s => ({ value: s }))
                     });
                 }

                 // --- Build variants ---
                 const variantRows = document.querySelectorAll('#variants-table-body tr[data-variant-key]');
                 if (variantRows.length === 0 && currentSelectedColors.length > 0) {
                     showToast('يرجى تحديد تفاصيل (سعر ومخزون) للمتغيرات المتاحة.', 'error');
                     if(saveBtn) saveBtn.disabled = false;
                     if(btnText) btnText.classList.remove('hidden');
                     if(btnLoader) btnLoader.classList.add('hidden');
                     return;
                 }

                 for (const row of variantRows) {
                     const key = row.dataset.variantKey;
                     const priceInput = row.querySelector('[data-variant-input="price"]');
                     const stockInput = row.querySelector('[data-variant-input="stock"]');
                     const price = parseFloat(priceInput.value);
                     const stock = parseInt(stockInput.value);
                     const variantLabel = row.querySelector('td:first-child')?.textContent || `متغير ${key}`;

                     if (!priceInput.value || isNaN(price) || price < 0) {
                         showToast(`الرجاء إدخال سعر صحيح للمتغير ${variantLabel}`, 'error'); priceInput.focus();
                         if(saveBtn) saveBtn.disabled = false;
                         if(btnText) btnText.classList.remove('hidden');
                         if(btnLoader) btnLoader.classList.add('hidden');
                         return;
                     }
                      if (stockInput.value === '' || isNaN(stock) || stock < 0) { // Allow 0 stock, check for empty string
                         showToast(`الرجاء إدخال مخزون صحيح (0 أو أكثر) للمتغير ${variantLabel}`, 'error'); stockInput.focus();
                         if(saveBtn) saveBtn.disabled = false;
                         if(btnText) btnText.classList.remove('hidden');
                         if(btnLoader) btnLoader.classList.add('hidden');
                         return;
                     }

                     const [hex, size] = key.split('|');
                     const colorName = currentSelectedColors.find(c => c.hex === hex)?.name;
                     const options = {};
                     if (colorName) options.Couleur = colorName;
                     if (size) options.Taille = size;

                     productData.variants.push({
                         id: 'v-' + (currentProductId || 'new') + '-' + key.replace('|','-'), // Generate consistent variant ID
                         options: options,
                         price: price,
                         purchase_price: 0, // Placeholder
                         stock_quantity: stock,
                         is_default: false
                     });
                 }
                  // --- Build variant images ---
                 for (const hex of Object.keys(currentColorSpecificData)) {
                      if (currentSelectedColors.some(c => c.hex === hex)) {
                         productData.variantImages[hex] = currentColorSpecificData[hex].images;
                      }
                 }

                 // Set default if only one variant exists
                 if (productData.variants.length === 1) {
                     productData.variants[0].is_default = true;
                 } else if (productData.variants.length > 1) {
                      // Optionally, set the first variant as default if none is explicitly marked
                      const hasDefault = productData.variants.some(v => v.is_default);
                      if (!hasDefault) {
                           productData.variants[0].is_default = true;
                      }
                 }


             } else {
                 // --- Simple product ---
                 const priceInput = document.getElementById('simple-price');
                 const stockInput = document.getElementById('simple-stock');
                 const price = parseFloat(priceInput.value);
                 const stock = parseInt(stockInput.value);

                  if (!priceInput.value || isNaN(price) || price < 0) {
                     showToast('الرجاء إدخال سعر صحيح للمنتج.', 'error'); priceInput.focus();
                     if(saveBtn) saveBtn.disabled = false;
                     if(btnText) btnText.classList.remove('hidden');
                     if(btnLoader) btnLoader.classList.add('hidden');
                     return;
                 }
                  if (stockInput.value === '' || isNaN(stock) || stock < 0) { // Allow 0 stock
                     showToast('الرجاء إدخال مخزون صحيح (0 أو أكثر) للمنتج.', 'error'); stockInput.focus();
                     if(saveBtn) saveBtn.disabled = false;
                     if(btnText) btnText.classList.remove('hidden');
                     if(btnLoader) btnLoader.classList.add('hidden');
                     return;
                 }

                 productData.variants.push({
                     id: 'v-' + (currentProductId || 'new') + '-default',
                     options: {},
                     price: price,
                     purchase_price: 0,
                     stock_quantity: stock,
                     is_default: true
                 });
                 productData.product_options = [];
                 productData.variantImages = {};
                 productData.variantSpecificData = {};
             }

             // --- Save product to Firestore ---
             try {
                  if (currentProductId) {
                       // Update existing product
                       const productRef = doc(db, 'products', currentProductId);
                       await setDoc(productRef, { ...productData, updatedAt: serverTimestamp() }, { merge: true }); // Use setDoc with merge to update or overwrite
                       showToast('تم تحديث المنتج بنجاح!', 'success');
                  } else {
                       // Add new product
                       const docRef = await addDoc(productsCollection, productData);
                       console.log("Product added with ID: ", docRef.id);
                       showToast('تم إضافة المنتج بنجاح!', 'success');
                  }
                  goTo('#/admin/products');
             } catch (error) {
                  console.error("Error saving product to Firestore:", error);
                  showToast('فشل حفظ المنتج. تحقق من اتصالك بالإنترنت.', 'error');
                  if(saveBtn) saveBtn.disabled = false;
                  if(btnText) btnText.classList.remove('hidden');
                  if(btnLoader) btnLoader.classList.add('hidden');
             }
        };

        // ==========================================
        // منطق العميل (Customer Logic) - يقرأ من state (Firestore)
        // ==========================================

        // 1. عرض صفحة المتجر الرئيسية (تقرأ من state.products)
        const renderShopPage = () => {
             const listEl = document.getElementById('product-list');
             const shopLoader = document.getElementById('shop-loader');
             const noProductsMsg = document.getElementById('no-products-message');
             if (!listEl || !shopLoader || !noProductsMsg) return;

             // إزالة المستمعين القدامى من الأزرار (إن وجدت)
             listEl.innerHTML = ''; // Clear previous content

             if (!state.appReady) { // إذا كانت البيانات لم تحمل بعد
                  shopLoader.classList.remove('hidden');
                  noProductsMsg.classList.add('hidden');
                  return;
             }

             shopLoader.classList.add('hidden');

             if (state.products.length === 0) {
                  noProductsMsg.innerHTML = `لا توجد منتجات لعرضها حالياً. ${isAdmin() ? '<a href="#/admin/products/new" class="text-blue-600 font-medium hover:underline">أضف منتجاً</a>' : ''}`;
                  noProductsMsg.classList.remove('hidden');
                 return;
             }

             noProductsMsg.classList.add('hidden'); // إخفاء رسالة عدم وجود منتجات

             state.products.forEach(product => {
                 const defaultVariant = product.variants?.find(v => v.is_default) || product.variants?.[0] || { price: 0 };
                  const firstGeneralImage = product.generalImages?.[0]?.url;
                  const firstVariantImage = Object.values(product.variantImages || {})?.[0]?.[0]?.url;
                  const displayImage = firstGeneralImage || firstVariantImage || 'https://placehold.co/400x400/f1f5f9/a3a3a3?text=No+Image';
                 const hasOptions = (product.product_options?.length || 0) > 0 || (product.variants?.length || 0) > 1;

                 const productCard = document.createElement('div');
                 productCard.className = "group bg-white rounded-lg shadow border border-gray-200 overflow-hidden flex flex-col transition-shadow hover:shadow-md";
                 productCard.innerHTML = `
                     <a href="#/product/${product.id}" class="block overflow-hidden product-card-image-container">
                          <img src="${displayImage}" alt="${product.title || 'منتج'}" loading="lazy">
                     </a>
                     <div class="p-4 flex flex-col flex-grow">
                          <h3 class="text-base font-semibold text-gray-800 truncate mb-1 flex-grow">
                               <a href="#/product/${product.id}" class="hover:text-blue-600 transition-colors">${product.title}</a>
                          </h3>
                          <p class="text-xl font-bold text-gray-900 mt-1 mb-3">${defaultVariant.price?.toLocaleString('fr-DZ')} د.ج</p>
                          <a href="#/product/${product.id}" class="block w-full mt-auto bg-gray-800 text-white text-center py-2 px-4 rounded-md font-medium text-sm hover:bg-gray-700 transition-colors">
                               ${hasOptions ? 'اختيار الخيارات' : 'عرض التفاصيل'}
                          </a>
                     </div>
                 `;
                 listEl.appendChild(productCard);
             });
              if (typeof lucide !== 'undefined') { // Render icons (if any were added)
                  lucide.createIcons();
              }
        };

        // 2. عرض صفحة تفاصيل المنتج (تجلب المنتج المحدد من state.products)
        const renderProductDetailPage = (productId) => {
            const pageEl = document.getElementById('page-product-detail');
            if (!pageEl) return;
             pageEl.innerHTML = '<div class="flex justify-center items-center h-64"><div class="loader"></div></div>'; // Show loader

            const product = state.products.find(p => p.id == productId);

            if (!state.appReady) { // إذا كانت المنتجات لم تحمل بعد
                 // يمكن إبقاء الـ Loader أو عرض رسالة "جاري التحميل"
                 return;
            }


            if (!product) {
                pageEl.innerHTML = `<div class="bg-white p-6 rounded-lg shadow text-center"><h1 class="text-2xl font-bold text-red-600 mb-4">لم يتم العثور على المنتج.</h1><a href="#/" class="text-blue-600 hover:underline">&larr; العودة للمتجر</a></div>`;
                return;
            }

            const colorOption = product.product_options?.find(opt => opt.name === 'Couleur');
            const sizeOption = product.product_options?.find(opt => opt.name === 'Taille');
            const hasOptions = colorOption || sizeOption || (product.variants?.length || 0) > 1;

            const initialColorHex = colorOption?.values[0]?.hex_code;
            const variantImages = product.variantImages || {}; // Ensure it's an object
            const generalImages = product.generalImages || []; // Ensure it's an array

            const initialImagesForThumbnails = (initialColorHex && variantImages[initialColorHex]?.length > 0)
                                          ? variantImages[initialColorHex]
                                          : generalImages;

             // Ensure initialImagesForThumbnails is always an array
             const safeInitialImages = Array.isArray(initialImagesForThumbnails) ? initialImagesForThumbnails : [];

             // Find initial main image: first image from the selected/first color, fallback to first general image
             let initialMainImage = 'https://placehold.co/600x600/f1f5f9/a3a3a3?text=No+Image';
             if (safeInitialImages.length > 0) {
                  initialMainImage = safeInitialImages[0].url;
             } else if (generalImages.length > 0) {
                  initialMainImage = generalImages[0].url; // Fallback to general if variant images were empty
             }


            const defaultVariant = product.variants?.find(v => v.is_default) || product.variants?.[0] || { price: 0, stock_quantity: 0 };

            pageEl.innerHTML = `
                <div class="bg-white p-6 md:p-8 rounded-lg shadow-md border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12">
                        <!-- قسم الصور -->
                        <div>
                            <div class="aspect-w-1 aspect-h-1 bg-gray-100 rounded-lg overflow-hidden mb-4 border border-gray-200">
                                <img id="main-product-image" src="${initialMainImage}" alt="${product.title}" class="w-full h-full object-cover duration-300 ease-in-out">
                            </div>
                            <!-- صور مصغرة -->
                            <div id="thumbnail-images" class="grid grid-cols-4 gap-2">
                                ${safeInitialImages.map((img, index) => `
                                    <button class="aspect-w-1 aspect-h-1 block rounded-md overflow-hidden border-2 ${index === 0 ? 'border-blue-500' : 'border-transparent'} hover:border-blue-400 focus:outline-none focus:border-blue-500 transition" data-img-url="${img.url}">
                                        <img src="${img.url}" alt="Thumbnail ${index+1}" class="w-full h-full object-cover" loading="lazy">
                                    </button>
                                `).join('')}
                                 <!-- Fallback to general images if variant images were empty initially -->
                                ${safeInitialImages.length === 0 && generalImages.length > 0 ? generalImages.map((img, index) => `
                                     <button class="aspect-w-1 aspect-h-1 block rounded-md overflow-hidden border-2 ${index === 0 ? 'border-blue-500' : 'border-transparent'} hover:border-blue-400 focus:outline-none focus:border-blue-500 transition" data-img-url="${img.url}">
                                         <img src="${img.url}" alt="Thumbnail ${index+1}" class="w-full h-full object-cover" loading="lazy">
                                     </button>
                                `).join('') : ''}
                                 ${safeInitialImages.length === 0 && generalImages.length === 0 ? '<p class="text-xs text-gray-400 col-span-4 text-center">لا توجد صور مصغرة</p>' : ''}
                            </div>
                        </div>

                        <!-- قسم التفاصيل -->
                        <div class="py-4">
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-900 mb-3">${product.title}</h1>
                            <p id="product-price" class="text-3xl font-bold text-gray-800 mb-6">${defaultVariant.price?.toLocaleString('fr-DZ')} د.ج</p>

                            <form id="add-to-cart-form" class="space-y-6">
                                <!-- خيارات الألوان -->
                                ${colorOption ? `
                                    <div>
                                        <h3 class="text-sm font-medium text-gray-900 mb-2">اللون: <span id="selected-color-name" class="font-normal text-gray-600">اختر لونًا</span></h3>
                                        <div id="product-color-options" class="flex flex-wrap gap-3">
                                            ${colorOption.values.map(val => `
                                                <button type="button" class="color-swatch" style="background-color: ${val.hex_code};" data-color-name="${val.value}" data-color-hex="${val.hex_code}" title="${val.value}"></button>
                                            `).join('')}
                                        </div>
                                        <input type="hidden" id="selected-color-hex" name="color_hex">
                                    </div>
                                ` : ''}

                                <!-- خيارات المقاسات -->
                                ${sizeOption ? `
                                    <div>
                                         <div class="flex justify-between items-center mb-2">
                                             <h3 class="text-sm font-medium text-gray-900">المقاس: <span id="selected-size-name" class="font-normal text-gray-600">اختر مقاسًا</span></h3>
                                         </div>
                                        <div id="product-size-options" class="flex flex-wrap gap-2">
                                            ${sizeOption.values.map(val => `
                                                <button type="button" class="size-tag" data-size-name="${val.value}" disabled>
                                                    ${val.value}
                                                </button>
                                            `).join('')}
                                        </div>
                                        <input type="hidden" id="selected-size" name="size">
                                    </div>
                                ` : ''}

                                <!-- زر الإضافة للسلة -->
                                <div class="pt-4">
                                    <p id="stock-message" class="text-sm text-red-600 mb-2 hidden">الرجاء اختيار الخيارات المتاحة.</p>
                                    <button type="submit" id="add-to-cart-btn" class="w-full bg-gray-900 text-white py-3 px-6 rounded-md font-medium text-lg hover:bg-gray-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 space-x-reverse" ${!hasOptions && (defaultVariant?.stock_quantity ?? 0) > 0 ? '' : 'disabled'}>
                                         <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                         <span>${hasOptions ? 'اختر الخيارات أولاً' : ((defaultVariant?.stock_quantity ?? 0) > 0 ? 'إضافة للسلة' : 'نفذ المخزون')}</span>
                                    </button>
                                </div>
                            </form>

                            <!-- الوصف -->
                            <div class="mt-8 pt-6 border-t border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900 mb-3">الوصف</h3>
                                <div class="text-gray-600 leading-relaxed whitespace-pre-wrap prose prose-sm max-w-none">${product.description || 'لا يوجد وصف لهذا المنتج.'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            setupVariantSelector(product); // تشغيل منطق اختيار الخيارات
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };


        // 3. منطق اختيار الخيارات في صفحة المنتج - كما هي تقريباً، تقرأ من product
        const setupVariantSelector = (product) => {
             const form = document.getElementById('add-to-cart-form');
             if (!form) return;

             const colorOption = product.product_options?.find(opt => opt.name === 'Couleur');
             const sizeOption = product.product_options?.find(opt => opt.name === 'Taille');
             const hasOptions = colorOption || sizeOption || (product.variants?.length || 0) > 1;

             const colorButtons = form.querySelectorAll('#product-color-options .color-swatch');
             const sizeButtons = form.querySelectorAll('#product-size-options .size-tag');
             const priceEl = document.getElementById('product-price');
             const stockMsg = document.getElementById('stock-message');
             const addBtn = document.getElementById('add-to-cart-btn');
             const addBtnText = addBtn?.querySelector('span'); // Safe navigation
             const mainImage = document.getElementById('main-product-image');
             const thumbnailContainer = document.getElementById('thumbnail-images');
             const selectedColorNameEl = document.getElementById('selected-color-name');
             const selectedSizeNameEl = document.getElementById('selected-size-name');


             let selectedColor = null; // { name, hex }
             let selectedSize = null; // { name }
              // Find initial default/first variant safely
              let selectedVariant = !hasOptions ? (product.variants?.[0] || null) : null;


             const updateUI = () => {
                 // 1. Find matching variant
                 selectedVariant = null;
                 if (!hasOptions && product.variants?.length > 0) {
                      selectedVariant = product.variants[0];
                 } else if (product.variants) { // Check if variants exist
                     selectedVariant = product.variants.find(v => {
                         const colorMatch = !colorOption || (selectedColor && v.options?.Couleur === selectedColor.name);
                         const sizeMatch = !sizeOption || (selectedSize && v.options?.Taille === selectedSize.name);
                         return colorMatch && sizeMatch;
                     });
                 }


                 // 2. Update price, stock, and button
                  const defaultOrFirstVariant = product.variants?.find(v => v.is_default) || product.variants?.[0];
                  const displayPrice = selectedVariant?.price ?? defaultOrFirstVariant?.price ?? 0;
                  if (priceEl) priceEl.textContent = `${displayPrice.toLocaleString('fr-DZ')} د.ج`;

                 let canAddToCart = false;
                 let stockMessageText = '';
                 let buttonText = 'إضافة للسلة';

                  if (hasOptions && (!selectedColor && colorOption || !selectedSize && sizeOption)) {
                      stockMessageText = 'الرجاء اختيار جميع الخيارات المتاحة.';
                      buttonText = 'اختر الخيارات';
                  } else if (selectedVariant) {
                      if (selectedVariant.stock_quantity > 0) {
                          stockMessageText = '';
                          canAddToCart = true;
                      } else {
                          stockMessageText = 'نفذ المخزون لهذا الخيار.';
                          buttonText = 'نفذ المخزون';
                      }
                  } else if (hasOptions) {
                      stockMessageText = 'هذا المزيج من الخيارات غير متوفر.';
                      buttonText = 'غير متوفر';
                  } else if (!selectedVariant && !hasOptions) { // Simple product out of stock (or no variants found)
                       const initialStock = defaultOrFirstVariant?.stock_quantity ?? 0;
                       if (initialStock <=0) {
                            stockMessageText = 'نفذ المخزون لهذا المنتج.';
                            buttonText = 'نفذ المخزون';
                       } else {
                            // Should not happen if product has a variant, maybe initial loading state?
                            stockMessageText = 'المنتج غير متوفر حالياً.';
                            buttonText = 'غير متوفر';
                       }
                  }


                 if (stockMsg) {
                     stockMsg.textContent = stockMessageText;
                     stockMsg.classList.toggle('hidden', !stockMessageText);
                 }
                  if (addBtn) addBtn.disabled = !canAddToCart;
                  if (addBtnText) addBtnText.textContent = buttonText;


                 // 3. Update images based on selected color
                  const variantImages = product.variantImages || {};
                  const generalImages = product.generalImages || [];
                  let imagesToShow = generalImages; // Default to general images
                 if (selectedColor && variantImages[selectedColor.hex]?.length > 0) {
                     imagesToShow = variantImages[selectedColor.hex];
                 }

                  // Ensure imagesToShow is an array
                  const safeImagesToShow = Array.isArray(imagesToShow) ? imagesToShow : generalImages;


                  if (thumbnailContainer) {
                      thumbnailContainer.innerHTML = safeImagesToShow.map((img, index) => `
                          <button class="aspect-w-1 aspect-h-1 block rounded-md overflow-hidden border-2 border-transparent hover:border-blue-400 focus:outline-none focus:border-blue-500 transition" data-img-url="${img.url}">
                              <img src="${img.url}" alt="Thumbnail ${index+1}" class="w-full h-full object-cover pointer-events-none" loading="lazy">
                          </button>
                      `).join('');

                      // Select first thumb
                      const firstThumb = thumbnailContainer.querySelector('button');
                      if (firstThumb) firstThumb.classList.add('border-blue-500');

                      // Add thumb listeners
                      thumbnailContainer.querySelectorAll('button').forEach(thumb => {
                          thumb.addEventListener('click', (e) => {
                              const newUrl = e.currentTarget.dataset.imgUrl;
                              if (mainImage) mainImage.src = newUrl;
                              thumbnailContainer.querySelectorAll('button').forEach(t => t.classList.remove('border-blue-500'));
                              e.currentTarget.classList.add('border-blue-500');
                          });
                      });
                  }

                  // Update main image
                  if (mainImage && safeImagesToShow.length > 0) {
                       // Only update if the current main image isn't already in the new set
                       const currentSrcBase = mainImage.src.split('?')[0]; // Ignore potential query strings
                       const newUrlsBases = safeImagesToShow.map(img => img.url.split('?')[0]);
                       if (!newUrlsBases.includes(currentSrcBase)) {
                            mainImage.src = safeImagesToShow[0].url;
                       }
                  } else if (mainImage && generalImages.length > 0) {
                      // Fallback to first general image if no variant images were found
                      if (!generalImages.map(img => img.url.split('?')[0]).includes(mainImage.src.split('?')[0])) {
                           mainImage.src = generalImages[0].url;
                      }
                  } else if (mainImage) {
                       mainImage.src = 'https://placehold.co/600x600/f1f5f9/a3a3a3?text=No+Image'; // Placeholder
                  }


             };

             // Color selection listener
             colorButtons.forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.preventDefault();
                     colorButtons.forEach(b => {
                          b.classList.remove('selected');
                          b.innerHTML = ''; // Remove checkmark
                     });
                     btn.classList.add('selected');
                      // Add checkmark with correct contrast
                      btn.innerHTML = `<i data-lucide="check" class="w-4 h-4 pointer-events-none" style="color: ${calculateContrastColor(btn.dataset.colorHex)};"></i>`;
                      if (typeof lucide !== 'undefined') { lucide.createIcons(); }

                     selectedColor = { name: btn.dataset.colorName, hex: btn.dataset.colorHex };
                     if (selectedColorNameEl) selectedColorNameEl.textContent = selectedColor.name;

                     // Update available sizes
                     if (sizeOption && product.variants) {
                         sizeButtons.forEach(sizeBtn => {
                             const sizeName = sizeBtn.dataset.sizeName;
                             const isAvailable = product.variants.some(v =>
                                 v.options?.Couleur === selectedColor.name &&
                                 v.options?.Taille === sizeName &&
                                 v.stock_quantity > 0
                             );
                             sizeBtn.disabled = !isAvailable;
                             if (selectedSize && selectedSize.name === sizeName && !isAvailable) {
                                 selectedSize = null;
                                 if (selectedSizeNameEl) selectedSizeNameEl.textContent = 'اختر مقاسًا';
                                 sizeBtn.classList.remove('selected');
                             } else if (selectedSize && selectedSize.name === sizeName && isAvailable) {
                                 sizeBtn.classList.add('selected'); // Keep selected if still available
                             } else {
                                  sizeBtn.classList.remove('selected'); // Deselect others
                             }
                         });
                          if (!selectedSize && selectedSizeNameEl) selectedSizeNameEl.textContent = 'اختر مقاسًا';
                     }
                     updateUI();
                 });
             });

             // Size selection listener
             sizeButtons.forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.preventDefault();
                     if (btn.disabled) return;
                     sizeButtons.forEach(b => b.classList.remove('selected'));
                     btn.classList.add('selected');
                     selectedSize = { name: btn.dataset.sizeName };
                     if (selectedSizeNameEl) selectedSizeNameEl.textContent = selectedSize.name;
                     updateUI();
                 });
             });

             // Add to cart listener
             form.addEventListener('submit', (e) => {
                 e.preventDefault();
                  // Final validation before adding
                 if (!hasOptions && product.variants?.length > 0) {
                     selectedVariant = product.variants[0];
                 } else {
                      if (colorOption && !selectedColor) { showToast('الرجاء اختيار اللون.', 'error'); return; }
                      if (sizeOption && !selectedSize) { showToast('الرجاء اختيار المقاس.', 'error'); return; }
                      // Variant should be selected by updateUI if choices are valid
                      if (!selectedVariant) { // Double check if a variant was actually found
                           showToast('هذا المزيج من الخيارات غير متوفر حالياً.', 'error');
                           return;
                      }
                 }

                 if (selectedVariant && selectedVariant.stock_quantity > 0) {
                     addItemToCart(product, selectedVariant, 1); // Uses localDb for cart
                 } else if (selectedVariant && selectedVariant.stock_quantity <= 0) {
                     showToast('نفذ المخزون لهذا الخيار.', 'error');
                 } else {
                      showToast('الرجاء اختيار خيارات صالحة.', 'error');
                 }
             });

             // Initial UI update and size availability check
             if (!colorOption && sizeOption && product.variants) {
                  sizeButtons.forEach(sizeBtn => {
                      const sizeName = sizeBtn.dataset.sizeName;
                      const isAvailable = product.variants.some(v => v.options?.Taille === sizeName && v.stock_quantity > 0);
                      sizeBtn.disabled = !isAvailable;
                  });
             }
             updateUI(); // Initial UI setup
        };


        // 4. إضافة منتج للسلة (يستخدم localDb) - تعديل بسيط لإيجاد الصورة
        const addItemToCart = (product, variant, quantity) => {
             if (!variant) { showToast('خطأ: المتغير المحدد غير صالح.', 'error'); return; }

             const stockToCheck = variant.stock_quantity ?? 0; // Handle undefined stock

             if (stockToCheck < quantity) {
                 showToast('الكمية المطلوبة غير متوفرة في المخزون!', 'error'); return;
             }

             const existingItemIndex = state.cart.findIndex(item => item.variant_id === variant.id);

             if (existingItemIndex > -1) {
                 const existingItem = state.cart[existingItemIndex];
                 const newQty = existingItem.quantity + quantity;
                 if (stockToCheck < newQty) {
                      showToast(`لا يمكنك إضافة المزيد، المخزون المتبقي لهذا الخيار هو ${stockToCheck - existingItem.quantity}.`, 'error'); return;
                 }
                 state.cart[existingItemIndex].quantity = newQty;
             } else {
                  // --- Find image ---
                  let imageUrl = 'https://placehold.co/100x120/f1f5f9/a3a3a3?text=No+Image'; // Placeholder
                  const variantImages = product.variantImages || {};
                  const generalImages = product.generalImages || [];
                  const colorHex = product.product_options?.find(opt => opt.name === 'Couleur')
                                               ?.values.find(v => v.value === variant.options?.Couleur)
                                               ?.hex_code;
                  if (colorHex && variantImages[colorHex]?.length > 0) {
                      imageUrl = variantImages[colorHex][0].url;
                  } else if (generalImages.length > 0) {
                      imageUrl = generalImages[0].url;
                  }

                 const optionsText = Object.entries(variant.options || {})
                                        .map(([key, value]) => value)
                                        .join(' / ');

                 state.cart.push({
                     cartId: variant.id + '-' + Date.now(),
                     variant_id: variant.id,
                     product_id: product.id,
                     title: product.title,
                     price: variant.price,
                     quantity: quantity,
                     image_url: imageUrl,
                     optionsText: optionsText,
                     stock: stockToCheck // Store current stock for checks in cart
                 });
             }

             localDb.set('cart', state.cart); // Save cart to localStorage
             updateCartBadge();
             showToast('تمت إضافة المنتج للسلة بنجاح!', 'success');
             if(window.location.hash === '#/cart') {
                 renderCartPage(); // Refresh cart page if currently viewing it
             }
        };

        // 5. تحديث أيقونة السلة (يقرأ من state.cart) - كما هي
        const updateCartBadge = () => {
             const badge = document.getElementById('cart-count-badge');
             if (!badge) return;
             const totalItems = state.cart.reduce((acc, item) => acc + item.quantity, 0);
             badge.textContent = totalItems > 9 ? '9+' : totalItems; // Limit display
             badge.classList.toggle('hidden', totalItems === 0);
        };

        // 6. عرض صفحة السلة (تقرأ من state.cart) - تعديل بسيط لعرض Loader
        const renderCartPage = () => {
             const pageEl = document.getElementById('page-cart');
             if (!pageEl) return;
             pageEl.innerHTML = ''; // Clear previous listeners and content

             if (state.cart.length === 0) {
                 pageEl.innerHTML = `
                     <div class="text-center bg-white p-10 rounded-lg shadow border border-gray-200">
                         <i data-lucide="shopping-cart" class="w-20 h-20 text-gray-300 mx-auto mb-4"></i>
                         <h2 class="text-2xl font-bold text-gray-800 mb-2">سلتك فارغة</h2>
                         <p class="text-gray-500 mb-6">لم تقم بإضافة أي منتجات بعد.</p>
                         <a href="#/" class="bg-gray-900 text-white py-2 px-6 rounded-md font-medium hover:bg-gray-800 transition-colors inline-block">
                             العودة للمتجر
                         </a>
                     </div>
                 `;
                 if (typeof lucide !== 'undefined') { lucide.createIcons(); }
                 return;
             }

             const subTotal = state.cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);

             pageEl.innerHTML = `
                 <h1 class="text-2xl lg:text-3xl font-bold text-gray-900 mb-6">سلة التسوق (${state.cart.reduce((acc, item) => acc + item.quantity, 0)} منتج)</h1>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                     <!-- قائمة المنتجات -->
                     <div class="lg:col-span-2 bg-white p-4 sm:p-6 rounded-lg shadow border border-gray-200 space-y-5 divide-y divide-gray-200">
                         ${state.cart.map(item => `
                             <div class="flex items-start sm:items-center pt-5 first:pt-0 flex-col sm:flex-row" data-cart-item-id="${item.cartId}">
                                 <img src="${item.image_url}" alt="${item.title}" class="w-24 h-28 sm:w-20 sm:h-24 object-cover rounded-md border flex-shrink-0 mb-3 sm:mb-0">
                                 <div class="flex-1 mx-0 sm:mx-4 w-full">
                                     <div class="flex justify-between items-start w-full">
                                          <div>
                                              <p class="font-semibold text-gray-900 text-base leading-tight">${item.title}</p>
                                              <p class="text-sm text-gray-500 mt-1">${item.optionsText}</p>
                                          </div>
                                          <p class="font-semibold text-gray-900 text-base sm:hidden">${(item.price * item.quantity).toLocaleString('fr-DZ')} د.ج</p>
                                     </div>
                                     <!-- أزرار الكمية -->
                                     <div class="flex items-center justify-between sm:justify-start space-x-2 space-x-reverse mt-2">
                                         <div class="inline-flex items-center border border-gray-300 rounded-md">
                                             <button data-action="decrease" class="p-1.5 text-gray-600 hover:bg-gray-100 rounded-r-md disabled:opacity-50 disabled:cursor-not-allowed" ${item.quantity <= 1 ? 'disabled' : ''}>
                                                  <i data-lucide="minus" class="w-4 h-4 pointer-events-none"></i>
                                             </button>
                                             <span class="font-medium w-10 text-center text-sm">${item.quantity}</span>
                                             <button data-action="increase" class="p-1.5 text-gray-600 hover:bg-gray-100 rounded-l-md disabled:opacity-50 disabled:cursor-not-allowed" ${item.quantity >= item.stock ? 'disabled' : ''}>
                                                  <i data-lucide="plus" class="w-4 h-4 pointer-events-none"></i>
                                             </button>
                                         </div>
                                         <button data-action="remove" class="text-xs text-red-600 hover:text-red-800 hover:underline sm:ml-4">
                                             إزالة
                                         </button>
                                     </div>
                                      ${item.quantity >= item.stock ? '<p class="text-xs text-red-500 mt-1">الكمية القصوى في المخزون</p>' : ''}
                                 </div>
                                 <div class="text-left flex-shrink-0 hidden sm:block" dir="ltr">
                                     <p class="font-semibold text-gray-900 text-base">${(item.price * item.quantity).toLocaleString('fr-DZ')} د.ج</p>
                                 </div>
                             </div>
                         `).join('')}
                     </div>

                     <!-- ملخص الطلب -->
                     <aside class="lg:col-span-1">
                         <div class="bg-white p-6 rounded-lg shadow border border-gray-200 sticky top-24">
                             <h3 class="text-xl font-semibold mb-4 pb-4 border-b text-gray-800">ملخص الطلب</h3>
                             <div class="space-y-3 text-sm mb-6" dir="ltr">
                                 <div class="flex justify-between">
                                     <span class="text-gray-600">Subtotal</span>
                                     <span class="font-medium text-gray-800">${subTotal.toLocaleString('fr-DZ')} DZD</span>
                                 </div>
                                 <div class="flex justify-between">
                                     <span class="text-gray-600">Shipping</span>
                                     <span class="font-medium text-gray-800">يُحسب عند الدفع</span>
                                 </div>
                                 <div class="flex justify-between text-lg font-bold text-gray-900 mt-4 pt-4 border-t border-gray-300">
                                     <span>Total (Est.)</span>
                                     <span>${subTotal.toLocaleString('fr-DZ')} DZD</span>
                                 </div>
                             </div>
                             <a href="#/checkout" class="block w-full text-center bg-gray-900 text-white py-3 px-6 rounded-md font-medium text-lg hover:bg-gray-800 transition-colors">
                                 المتابعة للدفع
                             </a>
                              <a href="#/" class="block text-center mt-4 text-sm text-blue-600 hover:underline">
                                 أو متابعة التسوق
                             </a>
                         </div>
                     </aside>
                 </div>
             `;

             if (typeof lucide !== 'undefined') { lucide.createIcons(); }

             // إضافة مستمعين لصفحة السلة
             pageEl.querySelectorAll('[data-cart-item-id]').forEach(itemEl => {
                 const cartId = itemEl.dataset.cartItemId;
                 itemEl.querySelector('[data-action="increase"]')?.addEventListener('click', () => updateCartQuantity(cartId, 1));
                 itemEl.querySelector('[data-action="decrease"]')?.addEventListener('click', () => updateCartQuantity(cartId, -1));
                 itemEl.querySelector('[data-action="remove"]')?.addEventListener('click', () => removeFromCart(cartId));
             });
        };

        // 7. تحديث الكمية في السلة (يستخدم localDb) - تعديل بسيط للتحقق من المخزون
        const updateCartQuantity = (cartId, change) => {
             const itemIndex = state.cart.findIndex(item => item.cartId === cartId);
             if (itemIndex === -1) return;

             const item = state.cart[itemIndex];
             const newQty = item.quantity + change;

             if (newQty < 1) {
                 removeFromCart(cartId); // سيقوم بإعادة العرض
                 return;
             }

             // Use the stock stored in the cart item itself
             const currentStock = item.stock ?? 0; // Use stock saved when added

             if (newQty > currentStock) {
                 showToast(`لا يمكن تجاوز الكمية المتوفرة في المخزون (${currentStock})!`, 'error');
                 return;
             }

             state.cart[itemIndex].quantity = newQty;
             localDb.set('cart', state.cart);
             updateCartBadge();
             renderCartPage(); // إعادة عرض الصفحة لتحديث الإجمالي والأزرار
        };

        // 8. إزالة منتج من السلة (يستخدم localDb) - كما هي
        const removeFromCart = (cartId) => {
             const itemToRemove = state.cart.find(item => item.cartId === cartId);
             if (!itemToRemove) return;

             showModal(`
                 <div class="p-4 text-center">
                      <i data-lucide="trash-2" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                      <h3 class="text-lg font-semibold mb-2">تأكيد الإزالة</h3>
                      <p class="text-gray-600 mb-6">هل أنت متأكد من إزالة "${itemToRemove.title}" من السلة؟</p>
                      <div class="flex justify-center space-x-4 space-x-reverse">
                          <button id="confirm-remove-item" class="bg-red-600 text-white py-2 px-5 rounded-md font-medium hover:bg-red-700 transition-colors">
                              نعم، إزالة
                          </button>
                          <button class="modal-close-btn bg-gray-200 text-gray-800 py-2 px-5 rounded-md font-medium hover:bg-gray-300 transition-colors">
                              إلغاء
                          </button>
                      </div>
                  </div>
             `);
              document.getElementById('confirm-remove-item').onclick = () => {
                  state.cart = state.cart.filter(item => item.cartId !== cartId);
                  localDb.set('cart', state.cart);
                  updateCartBadge();
                  renderCartPage(); // Refresh cart page
                  hideModal();
                  showToast('تم إزالة المنتج من السلة.');
              };
        };

        // 9. عرض صفحة الدفع (Checkout) - تعديل الأيقونة وتحسين معالجة الأخطاء
        const renderCheckoutPage = async () => {
             const pageEl = document.getElementById('page-checkout');
              if (!pageEl) return;
              pageEl.innerHTML = '<div class="flex justify-center items-center h-64"><div class="loader"></div></div>'; // Loader

             const subTotal = state.cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);

             if (state.cart.length === 0) {
                 goTo('#/cart'); // Redirect if cart becomes empty
                 return;
             }

             let wilayas = [];
             let wilayasError = null;
             try {
                  const wilayaData = await fetchYalidineData('wilayas');
                  wilayas = wilayaData?.data || [];
                  wilayas.sort((a, b) => a.id - b.id);
             } catch (error) {
                  console.error("Failed to load wilayas:", error);
                  wilayasError = `خطأ (${error.message || 'غير معروف'}) في تحميل قائمة الولايات. الرجاء المحاولة مرة أخرى لاحقاً.`;
             }

             pageEl.innerHTML = `
                 <h1 class="text-2xl lg:text-3xl font-bold text-gray-900 mb-8 text-center">إتمام الطلب</h1>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">
                     <!-- الفورم -->
                     <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow border border-gray-200">
                         <h3 class="text-xl font-semibold mb-5 text-gray-800">1. معلومات التوصيل</h3>
                         <form id="checkout-form" class="space-y-4">
                             <div>
                                 <label for="checkout-name" class="block text-sm font-medium text-gray-700 mb-1">الاسم الكامل <span class="text-red-600">*</span></label>
                                 <input type="text" id="checkout-name" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                             </div>
                             <div>
                                 <label for="checkout-phone" class="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف <span class="text-red-600">*</span></label>
                                 <input type="tel" id="checkout-phone" name="phone" inputmode="tel" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500" required pattern="^(05|06|07)\\d{8}$" title="يجب أن يبدأ الرقم بـ 05, 06, أو 07 و يتكون من 10 أرقام">
                             </div>

                             <h3 class="text-xl font-semibold mb-1 pt-4 text-gray-800">2. اختيار طريقة التوصيل</h3>
                             ${wilayasError ? `<p class="text-red-600 bg-red-100 p-3 rounded-md text-sm">${wilayasError}</p>` : ''}
                              <!-- اختيار نوع التوصيل -->
                             <div class="radio-card-group grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                                  <label id="delivery-office-label" class="disabled">
                                      <input type="radio" name="delivery_type" value="office" disabled>
                                      <div class="radio-card">
                                           <div class="icon">
                                                <!-- استبدال أيقونة السحابة بأيقونة مكتب/مبنى -->
                                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                           </div>
                                           <span class="font-semibold text-gray-800">مكتب Yalidine</span>
                                           <small class="text-xs text-gray-500 mt-1">استلم من أقرب مكتب</small>
                                           <span id="desk-fee-display" class="text-sm font-bold text-blue-600 mt-2"></span>
                                      </div>
                                  </label>
                                   <label id="delivery-home-label" class="disabled">
                                       <input type="radio" name="delivery_type" value="home" disabled>
                                       <div class="radio-card">
                                           <div class="icon">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                           </div>
                                           <span class="font-semibold text-gray-800">توصيل للمنزل</span>
                                            <small class="text-xs text-gray-500 mt-1">توصيل مباشر لباب منزلك</small>
                                            <span id="home-fee-display" class="text-sm font-bold text-blue-600 mt-2"></span>
                                       </div>
                                   </label>
                             </div>

                             <div>
                                 <label for="checkout-wilaya" class="block text-sm font-medium text-gray-700 mb-1">الولاية <span class="text-red-600">*</span></label>
                                 <select id="checkout-wilaya" name="wilaya_id" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white focus:border-blue-500 focus:ring-blue-500" required ${wilayas.length === 0 ? 'disabled' : ''}>
                                      <option value="">-- ${wilayasError ? 'خطأ في التحميل' : 'اختر ولايتك'} --</option>
                                     ${wilayas.map(w => `<option value="${w.id}" data-name="${w.name}">${w.id} - ${w.name}</option>`).join('')}
                                 </select>
                             </div>

                              <div id="commune-or-center-container">
                                  <label id="commune-or-center-label" for="checkout-commune-center" class="block text-sm font-medium text-gray-700 mb-1">البلدية / المكتب <span class="text-red-600">*</span></label>
                                  <select id="checkout-commune-center" name="commune_or_center_name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white focus:border-blue-500 focus:ring-blue-500" required disabled>
                                       <option value="">-- اختر الولاية أولاً --</option>
                                  </select>
                                   <p id="commune-center-loading" class="text-xs text-blue-600 mt-1 hidden">جاري تحميل الخيارات...</p>
                                   <p id="commune-center-error" class="text-xs text-red-600 mt-1 hidden"></p>
                              </div>

                             <div id="address-container" class="hidden">
                                 <label for="checkout-address" class="block text-sm font-medium text-gray-700 mb-1">العنوان بالتفصيل (الحي، الشارع...) <span class="text-red-600">*</span></label>
                                                                    <input type="text" id="checkout-address" name="address" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                            </form>
                        </div>

                        <!-- ملخص الطلب -->
                        <aside class="lg:col-span-1">
                            <div class="bg-white p-6 rounded-lg shadow border border-gray-200 sticky top-24">
                                <h3 class="text-xl font-semibold mb-4 pb-4 border-b text-gray-800">ملخص الطلب</h3>
                                <!-- Cart Items Mini View -->
                                <div class="space-y-3 max-h-48 overflow-y-auto mb-4 pr-2 border-b pb-4">
                                    ${state.cart.map(item => `
                                        <div class="flex items-center space-x-3 space-x-reverse">
                                            <div class="relative flex-shrink-0">
                                                <img src="${item.image_url}" alt="${item.title}" class="w-12 h-14 object-cover rounded-md border">
                                                <span class="absolute -top-2 -right-2 bg-gray-600 text-white text-[10px] font-bold rounded-full h-4 w-4 flex items-center justify-center">${item.quantity}</span>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium text-gray-800 truncate">${item.title}</p>
                                                <p class="text-xs text-gray-500 truncate">${item.optionsText}</p>
                                            </div>
                                            <p class="text-sm font-medium flex-shrink-0" dir="ltr">${(item.price * item.quantity).toLocaleString('fr-DZ')} DZD</p>
                                        </div>
                                    `).join('')}
                                </div>
                                <!-- Totals -->
                                <div class="space-y-3 text-sm pt-4" dir="ltr">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Subtotal</span>
                                        <span class="font-medium text-gray-800">${subTotal.toLocaleString('fr-DZ')} DZD</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Shipping</span>
                                        <span id="shipping-cost" class="font-medium text-gray-800">اختر الولاية</span>
                                    </div>
                                    <div class="flex justify-between text-lg font-bold text-gray-900 mt-4 pt-4 border-t border-gray-300">
                                        <span>Total</span>
                                        <span id="total-cost" class="font-medium">${subTotal.toLocaleString('fr-DZ')} DZD</span>
                                    </div>
                                </div>
                                <button type="submit" form="checkout-form" id="submit-order-btn" class="w-full text-center mt-6 bg-blue-600 text-white py-3 px-6 rounded-md font-medium text-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center" disabled>
                                    <span class="btn-text">تأكيد الطلب</span>
                                    <div class="loader btn-loader hidden" style="width: 24px; height:24px; border-width: 3px;"></div>
                                </button>
                                 <p class="text-xs text-center text-gray-500 mt-3">الدفع عند الاستلام متوفر.</p>
                            </div>
                        </aside>
                    </div>
                `;

            // إضافة مستمعين لصفحة الدفع بعد عرضها
            setupCheckoutListeners(subTotal);
             // إظهار الخطأ إذا فشل تحميل الولايات
            if (wilayasError) {
                 showToast(wilayasError, 'error', 5000);
            }
        };

        // 10. ربط المستمعين لصفحة الدفع
        const setupCheckoutListeners = (subTotal) => {
            const form = document.getElementById('checkout-form');
            const wilayaSelect = document.getElementById('checkout-wilaya');
            const communeCenterSelect = document.getElementById('checkout-commune-center');
            const shippingCostEl = document.getElementById('shipping-cost');
            const totalCostEl = document.getElementById('total-cost');
            const addressContainer = document.getElementById('address-container');
            const checkoutAddressInput = document.getElementById('checkout-address');
            const deliveryTypeRadios = form.querySelectorAll('input[name="delivery_type"]');
            const submitBtn = document.getElementById('submit-order-btn');
             const submitBtnText = submitBtn.querySelector('.btn-text');
             const submitBtnLoader = submitBtn.querySelector('.btn-loader');
            const communeCenterLoadingEl = document.getElementById('commune-center-loading');
            const communeCenterErrorEl = document.getElementById('commune-center-error');
             const communeCenterLabel = document.getElementById('commune-or-center-label');
             const officeLabel = document.getElementById('delivery-office-label');
             const homeLabel = document.getElementById('delivery-home-label');
             const officeRadio = officeLabel?.querySelector('input');
             const homeRadio = homeLabel?.querySelector('input');
             const deskFeeDisplay = document.getElementById('desk-fee-display');
             const homeFeeDisplay = document.getElementById('home-fee-display');

            let currentShippingCost = null; // null indicates not calculated yet
            let deliveryFees = { home: null, desk: null }; // Store fees for the selected wilaya

            const updateTotal = () => {
                const calculatedShipping = currentShippingCost ?? 0;
                shippingCostEl.textContent = currentShippingCost !== null ? `${calculatedShipping.toLocaleString('fr-DZ')} DZD` : 'اختر التوصيل';
                totalCostEl.textContent = `${(subTotal + calculatedShipping).toLocaleString('fr-DZ')} DZD`;
                // Enable submit button only if shipping is calculated (not null) and > 0, and form is potentially valid
                submitBtn.disabled = currentShippingCost === null || currentShippingCost < 0 ; // Allow 0 DZD shipping
            };

             const resetDeliveryOptions = () => {
                 deliveryFees = { home: null, desk: null };
                 currentShippingCost = null;
                 communeCenterSelect.innerHTML = '<option value="">-- اختر الولاية أولاً --</option>';
                 communeCenterSelect.disabled = true;
                 addressContainer.classList.add('hidden');
                 checkoutAddressInput.required = false;
                 communeCenterLoadingEl.classList.add('hidden');
                 communeCenterErrorEl.classList.add('hidden');
                 // Reset and disable radio buttons and labels
                 if(officeRadio) officeRadio.disabled = true;
                 if(homeRadio) homeRadio.disabled = true;
                 if(officeRadio) officeRadio.checked = false;
                 if(homeRadio) homeRadio.checked = false;
                 officeLabel.classList.add('disabled');
                 homeLabel.classList.add('disabled');
                 if(deskFeeDisplay) deskFeeDisplay.textContent = '';
                 if(homeFeeDisplay) homeFeeDisplay.textContent = '';
                 updateTotal();
             };


            // عند تغيير الولاية
            wilayaSelect.addEventListener('change', async () => {
                 const wilayaId = wilayaSelect.value;
                  resetDeliveryOptions(); // Reset everything related to delivery

                if (!wilayaId) {
                    return;
                }

                // إظهار التحميل وإخفاء الأخطاء السابقة
                communeCenterLoadingEl.classList.remove('hidden');
                communeCenterLoadingEl.textContent = 'جاري حساب أسعار الشحن...';
                communeCenterErrorEl.classList.add('hidden');
                 submitBtn.disabled = true; // Disable submit while loading fees

                try {
                     // جلب أسعار الشحن أولاً
                     const feesDataResponse = await fetchYalidineData('fees', { to_wilaya_id: wilayaId });
                     console.log("Fees Response:", feesDataResponse);

                      // التحقق من وجود بيانات per_commune (هيكلية الاستجابة قد تختلف)
                      // بناءً على كود PHP، نفترض أن الاستجابة تحتوي على كائن per_commune
                      const feesData = feesDataResponse?.per_commune;

                     if (feesData && Object.keys(feesData).length > 0) {
                         // استخراج رسوم أول بلدية كمثال (كما في كود PHP)
                          // تحتاج إلى التأكد من أن المفاتيح `express_home` و `express_desk` موجودة
                         const firstCommuneFeesKey = Object.keys(feesData)[0];
                         const firstCommuneFees = feesData[firstCommuneFeesKey];

                         if (firstCommuneFees) {
                             deliveryFees.home = firstCommuneFees.express_home ?? null; // Use null if undefined
                             deliveryFees.desk = firstCommuneFees.express_desk ?? null;

                             // تفعيل خيارات التوصيل بناءً على الأسعار المتاحة
                             if (deliveryFees.desk !== null && deliveryFees.desk >= 0) {
                                 officeRadio.disabled = false;
                                 officeLabel.classList.remove('disabled');
                                 deskFeeDisplay.textContent = `${deliveryFees.desk.toLocaleString('fr-DZ')} دج`;
                             } else {
                                 deskFeeDisplay.textContent = 'غير متاح';
                             }
                             if (deliveryFees.home !== null && deliveryFees.home >= 0) {
                                 homeRadio.disabled = false;
                                 homeLabel.classList.remove('disabled');
                                 homeFeeDisplay.textContent = `${deliveryFees.home.toLocaleString('fr-DZ')} دج`;
                             } else {
                                 homeFeeDisplay.textContent = 'غير متاح';
                             }

                             // تحديد الخيار الأرخص (أو المكتب) كافتراضي إذا كان متاحاً
                             if (deliveryFees.desk !== null && deliveryFees.desk >= 0) {
                                 officeRadio.checked = true;
                                 officeRadio.dispatchEvent(new Event('change', { bubbles:true })); // Trigger change event
                             } else if (deliveryFees.home !== null && deliveryFees.home >= 0) {
                                 homeRadio.checked = true;
                                 homeRadio.dispatchEvent(new Event('change', { bubbles:true })); // Trigger change event
                             } else {
                                 // No options available
                                 communeCenterLoadingEl.classList.add('hidden');
                                 communeCenterErrorEl.textContent = 'الشحن غير متوفر لهذه الولاية.';
                                 communeCenterErrorEl.classList.remove('hidden');
                             }

                         } else {
                             throw new Error("لم يتم العثور على بيانات أسعار الشحن للبلدية الأولى.");
                         }
                     } else {
                         // هذا الخطأ قد يعني أن API key خطأ أو أن Yalidine لا تدعم الولاية
                          console.error("Fees data 'per_commune' is missing or empty.", feesDataResponse);
                         throw new Error(feesDataResponse?.message || "الشحن غير متوفر حالياً لهذه الولاية. (e:2)");
                     }

                } catch (error) {
                     console.error("Error fetching/processing shipping fees:", error);
                     resetDeliveryOptions();
                     communeCenterLoadingEl.classList.add('hidden');
                     communeCenterErrorEl.textContent = error.message || "خطأ في حساب أسعار الشحن.";
                     communeCenterErrorEl.classList.remove('hidden');
                      showToast(error.message || "خطأ في حساب أسعار الشحن.", 'error');
                }
            });

            // عند تغيير نوع التوصيل
            deliveryTypeRadios.forEach(radio => {
                radio.addEventListener('change', async () => {
                    const selectedType = form.querySelector('input[name="delivery_type"]:checked').value;
                    const wilayaId = wilayaSelect.value;
                     currentShippingCost = null; // Reset cost until communes/centers are loaded and selected
                     communeCenterSelect.innerHTML = '<option value="">-- تحميل الخيارات --</option>';
                     communeCenterSelect.disabled = true;
                     addressContainer.classList.add('hidden');
                     checkoutAddressInput.required = false; // Reset address requirement
                     communeCenterLoadingEl.classList.remove('hidden');
                     communeCenterLoadingEl.textContent = 'جاري تحميل الخيارات...';
                     communeCenterErrorEl.classList.add('hidden');
                     submitBtn.disabled = true; // Disable submit while loading options

                     let options = [];
                     let errorMsg = null;

                     try {
                         if (selectedType === 'home') {
                             communeCenterLabel.textContent = 'البلدية *';
                             communeCenterSelect.name = 'commune_or_center_name'; // Use appropriate name
                             addressContainer.classList.remove('hidden');
                             checkoutAddressInput.required = true;
                             currentShippingCost = deliveryFees.home; // Set cost directly

                             const communeData = await fetchYalidineData('communes', { wilaya_id: wilayaId });
                             options = communeData?.data || [];
                             if (options.length === 0) errorMsg = 'لا توجد بلديات متاحة لهذه الولاية.';

                         } else { // office
                             communeCenterLabel.textContent = 'مكتب الاستلام *';
                             communeCenterSelect.name = 'commune_or_center_name'; // Use appropriate name
                             // Address is not required for office delivery
                             currentShippingCost = deliveryFees.desk; // Set cost directly

                             const centerData = await fetchYalidineData('centers', { wilaya_id: wilayaId });
                             options = centerData?.data || [];
                             if (options.length === 0) errorMsg = 'لا توجد مكاتب استلام متاحة لهذه الولاية.';
                         }

                         // Populate dropdown
                         communeCenterSelect.innerHTML = '<option value="">-- اختر --</option>';
                         if (options.length > 0) {
                             options.sort((a, b) => a.name.localeCompare(b.name, 'ar')); // Sort alphabetically
                             options.forEach(opt => {
                                 // For centers, the 'name' is the commune name where the center is located
                                 communeCenterSelect.innerHTML += `<option value="${opt.name}">${opt.name}</option>`;
                             });
                             communeCenterSelect.disabled = false;
                         } else {
                             communeCenterSelect.innerHTML = `<option value="">${errorMsg || '-- لا توجد خيارات --'}</option>`;
                             if (errorMsg) {
                                 communeCenterErrorEl.textContent = errorMsg;
                                 communeCenterErrorEl.classList.remove('hidden');
                             }
                         }

                    } catch (error) {
                         console.error(`Error fetching ${selectedType === 'home' ? 'communes' : 'centers'}:`, error);
                         errorMsg = `خطأ في تحميل قائمة ${selectedType === 'home' ? 'البلديات' : 'المكاتب'}.`;
                         communeCenterSelect.innerHTML = `<option value="">${errorMsg}</option>`;
                         communeCenterErrorEl.textContent = errorMsg;
                         communeCenterErrorEl.classList.remove('hidden');
                         showToast(errorMsg, 'error');
                    } finally {
                         communeCenterLoadingEl.classList.add('hidden');
                         updateTotal(); // Update total cost (might enable submit button if options loaded and selected)
                    }
                });
            });

             // Update total when commune/center is selected (ensure shipping cost is applied)
             communeCenterSelect.addEventListener('change', () => {
                 updateTotal(); // Just recalculate total and button state
             });


            // عند إرسال الفورم
             form.addEventListener('submit', (e) => handleCheckoutSubmit(e, subTotal)); // Pass subTotal
        };

        // 11. إرسال الطلب (Checkout Submit) - باستخدام Firebase Transaction
        const handleCheckoutSubmit = async (e, subTotal) => {
            e.preventDefault();
            const form = e.target;
            const submitBtn = document.getElementById('submit-order-btn');
            const submitBtnText = submitBtn.querySelector('.btn-text');
            const submitBtnLoader = submitBtn.querySelector('.btn-loader');

            // Basic form validation (HTML5 required should handle most)
            if (!form.checkValidity()) {
                showToast('يرجى ملء جميع الحقول المطلوبة بشكل صحيح.', 'error');
                form.reportValidity(); // Show browser's default validation messages
                return;
            }
             // Validate delivery type selection
             const selectedDeliveryType = form.querySelector('input[name="delivery_type"]:checked');
             if (!selectedDeliveryType) {
                 showToast('يرجى اختيار طريقة التوصيل.', 'error');
                 return;
             }
             // Validate commune/center selection
             const communeCenterSelect = document.getElementById('checkout-commune-center');
             if (!communeCenterSelect.value) {
                 showToast(`يرجى اختيار ${selectedDeliveryType.value === 'home' ? 'البلدية' : 'مكتب الاستلام'}.`, 'error');
                 communeCenterSelect.focus();
                 return;
             }
             // Validate address if home delivery
             const addressInput = document.getElementById('checkout-address');
             if (selectedDeliveryType.value === 'home' && !addressInput.value.trim()) {
                 showToast('يرجى إدخال عنوان التوصيل بالتفصيل.', 'error');
                 addressInput.focus();
                 return;
             }

            if(submitBtn) submitBtn.disabled = true;
            if(submitBtnText) submitBtnText.classList.add('hidden');
            if(submitBtnLoader) submitBtnLoader.classList.remove('hidden');

             // استرداد السعر النهائي للشحن المحسوب
             const finalShippingCostText = document.getElementById('shipping-cost').textContent;
             const finalShippingCostMatch = finalShippingCostText.match(/([\d,]+(?:\.\d+)?)/); // Extract number
             const finalShippingCost = finalShippingCostMatch ? parseFloat(finalShippingCostMatch[1].replace(',', '.')) : null; // Handle potential locale differences

             if (finalShippingCost === null || finalShippingCost < 0) {
                 showToast('خطأ في سعر الشحن. يرجى إعادة تحديد الولاية.', 'error');
                 if(submitBtn) submitBtn.disabled = false;
                 if(submitBtnText) submitBtnText.classList.remove('hidden');
                 if(submitBtnLoader) submitBtnLoader.classList.add('hidden');
                 return;
             }

             // --- حفظ الطلب وتقليل المخزون (Firebase Transaction) ---
             try {
                 const wilayaOption = document.querySelector(`#checkout-wilaya option[value="${form.wilaya_id.value}"]`);
                 const orderData = {
                     // لا نضع ID هنا، Firestore سيقوم بإنشائه
                     createdAt: serverTimestamp(), // Use server timestamp
                     name: form.name.value,
                     phone: form.phone.value,
                     wilaya: wilayaOption ? wilayaOption.dataset.name : `ID: ${form.wilaya_id.value}`, // اسم الولاية
                     commune: form.commune_or_center_name.value, // اسم البلدية أو المكتب
                     address: selectedDeliveryType.value === 'home' ? form.address.value : `استلام من مكتب Yalidine (${form.commune_or_center_name.value})`, // عنوان أو ملاحظة المكتب
                     delivery_type: selectedDeliveryType.value, // 'home' or 'office'
                     cart: state.cart.map(item => ({ // نسخ بيانات السلة اللازمة
                         ...item,
                         selectedOptions: item.optionsText ? item.optionsText.split(' / ').map(opt => ({ value: opt })) : [] // للحفظ
                     })),
                     shipping_cost: finalShippingCost,
                     grand_total: subTotal + finalShippingCost,
                     status: 'pending', // الحالة الأولية
                     yalidine_tracking_id: null,
                     userId: userId // ربط الطلب بالمستخدم (حتى لو كان مجهولاً)
                 };

                 // تنفيذ Transaction لحفظ الطلب وتحديث المخزون
                 await runTransaction(db, async (transaction) => {
                     // 1. تحقق من المخزون وجلب مراجع المنتجات
                     const productRefsToUpdate = new Map(); // Map<string, {ref: DocumentReference, data: any}>
                     for (const item of orderData.cart) {
                         const productRef = doc(db, 'products', item.product_id);
                         const productSnap = await transaction.get(productRef);

                         if (!productSnap.exists()) {
                             throw new Error(`المنتج: ${item.title} لم يعد متوفراً!`);
                         }

                         const productData = productSnap.data();
                         const variantIndex = productData.variants.findIndex(v => v.id == item.variant_id);

                         if (variantIndex === -1) {
                             throw new Error(`الخيار: ${item.optionsText} للمنتج ${item.title} لم يعد متوفراً!`);
                         }

                         const variant = productData.variants[variantIndex];
                         if (variant.stock_quantity < item.quantity) {
                              throw new Error(`المخزون لم يعد كافياً للمنتج: ${item.title} (${item.optionsText}). المتبقي: ${variant.stock_quantity}`);
                         }

                         // تجهيز التحديث
                         productData.variants[variantIndex].stock_quantity -= item.quantity;
                         productRefsToUpdate.set(item.product_id, { ref: productRef, data: productData });
                     }

                     // 2. حفظ الطلب الجديد
                     const newOrderRef = doc(collection(db, "orders")); // إنشاء مرجع لطلب جديد
                     transaction.set(newOrderRef, orderData);
                     orderData.id = newOrderRef.id; // حفظ الـ ID لعرضه في رسالة النجاح (مؤقتاً)

                     // 3. تحديث مخزون جميع المنتجات
                     productRefsToUpdate.forEach(updateInfo => {
                         transaction.update(updateInfo.ref, { variants: updateInfo.data.variants, updatedAt: serverTimestamp() });
                     });
                 });

                 // --- بعد نجاح الـ Transaction ---
                 console.log("Order submitted successfully!");

                 // 4. إفراغ السلة المحلية
                 state.cart = [];
                 localDb.set('cart', []);
                 updateCartBadge();

                 // 5. عرض رسالة النجاح
                 showModal(`
                     <div class="p-4 text-center">
                         <i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto mb-4"></i>
                         <h3 class="text-2xl font-bold mb-2">تم إرسال طلبك بنجاح!</h3>
                         <p class="text-gray-600 mb-6">شكراً لثقتكم. سنتصل بكم قريباً لتأكيد الطلب. رقم طلبك هو <strong class="font-bold text-gray-900">#${orderData.id.slice(-6)}</strong>.</p>
                         <button class="modal-close-btn w-full bg-gray-900 text-white py-2 px-4 rounded-md font-medium hover:bg-gray-800 transition-colors">
                             متابعة التسوق
                         </button>
                     </div>
                 `, 'max-w-md'); // Larger modal for success

                 // 6. إضافة مستمع لإغلاق المودال والعودة للرئيسية
                 document.querySelector('#modal-container .modal-close-btn').addEventListener('click', () => {
                     hideModal();
                     goTo('#/');
                 });

            } catch (error) {
                 console.error("Checkout failed:", error);
                 showToast(error.message || 'حدث خطأ أثناء معالجة الطلب.', 'error', 5000);
                 if(submitBtn) submitBtn.disabled = false; // Re-enable button on error
                 if(submitBtnText) submitBtnText.classList.remove('hidden');
                 if(btnLoader) btnLoader.classList.add('hidden');
            }
        };


        // ==========================================
        // بدء تشغيل التطبيق
        // ==========================================
        // ابدأ بتهيئة Firebase، الذي سيقوم بدوره بتهيئة واجهة المستخدم
        initializeFirebase();

    </script>

</body>
</html>
