<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boutique Glamour</title>
    <!-- ØªØ­Ù…ÙŠÙ„ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Lucide -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.min.js"></script>
    <!-- Ø®Ø·ÙˆØ· Cairo Ùˆ Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›ï¸</text></svg>">

    <style>
        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© */
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            background-color: #f8fafc; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø£ÙØªØ­ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .color-swatch.selected::after {
            content: '';
            position: absolute;
            top: -4px; right: -4px; bottom: -4px; left: -4px;
            border: 2px solid #3b82f6; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± */
            border-radius: 50%;
        }
         .color-swatch:hover {
            transform: scale(1.1);
        }

        .size-tag {
            border: 1px solid #cbd5e1;
            padding: 6px 16px;
            border-radius: 99px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            background-color: white;
        }
         .size-tag:hover:not(.selected):not(:disabled) {
             background-color: #f1f5f9;
         }
        .size-tag.selected {
            background-color: #1f2937;
            color: #fff;
            border-color: #1f2937;
        }
         .size-tag:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #e2e8f0;
         }

        /* Ù„Ø¥Ø®ÙØ§Ø¡ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª */
        .page {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Ù…ÙˆØ¯Ø§Ù„ (Modal) */
        .modal {
            transition: opacity 0.3s ease;
        }

        /* ØªØ­Ù…ÙŠÙ„ (Spinner) */
        .loader {
            border: 4px solid #e5e7eb; /* Light gray */
            border-top: 4px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
         .loader.btn-loader { /* Spinner for buttons */
             border-color: rgba(255, 255, 255, 0.3);
             border-top-color: #fff;
         }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ØªØµÙ…ÙŠÙ… ÙƒØ±ÙˆØª Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¨ÙŠÙ† Ø§Ù„ØªÙˆØµÙŠÙ„ */
        .radio-card-group label input[type="radio"] { display: none; }
        .radio-card {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem 1rem;
            text-align: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            background-color: white;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .radio-card-group label input[type="radio"]:checked + .radio-card {
            border-color: #3b82f6; /* Blue */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background-color: #eff6ff; /* Light Blue */
        }
        .radio-card-group label:hover input[type="radio"]:not(:checked) + .radio-card {
             border-color: #9ca3af; /* Gray */
        }
        .radio-card-group label.disabled .radio-card {
             opacity: 0.5;
             cursor: not-allowed;
             background-color: #f3f4f6;
        }
        .radio-card .icon {
             margin-bottom: 0.75rem;
             color: #6b7280; /* Gray */
             transition: color 0.2s ease-in-out;
        }
         .radio-card-group label input[type="radio"]:checked + .radio-card .icon {
             color: #3b82f6; /* Blue */
         }

        /* Ø²Ø± Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© */
        .remove-image-btn {
            position: absolute;
            top: -8px;
            left: -8px; /* For RTL */
            background-color: #ef4444; /* Red */
            color: white;
            border-radius: 50%;
            padding: 2px;
            display: none;
            cursor: pointer;
            z-index: 10;
        }
        .image-preview-item:hover .remove-image-btn {
            display: block;
        }

        /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ ÙƒØ±Øª Ø§Ù„Ù…Ù†ØªØ¬ */
        .product-card-image-container {
            aspect-ratio: 1 / 1; /* Ù†Ø³Ø¨Ø© Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø±Ø¨Ø¹Ø© */
            overflow: hidden;
            background-color: #f1f5f9; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ù„Ù„ØµÙˆØ± Ø§Ù„Ø´ÙØ§ÙØ© Ø£Ùˆ Ø§Ù„ØªÙŠ Ù„Ø§ ØªÙ…Ù„Ø£ */
        }
        .product-card-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ù„Ù…Ù„Ø¡ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ÙˆÙ‚Øµ Ø§Ù„Ø²Ø§Ø¦Ø¯ */
            transition: transform 0.3s ease-in-out;
        }
        .group:hover .product-card-image-container img {
            transform: scale(1.05); /* ØªÙƒØ¨ÙŠØ± Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± */
        }

    </style>
</head>
<body class="bg-gray-100">

    <!-- Ø¨Ø¯Ø§ÙŠØ© Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="app" class="min-h-screen flex flex-col">

        <!-- ====================================================== -->
        <!-- =========== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© (Header) Ù„Ù„Ø¹Ù…ÙŠÙ„ =========== -->
        <!-- ====================================================== -->
        <header id="customer-header" class="bg-white shadow-sm sticky top-0 z-40">
            <nav class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Ø§Ù„Ù„ÙˆØ¬Ùˆ -->
                    <a href="#/" class="text-2xl font-bold text-gray-900">Boutique Glamour</a>

                    <!-- Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙ†Ù‚Ù„ -->
                    <div class="flex items-center space-x-6" dir="ltr">
                        <a href="#/" class="text-gray-600 hover:text-blue-600 font-medium transition-colors">Ø§Ù„Ù…ØªØ¬Ø±</a>
                        <a href="#/cart" class="relative text-gray-600 hover:text-blue-600 transition-colors">
                            <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                            <span id="cart-count-badge" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        </a>
                        <!-- Ø±Ø§Ø¨Ø· Ø§Ù„Ø£Ø¯Ù…Ù† - ÙŠÙ…ÙƒÙ† Ø¥Ø®ÙØ§Ø¤Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª -->
                        <a href="#/admin" class="text-gray-400 hover:text-gray-700 transition-colors" title="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…">
                            <i data-lucide="user-cog" class="w-6 h-6"></i>
                        </a>
                    </div>
                </div>
            </nav>
        </header>

        <!-- ====================================================== -->
        <!-- =========== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© (Header) Ù„Ù„Ø£Ø¯Ù…Ù† =========== -->
        <!-- ====================================================== -->
        <header id="admin-header" class="bg-gray-900 text-white shadow-md sticky top-0 z-40 hidden">
            <nav class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="#/admin/dashboard" class="text-xl font-bold">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</a>
                    <div class="flex items-center space-x-6" dir="ltr">
                        <a href="#/admin/products" class="text-gray-300 hover:text-white transition-colors">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
                        <a href="#/admin/orders" class="text-gray-300 hover:text-white transition-colors">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
                        <!-- <a href="#/admin/settings" class="text-gray-300 hover:text-white transition-colors">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a> --> <!-- ØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡ Ù…Ø¤Ù‚ØªØ§Ù‹ -->
                        <a href="#/" id="admin-logout-btn" class="text-red-400 hover:text-red-300 transition-colors" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </a>
                    </div>
                </div>
            </nav>
        </header>

        <!-- ====================================================== -->
        <!-- ================== Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙØ­Ø§Øª ================== -->
        <!-- ====================================================== -->
        <main class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8 flex-grow">

            <!-- ØµÙØ­Ø© Ø§Ù„Ù…ØªØ¬Ø± (Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª) -->
            <section id="page-shop" class="page">
                <h1 class="text-3xl font-bold text-gray-900 mb-8 text-center">Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§</h1>
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù‡Ù†Ø§ Ø¹Ø¨Ø± JS -->
                    <div id="shop-loader" class="col-span-full flex justify-center items-center h-64">
                         <div class="loader"></div>
                    </div>
                    <p id="no-products-message" class="col-span-full text-center text-gray-500 py-10 hidden"></p>
                </div>
            </section>

            <!-- ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ -->
            <section id="page-product-detail" class="page">
                 <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø³ÙŠØ¹Ø±Ø¶ Ù‡Ù†Ø§ Ù…Ø¹ Loader Ø¯Ø§Ø®Ù„ÙŠ -->
                 <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
            </section>

            <!-- ØµÙØ­Ø© Ø§Ù„Ø³Ù„Ø© -->
            <section id="page-cart" class="page">
                 <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø³ÙŠØ¹Ø±Ø¶ Ù‡Ù†Ø§ -->
                 <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
            </section>

            <!-- ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ (Checkout) -->
            <section id="page-checkout" class="page">
                 <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø³ÙŠØ¹Ø±Ø¶ Ù‡Ù†Ø§ Ù…Ø¹ Loader Ø¯Ø§Ø®Ù„ÙŠ -->
                 <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
            </section>

            <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† -->
            <section id="page-admin-login" class="page">
                <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md mt-10 border border-gray-200">
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
                    <form id="admin-login-form">
                        <div class="mb-4">
                            <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="password" id="admin-password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <p id="admin-login-error" class="text-red-600 text-sm mb-4 hidden"></p>
                        <button type="submit" class="w-full bg-gray-900 text-white py-2 px-4 rounded-md font-medium hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 transition-colors">
                            Ø¯Ø®ÙˆÙ„
                        </button>
                    </form>
                </div>
            </section>

            <!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) -->
            <section id="page-admin-dashboard" class="page">
                <h1 class="text-3xl font-bold text-gray-900 mb-8">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <a href="#/admin/products" class="block bg-white p-6 rounded-lg shadow border border-gray-200 hover:shadow-lg hover:border-blue-500 transition-all duration-300">
                        <i data-lucide="package" class="w-10 h-10 text-blue-600 mb-3"></i>
                        <h3 class="text-xl font-semibold mb-1 text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
                        <p class="text-gray-600">Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†.</p>
                    </a>
                    <a href="#/admin/orders" class="block bg-white p-6 rounded-lg shadow border border-gray-200 hover:shadow-lg hover:border-green-500 transition-all duration-300">
                        <i data-lucide="shopping-bag" class="w-10 h-10 text-green-600 mb-3"></i>
                        <h3 class="text-xl font-semibold mb-1 text-gray-800">Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                        <p class="text-gray-600">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ø­Ø§Ù„ÙŠØ©.</p>
                    </a>
                    <!--
                    <a href="#/admin/settings" class="block bg-white p-6 rounded-lg shadow border border-gray-200 hover:shadow-lg hover:border-gray-500 transition-all duration-300">
                        <i data-lucide="settings" class="w-10 h-10 text-gray-600 mb-3"></i>
                        <h3 class="text-xl font-semibold mb-1 text-gray-800">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
                        <p class="text-gray-600">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø­Ù† (Yalidine) ÙˆØºÙŠØ±Ù‡Ø§.</p>
                    </a>
                     -->
                </div>
            </section>

            <!-- ØµÙØ­Ø© Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† -->
            <section id="page-admin-products" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
                    <a href="#/admin/products/new" class="bg-blue-600 text-white py-2 px-4 rounded-md font-medium hover:bg-blue-700 flex items-center space-x-2 space-x-reverse transition-colors">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        <span>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</span>
                    </a>
                </div>
                <div class="bg-white shadow-md rounded-lg overflow-x-auto border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø³Ø¹Ø±</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="admin-product-list" class="bg-white divide-y divide-gray-200">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù‡Ù†Ø§ -->
                            <tr><td colspan="4" class="text-center p-8 text-gray-500"><div class="loader mx-auto"></div></td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- (ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Pagination Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹) -->
            </section>

            <!-- ØµÙØ­Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ Ù„Ù„Ø£Ø¯Ù…Ù† -->
            <section id="page-admin-product-form" class="page">
                 <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø³ÙŠØ¹Ø±Ø¶ Ù‡Ù†Ø§ -->
                 <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
            </section>

            <!-- ØµÙØ­Ø© Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† -->
            <section id="page-admin-orders" class="page">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
                <div class="bg-white shadow-md rounded-lg overflow-x-auto border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                            </tr>
                        </thead>
                        <tbody id="admin-order-list" class="bg-white divide-y divide-gray-200">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‡Ù†Ø§ -->
                            <tr><td colspan="6" class="text-center p-8 text-gray-500"><div class="loader mx-auto"></div></td></tr>
                        </tbody>
                    </table>
                </div>
                 <!-- (ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Pagination Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹) -->
            </section>

            <!-- ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ù„Ù„Ø£Ø¯Ù…Ù† -->
            <section id="page-admin-order-detail" class="page">
                 <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø³ÙŠØ¹Ø±Ø¶ Ù‡Ù†Ø§ -->
                 <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
            </section>

            <!-- ØµÙØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† (ÙŠØ§Ù„ÙŠØ¯ÙŠÙ†) - ØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡Ø§ Ù„Ø£Ù† Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙÙŠ Netlify -->
            <!--
            <section id="page-admin-settings" class="page">
                 <h1 class="text-3xl font-bold text-gray-900 mb-6">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h1>
                 <p class="text-gray-600 bg-yellow-100 p-4 rounded-md border border-yellow-300">
                      ØªÙ… Ù†Ù‚Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Yalidine API Ø¥Ù„Ù‰ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© ÙÙŠ Netlify Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ù…Ø§Ù†.
                      Ù„Ù… ØªØ¹Ø¯ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØªÙØ³ØªØ®Ø¯Ù… Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­.
                 </p>
            </section>
             -->

        </main>

        <!-- ====================================================== -->
        <!-- ================== Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Modal) ================== -->
        <!-- ====================================================== -->
        <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden opacity-0 modal" style="transition: opacity 0.3s ease;"></div>
        <div id="modal-container" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden opacity-0 scale-95 modal" style="transition: opacity 0.3s ease, transform 0.3s ease;">
            <div id="modal-content" class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 text-center transform transition-all">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù‡Ù†Ø§ -->
                 <div class="loader mx-auto"></div>
            </div>
        </div>

        <!-- Toast Notification Container -->
         <div id="toast-container" class="fixed bottom-5 left-5 z-[70] space-y-3"></div>

    </div> <!-- Ù†Ù‡Ø§ÙŠØ© Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->

    <!-- ====================================================== -->
    <!-- ================== Ø¨Ø¯Ø§ÙŠØ© ÙƒÙˆØ¯ JavaScript ================== -->
    <!-- ====================================================== -->

    <!-- Firebase SDK - Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„ -->
    <!-- <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // !! Ù‡Ø§Ù…: Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… __firebase_config Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù‡Ø°Ø§ !!
        const firebaseConfig = {
           // ... (Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ)
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        window._firebaseApp = app; // Make it globally accessible for the main script
    </script> -->

    <!-- Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <script type="module" defer>
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯ÙˆØ§Ù„ Firebase Firestore Ùˆ Auth
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, writeBatch, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { enableIndexedDbPersistence, CACHE_SIZE_UNLIMITED } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; // For offline persistence

        // ==========================================
        // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
        // ==========================================
        let app, db, auth, userId = null;
        let productsUnsubscribe = null; // Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
        let ordersUnsubscribe = null; // Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø·Ù„Ø¨Ø§Øª

        async function initializeFirebase() {
    try {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªÙƒÙ† Ù…Ù† Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        if (!firebaseConfig) {
            console.error("Firebase config not found!");
            showToast("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.", "error", 10000);
            // ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ù†Ø§
            document.body.innerHTML = '<p class="text-center text-red-600 p-10">Ø®Ø·Ø£ Ø­Ø±Ø¬: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
            return false;
        }

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // *** Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­: ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù‡Ù†Ø§ Ø§Ù„Ø¢Ù† Ø¨Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© db ***
        productsCollection = collection(db, 'products');
        ordersCollection = collection(db, 'orders');
        // *** Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ***

        // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (Offline Persistence) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙƒÙ† Ù…ÙÙŠØ¯
        try {
            await enableIndexedDbPersistence(db, { cacheSizeBytes: CACHE_SIZE_UNLIMITED });
            console.log("Firebase offline persistence enabled.");
        } catch (err) {
            if (err.code == 'failed-precondition') {
                console.warn("Multiple tabs open, persistence can only be enabled in one tab at a a time.");
            } else if (err.code == 'unimplemented') {
                console.warn("The current browser does not support all of the features required to enable persistence.");
            } else {
                console.error("Error enabling offline persistence:", err);
            }
        }


        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ØªÙƒÙ† Ø£Ùˆ ÙƒÙ…Ø¬Ù‡ÙˆÙ„
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡ (Ø³ÙˆØ§Ø¡ Ø¨ØªÙƒÙ† Ø£Ùˆ Ù…Ø¬Ù‡ÙˆÙ„)
                userId = user.uid;
                console.log("User is signed in:", userId);
                if (user.isAnonymous) {
                    console.log("User is anonymous.");
                } else {
                    console.log("User signed in with custom token.");
                }
                // Ø§Ù„Ø¢Ù† Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                setupFirestoreListeners();
                initializeAppUI(); // ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ø§ÙˆØªØ±
            } else {
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø­Ø§ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                console.log("No user signed in, attempting sign in...");
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                    // onAuthStateChanged Ø³ÙŠÙØ³ØªØ¯Ø¹Ù‰ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                } catch (error) {
                    console.error("Error signing in:", error);
                    showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.", "error", 10000);
                    document.body.innerHTML = '<p class="text-center text-red-600 p-10">Ø®Ø·Ø£ Ø­Ø±Ø¬: ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
                }
            }
        });

        return true;

    } catch (error) {
        console.error("Firebase Initialization Error:", error);
        showToast("ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.", "error", 10000);
        document.body.innerHTML = '<p class="text-center text-red-600 p-10">Ø®Ø·Ø£ Ø­Ø±Ø¬: ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
        return false;
    }
}


        // ==========================================
        // Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: Ø§Ù„ØªØ®Ø²ÙŠÙ†ØŒ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ ÙˆØ§Ù„Ø±Ø§ÙˆØªØ±
        // ==========================================

        // 1. ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø¯Ù…Ù† (ØºÙŠÙ‘Ø±Ù‡Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ù„Ù‡Ø§ Ù„Ù€ environment variable Ù„Ø§Ø­Ù‚Ø§Ù‹!)
        const ADMIN_PASSWORD = 'admin123';

        // 2. Ù…Ø­Ø§ÙƒØ§Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Database) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage Ù„Ù„Ø³Ù„Ø© ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙÙ‚Ø·
        const localDb = {
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.error(`Failed to get from localStorage: ${key}`, e);
                    return defaultValue;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.error(`Failed to save to localStorage: ${key}`, e);
                }
            }
        };

        // 3. Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ (In-Memory State - Ø³ØªÙÙ…Ù„Ø£ Ù…Ù† Firestore)
        const state = {
            products: [], // Ø³ØªÙÙ…Ù„Ø£ Ù…Ù† Firestore
            orders: [], // Ø³ØªÙÙ…Ù„Ø£ Ù…Ù† Firestore
            cart: localDb.get('cart', []), // Ø§Ù„Ø³Ù„Ø© ØªØ¨Ù‚Ù‰ Ù…Ø­Ù„ÙŠØ© Ù…Ø¤Ù‚ØªØ§Ù‹
            yalidineSettings: {}, // Ù„Ù… ØªØ¹Ø¯ ØªÙØ³ØªØ®Ø¯Ù… Ù„Ù„Ù…ÙØ§ØªÙŠØ­ØŒ Ù„ÙƒÙ† Ù‚Ø¯ ØªÙØ³ØªØ®Ø¯Ù… Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹
            lastFetched: { // Ù„ØªØ®Ø²ÙŠÙ† ÙˆÙ‚Øª Ø¢Ø®Ø± Ø¬Ù„Ø¨ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Yalidine
                wilayas: 0,
                communes: {}, // wilayaId: timestamp
                fees: {},    // wilayaId: timestamp
                centers: {}    // wilayaId: timestamp
            },
            cache: { // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Yalidine Ù…Ø¤Ù‚ØªØ§Ù‹
                 wilayas: localDb.get('yalidine_wilayas_cache'),
                 communes: localDb.get('yalidine_communes_cache', {}),
                 fees: localDb.get('yalidine_fees_cache', {}),
                 centers: localDb.get('yalidine_centers_cache', {})
            },
            appReady: false // Ù„ØªØªØ¨Ø¹ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
        };
        const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 Ø³Ø§Ø¹Ø© Ø¨Ø§Ù„Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ©

        // Ù…Ø³Ø§Ø±Ø§Øª Firestore (Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø§Ø±Ø§Ù‹ Ø¨Ø³ÙŠØ·Ø§Ù‹ Ø§Ù„Ø¢Ù†ØŒ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹)
        let productsCollection;
        let ordersCollection;

        // 4. Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Firestore (Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø­ÙŠØ©)
        function setupFirestoreListeners() {
            // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ Ø¥Ù† ÙˆØ¬Ø¯ÙˆØ§
            if (productsUnsubscribe) productsUnsubscribe();
            if (ordersUnsubscribe) ordersUnsubscribe();

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
            productsUnsubscribe = onSnapshot(productsCollection, (snapshot) => {
                console.log("Products updated from Firestore");
                const productsFromDb = [];
                snapshot.forEach((doc) => {
                    productsFromDb.push({ ...doc.data(), id: doc.id }); // Ø¥Ø¶Ø§ÙØ© ID Ø§Ù„Ù…Ø³ØªÙ†Ø¯
                });
                state.products = productsFromDb;
                // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                rerenderCurrentPageIfProductDependent();
                state.appReady = true; // Ø§Ø¹ØªØ¨Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø²Ø§Ù‹ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
            }, (error) => {
                console.error("Error listening to products:", error);
                showToast("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.", "error");
                state.appReady = true; // Ø§Ø¹ØªØ¨Ø±Ù‡ Ø¬Ø§Ù‡Ø²Ø§Ù‹ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ØŒ Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                rerenderCurrentPageIfProductDependent(); // Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª"
            });

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø·Ù„Ø¨Ø§Øª (ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ù…Ù†ØŸ Ø£Ùˆ Ù„Ù„ÙƒÙ„ØŸ Ù„Ù†ÙØªØ±Ø¶ Ù„Ù„ÙƒÙ„ Ù…Ø¤Ù‚ØªØ§Ù‹)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            ordersUnsubscribe = onSnapshot(ordersCollection, (snapshot) => {
                console.log("Orders updated from Firestore");
                const ordersFromDb = [];
                snapshot.forEach((doc) => {
                    ordersFromDb.push({ ...doc.data(), id: doc.id });
                });
                state.orders = ordersFromDb;
                 // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ù…Ø«Ù„ ØµÙØ­Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†)
                rerenderCurrentPageIfOrderDependent();
            }, (error) => {
                console.error("Error listening to orders:", error);
                // Ù„Ø§ ØªØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ø¹Ù† ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                // showToast("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.", "error");
            });
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ­ØªØ§Ø¬ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        function rerenderCurrentPageIfProductDependent() {
            const currentHash = window.location.hash || '#/';
            if (currentHash === '#/' || currentHash.startsWith('#/product/') || currentHash === '#/admin/products' || currentHash.startsWith('#/admin/products/edit/') || currentHash === '#/admin/products/new' || currentHash === '#/cart' || currentHash === '#/checkout') {
                 router(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø±Ø§ÙˆØªØ± Ø³ÙŠØ¹ÙŠØ¯ Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            }
             // ØªØ­Ø¯ÙŠØ« Loader Ø£Ùˆ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…ØªØ¬Ø±
             const shopLoader = document.getElementById('shop-loader');
             const noProductsMsg = document.getElementById('no-products-message');
             if (shopLoader && noProductsMsg) {
                  shopLoader.classList.add('hidden');
                  const hasProducts = state.products.length > 0;
                  noProductsMsg.classList.toggle('hidden', hasProducts);
                  if (!hasProducts) {
                       noProductsMsg.textContent = `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹. ${isAdmin() ? '<a href="#/admin/products/new" class="text-blue-600 font-medium hover:underline">Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Ù‹</a>' : ''}`;
                  }
             }
        }
         // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ­ØªØ§Ø¬ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        function rerenderCurrentPageIfOrderDependent() {
            const currentHash = window.location.hash || '#/';
            if (currentHash === '#/admin/orders' || currentHash.startsWith('#/admin/orders/')) {
                 router(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø±Ø§ÙˆØªØ± Ø³ÙŠØ¹ÙŠØ¯ Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            }
        }


        // 5. Ø§Ù„Ø±Ø§ÙˆØªØ± (Router) Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙØ­Ø§Øª
        const router = () => {
             // Ù„Ø§ ØªÙ‚Ù… Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø§ÙˆØªØ± Ù‚Ø¨Ù„ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©)
             if (!state.appReady && !(window.location.hash.startsWith('#/admin'))) {
                  console.log("App not ready, router execution delayed.");
                  return;
             }

            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†
            const admin = isAdmin();
             // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§
             const customerHeader = document.getElementById('customer-header');
             const adminHeader = document.getElementById('admin-header');
             if (customerHeader) customerHeader.classList.toggle('hidden', admin);
             if (adminHeader) adminHeader.classList.toggle('hidden', !admin);


            const hash = window.location.hash || '#/';
            let pageId = '';
            let params = null;

            // --- ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¹Ù…ÙŠÙ„ ---
            if (hash === '#/') {
                pageId = 'page-shop';
                renderShopPage();
            } else if (hash.startsWith('#/product/')) {
                pageId = 'page-product-detail';
                params = hash.split('/')[2];
                renderProductDetailPage(params); // Ø³ØªØ¹Ø±Ø¶ Loader Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹ ÙˆØªØ¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬
            } else if (hash === '#/cart') {
                pageId = 'page-cart';
                renderCartPage(); // ØªÙ‚Ø±Ø£ Ù…Ù† state.cart (localStorage)
            } else if (hash === '#/checkout') {
                pageId = 'page-checkout';
                renderCheckoutPage(); // ØªØ­ØªØ§Ø¬ Ù„Ø¬Ù„Ø¨ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª
            }
            // --- ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø£Ø¯Ù…Ù† ---
            else if (hash === '#/admin') {
                pageId = 'page-admin-login';
                if (admin) { goTo('#/admin/dashboard'); return; } // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹
                // Ø±Ø¨Ø· Ù…Ø³ØªÙ…Ø¹ ÙÙˆØ±Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø©
                setTimeout(() => {
                    const loginForm = document.getElementById('admin-login-form');
                     // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
                     const newLoginForm = loginForm?.cloneNode(true);
                     if(loginForm && newLoginForm) {
                          loginForm.parentNode.replaceChild(newLoginForm, loginForm);
                          newLoginForm.addEventListener('submit', handleAdminLogin);
                     }
                }, 0);
            } else if (hash === '#/admin/dashboard') {
                pageId = 'page-admin-dashboard';
                if (!admin) { goTo('#/admin'); return; }
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Øµ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
            } else if (hash === '#/admin/products') {
                pageId = 'page-admin-products';
                if (!admin) { goTo('#/admin'); return; }
                renderAdminProductList(); // ØªÙ‚Ø±Ø£ Ù…Ù† state.products (Firestore)
            } else if (hash === '#/admin/products/new') {
                pageId = 'page-admin-product-form';
                if (!admin) { goTo('#/admin'); return; }
                renderProductForm(); // ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            } else if (hash.startsWith('#/admin/products/edit/')) {
                 pageId = 'page-admin-product-form';
                 params = hash.split('/')[4];
                 if (!admin) { goTo('#/admin'); return; }
                 // Ø§Ù„Ù…Ù†ØªØ¬ Ø³ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡ Ø¯Ø§Ø®Ù„ renderProductForm Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ params
                 renderProductForm(params); // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ - ØªÙ…Ø±ÙŠØ± ID
            } else if (hash === '#/admin/orders') {
                pageId = 'page-admin-orders';
                if (!admin) { goTo('#/admin'); return; }
                renderAdminOrderList(); // ØªÙ‚Ø±Ø£ Ù…Ù† state.orders (Firestore)
            } else if (hash.startsWith('#/admin/orders/')) {
                pageId = 'page-admin-order-detail';
                params = hash.split('/')[3];
                if (!admin) { goTo('#/admin'); return; }
                 // Ø§Ù„Ø·Ù„Ø¨ Ø³ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡ Ø¯Ø§Ø®Ù„ renderOrderDetailPage Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ params
                renderOrderDetailPage(params); // ØªÙ…Ø±ÙŠØ± ID
            }
            /* // Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù… ÙŠØ¹Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ Ù„Ù„Ù…ÙØ§ØªÙŠØ­
            else if (hash === '#/admin/settings') {
                pageId = 'page-admin-settings';
                if (!admin) { goTo('#/admin'); return; }
                renderSettingsPage();
            }
             */
             else {
                 // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ·Ø§Ø¨Ù‚ Ø£ÙŠ Ù…Ø³Ø§Ø±ØŒ Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ù…ØªØ¬Ø±
                 goTo('#/');
                 return; // Ø£ÙˆÙ‚Ù Ø§Ù„ØªÙ†ÙÙŠØ° Ù‡Ù†Ø§ Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© Ø®Ø§Ø·Ø¦Ø©
            }

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.add('active');
            } else {
                // ØµÙØ­Ø© Ø®Ø·Ø£ 404 Ø£Ùˆ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
                console.error("Page not found for hash:", hash);
                const shopPage = document.getElementById('page-shop');
                if (shopPage) {
                     shopPage.classList.add('active');
                     renderShopPage();
                }
            }

            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø£Ø¹Ù„Ù‰
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            window.scrollTo(0, 0);
        };

        // 6. ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© (Helpers)
        const goTo = (hash) => window.location.hash = hash;
        const isAdmin = () => sessionStorage.getItem('isAdmin') === 'true';

        // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        const showModal = (content, size = 'max-w-sm') => {
             const modalContent = document.getElementById('modal-content');
             modalContent.innerHTML = content;
             modalContent.className = `bg-white rounded-lg shadow-xl w-full p-6 text-center transform transition-all ${size}`; // Apply size class

             const backdrop = document.getElementById('modal-backdrop');
             const container = document.getElementById('modal-container');

             backdrop.classList.remove('hidden');
             container.classList.remove('hidden');

             // Force reflow to enable transition
             void container.offsetWidth;

             backdrop.classList.add('opacity-100');
             container.classList.add('opacity-100', 'scale-100');
             container.classList.remove('opacity-0', 'scale-95');
             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             } // Render icons inside modal
        };

         // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
         const hideModal = () => {
             const backdrop = document.getElementById('modal-backdrop');
             const container = document.getElementById('modal-container');

             backdrop.classList.remove('opacity-100');
             container.classList.remove('opacity-100', 'scale-100');
             container.classList.add('opacity-0', 'scale-95');

             setTimeout(() => {
                 backdrop.classList.add('hidden');
                 container.classList.add('hidden');
                 document.getElementById('modal-content').innerHTML = '<div class="loader mx-auto"></div>'; // Reset content
             }, 300); // Match transition duration
        };

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© (Toast)
        const showToast = (message, type = 'success', duration = 3000) => {
             const container = document.getElementById('toast-container');
             const toast = document.createElement('div');
             const bgColor = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-blue-600');
             const icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'x-circle' : 'info');

             toast.className = `flex items-center space-x-3 space-x-reverse ${bgColor} text-white py-3 px-5 rounded-lg shadow-xl transition-all duration-300 transform translate-y-full opacity-0`;
             toast.innerHTML = `
                 <i data-lucide="${icon}" class="w-5 h-5"></i>
                 <p>${message}</p>
                 <button class="ml-auto -mr-1 p-1 hover:bg-black/20 rounded-full">
                     <i data-lucide="x" class="w-4 h-4"></i>
                 </button>
             `;
             container.appendChild(toast);
             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             }

             // Add close button listener
             toast.querySelector('button').addEventListener('click', () => {
                 toast.classList.add('opacity-0', 'translate-y-full');
                 setTimeout(() => toast.remove(), 300);
             });

             // Animate in
             setTimeout(() => {
                 toast.classList.remove('translate-y-full', 'opacity-0');
                 toast.classList.add('translate-y-0', 'opacity-100');
             }, 100);

             // Auto dismiss
             setTimeout(() => {
                  toast.classList.add('opacity-0', 'translate-y-full');
                  setTimeout(() => {
                       // Ensure toast still exists before removing
                       if (toast.parentNode === container) {
                            toast.remove();
                       }
                  }, 300);
             }, duration);
        };

        // Ø¯Ø§Ù„Ø© fetch Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù„Ù€ Yalidine Proxy)
        // Ø¯Ø§Ù„Ø© fetch Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù„Ù€ Yalidine Proxy)
         const apiFetch = async (endpoint, options = {}) => {
             // Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø³Ø±ÙŠØ© Ù„Ù… ØªØ¹Ø¯ ØªÙØ±Ø³Ù„ Ù…Ù† Ù‡Ù†Ø§ØŒ Ø¨Ù„ Ù…Ù† Netlify Function
             const headers = {
                 'Content-Type': 'application/json',
                'Accept': 'application/json',
                 ...options.headers,
                 };

               // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø±ÙˆÙƒØ³ÙŠ Netlify
               const YALIDINE_BASE_URL = '/yalidine-api'; // Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ø³ÙŠÙˆØ¬Ù‡ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø§Ù„Ø© netlify/functions/yalidine-proxy.js
               const url = `${YALIDINE_BASE_URL}${endpoint}`; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù†Ø³Ø¨ÙŠ Ù„Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ

               try {
                     console.log(`Fetching via Proxy: ${url} with params:`, options.params);
                     const queryParams = new URLSearchParams(options.params || {}).toString();
                     // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ØªØ±Ø§Øª ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø¯Ø§Ù„Ø© (Ø§Ù„Ø¯Ø§Ù„Ø© Ø³ØªÙØµÙ„ Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù† Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ØªØ±Ø§Øª)
                     const fullUrl = queryParams ? `${url}?${queryParams}` : url;

                     // *** Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© 400 Bad Request ***
                     const fetchOptions = {
                           method: options.method || 'GET',
                           headers: headers,
                     };

                     // Ø£Ø¶Ù Ø§Ù„Ù€ body ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙˆÙ„Ù… ÙŠÙƒÙ† Ø§Ù„Ø·Ù„Ø¨ GET
                     if (options.body && fetchOptions.method !== 'GET') {
                           fetchOptions.body = JSON.stringify(options.body);
                     }
                     
                     const response = await fetch(fullUrl, fetchOptions);
                     // *** Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ***

                     if (!response.ok) {
                           let errorData;
                           try {
                              errorData = await response.json();
                           } catch(e) {
                               // Fallback if response is not JSON
                               errorData = { message: `Ø®Ø·Ø£ ${response.status}: ${response.statusText || 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø§Ù„Ø´Ø­Ù†'}` };
                           }
                           console.error('API Error Response (from browser fetch):', errorData, 'Status:', response.status);
                           // Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ Ø¥Ù† ÙˆØ¬Ø¯ØªØŒ Ø£Ùˆ Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø©
                           throw new Error(errorData.message || `Ø®Ø·Ø£ ${response.status} Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø§Ù„Ø´Ø­Ù†.`);
                     }
                     const data = await response.json();
                     console.log('API Success Response (from browser fetch):', data);
                     return data;

               } catch (error) {
                     console.error(`API Fetch Error (${url}):`, error);
                     // Ù„Ø§ ØªØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© toast Ù‡Ù†Ø§ Ø¯Ø§Ø¦Ù…Ø§Ù‹ØŒ Ù‚Ø¯ ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ ÙÙŠ Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡
                     // showToast(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø§Ù„Ø´Ø­Ù†: ${error.message}`, 'error');
                     throw error; // Ø£Ø¹Ø¯ Ø±Ù…ÙŠ Ø§Ù„Ø®Ø·Ø£ Ù„ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡
               }
            };


        // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Yalidine Ù…Ø¹ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª (Caching)
        const fetchYalidineData = async (type, params = {}) => {
             const now = Date.now();
             let cacheKey = type;
             let lastFetchTime = state.lastFetched[type];
             let cachedData = state.cache[type];
             let endpoint = '';
             let specificCacheKey = null; // Ù„Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ø¹Ù„Ù‰ parameters Ù…Ø«Ù„ wilaya_id

             switch (type) {
                 case 'wilayas':
                     endpoint = '/wilayas';
                     params.page_size = params.page_size || 60; // Ensure page size
                     break;
                 case 'communes':
                     endpoint = '/communes';
                     params.page_size = params.page_size || 1600;
                     if (!params.wilaya_id) throw new Error("wilaya_id is required for communes");
                     specificCacheKey = params.wilaya_id.toString();
                     lastFetchTime = state.lastFetched.communes[specificCacheKey] || 0;
                     cachedData = state.cache.communes[specificCacheKey];
                     break;
                 case 'fees':
                     endpoint = '/fees';
                     params.from_wilaya_id = 16; // Ø§ÙØªØ±Ø¶ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø§Ù„Ø´Ø­Ù† Ù…Ù† ÙˆÙ„Ø§ÙŠØ© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± (16)
                     if (!params.to_wilaya_id) throw new Error("to_wilaya_id is required for fees");
                     specificCacheKey = params.to_wilaya_id.toString();
                     lastFetchTime = state.lastFetched.fees[specificCacheKey] || 0;
                     cachedData = state.cache.fees[specificCacheKey];
                     break;
                 case 'centers':
                     endpoint = '/communes'; // Centers are communes with has_stop_desk = true
                     params.page_size = params.page_size || 1600;
                      params.has_stop_desk = true; // Ø§Ø·Ù„Ø¨ ÙÙ‚Ø· Ø§Ù„Ø¨Ù„Ø¯ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ÙƒØªØ¨
                     if (!params.wilaya_id) throw new Error("wilaya_id is required for centers");
                     specificCacheKey = params.wilaya_id.toString();
                     lastFetchTime = state.lastFetched.centers[specificCacheKey] || 0;
                     cachedData = state.cache.centers[specificCacheKey];
                     break;
                 default:
                     throw new Error(`Invalid Yalidine data type: ${type}`);
             }

             // Check cache
             if (cachedData && (now - lastFetchTime < CACHE_DURATION)) {
                  console.log(`Using cached data for ${type}` + (specificCacheKey ? ` (${specificCacheKey})` : ''));
                  // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø·Ù„Ø¨Ù†Ø§Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù€ has_stop_desk=true
                 return cachedData;
             }

              console.log(`Fetching fresh data for ${type}` + (specificCacheKey ? ` (${specificCacheKey})` : ''));

             // Fetch fresh data
             try {
                 const data = await apiFetch(endpoint, { params: params });

                  // Update cache and last fetched time
                  if (specificCacheKey) {
                      state.cache[type][specificCacheKey] = data;
                      state.lastFetched[type][specificCacheKey] = now;
                  } else {
                      state.cache[type] = data;
                      state.lastFetched[type] = now;
                  }
                   // Persist cache
                  if (type === 'wilayas') localDb.set('yalidine_wilayas_cache', state.cache.wilayas);
                  else if (type === 'communes') localDb.set('yalidine_communes_cache', state.cache.communes);
                  else if (type === 'fees') localDb.set('yalidine_fees_cache', state.cache.fees);
                  else if (type === 'centers') localDb.set('yalidine_centers_cache', state.cache.centers);

                  return data;


             } catch (error) {
                 console.error(`Failed to fetch Yalidine ${type}:`, error);
                 // Return old cached data if fetch fails, but log error
                  if (cachedData) {
                      console.warn(`Returning stale cached data for ${type}` + (specificCacheKey ? ` (${specificCacheKey})` : ''));
                      return cachedData;
                  }
                 throw error; // Re-throw if no cache available
             }
        };

        // ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ø§ÙˆØªØ± (ØªÙØ³ØªØ¯Ø¹Ù‰ Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Firebase)
        const initializeAppUI = () => {
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ù„Ù„ØªØ´ØºÙŠÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
            window.addEventListener('hashchange', router);
            document.addEventListener('DOMContentLoaded', router); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø±Ø§ÙˆØªØ± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ DOM

            // Ù…Ø³ØªÙ…Ø¹ Ø¹Ø§Ù… Ù„Ù„Ø£Ø­Ø¯Ø§Ø« (Event Delegation)
            document.body.addEventListener('click', (e) => {
                // Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
                if (e.target.id === 'modal-backdrop' || e.target.closest('.modal-close-btn')) {
                    hideModal();
                }
            });

             // Ù…Ø³ØªÙ…Ø¹ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
             const logoutBtn = document.getElementById('admin-logout-btn');
             if (logoutBtn) {
                  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
                  const newLogoutBtn = logoutBtn.cloneNode(true);
                  logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);
                  newLogoutBtn.addEventListener('click', handleAdminLogout);
             }


            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            updateCartBadge();

            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø±Ø§ÙˆØªØ± Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© Ø¨Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© UI Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            if (!state.appReady) {
                 // Ù‚Ø¯ Ù„Ø§ ØªÙƒÙˆÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯ØŒ Ø§Ø¹Ø±Ø¶ loader Ø¹Ø§Ù… Ø£Ùˆ Ø§Ù†ØªØ¸Ø±
                 console.log("Initial data not ready yet, delaying first route...");
                 // ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ loader Ø±Ø¦ÙŠØ³ÙŠ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
            } else {
                 router();
            }
        };

        // ==========================================
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø¯Ù…Ù† (Admin Logic) - Ù…Ø¹ Firebase
        // ==========================================

        // 1. ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†
        const handleAdminLogin = (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('isAdmin', 'true');
                if(errorEl) errorEl.classList.add('hidden');
                goTo('#/admin/dashboard');
            } else {
                 if(errorEl) {
                      errorEl.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                      errorEl.classList.remove('hidden');
                 }
            }
        };

        // 2. ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ø£Ø¯Ù…Ù†
        const handleAdminLogout = (e) => {
            e.preventDefault();
            sessionStorage.removeItem('isAdmin');
            goTo('#/'); // Ø³ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø±Ø§ÙˆØªØ± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        };

        // 3. Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙŠØ§Ù„ÙŠØ¯ÙŠÙ† (Ù„Ù… ØªØ¹Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù„Ù„Ù…ÙØ§ØªÙŠØ­)
        const renderSettingsPage = () => {
             // ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ÙÙˆØ±Ù…
        };

        // 4. Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙŠØ§Ù„ÙŠØ¯ÙŠÙ† (Ù„Ù… ØªØ¹Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù„Ù„Ù…ÙØ§ØªÙŠØ­)
        const handleYalidineSettingsSubmit = (e) => {
             e.preventDefault();
             // Ù„Ù… ÙŠØ¹Ø¯ Ù‡Ù†Ø§Ùƒ Ø´ÙŠØ¡ Ù„Ù„Ø­ÙØ¸ Ù‡Ù†Ø§ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
             showToast('ØªÙ… Ù†Ù‚Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API Ø¥Ù„Ù‰ Netlify.', 'info');
        };

         // Ø¯Ø§Ù„Ø© Ù„Ù…Ø³Ø­ ÙƒØ§Ø´ ÙŠØ§Ù„ÙŠØ¯ÙŠÙ†
         const clearYalidineCache = () => {
             state.lastFetched = { wilayas: 0, communes: {}, fees: {}, centers: {} };
             state.cache = { wilayas: null, communes: {}, fees: {}, centers: {} };
             localStorage.removeItem('yalidine_wilayas_cache');
             localStorage.removeItem('yalidine_communes_cache');
             localStorage.removeItem('yalidine_fees_cache');
             localStorage.removeItem('yalidine_centers_cache');
             console.log("Yalidine cache cleared.");
         };

        // 5. Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† (ØªÙ‚Ø±Ø£ Ù…Ù† state.products Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ù† Firestore)
        const renderAdminProductList = () => {
            const listEl = document.getElementById('admin-product-list');
            if (!listEl) return;

             // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰
             const newListEl = listEl.cloneNode(false); // Clone without children
             listEl.parentNode.replaceChild(newListEl, listEl);


            if (state.products.length === 0) {
                newListEl.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª. <a href="#/admin/products/new" class="text-blue-600 font-medium hover:underline">Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</a></td></tr>`;
                return;
            }

            newListEl.innerHTML = state.products.map(product => {
                const defaultVariant = product.variants?.find(v => v.is_default) || product.variants?.[0] || { price: 0, stock_quantity: 0 };
                const totalStock = product.variants?.reduce((acc, v) => acc + (v.stock_quantity || 0), 0) ?? 0;
                 // ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
                 const firstGeneralImage = product.generalImages?.[0]?.url;
                 const firstVariantImage = Object.values(product.variantImages || {})?.[0]?.[0]?.url;
                 const displayImage = firstGeneralImage || firstVariantImage || 'https://placehold.co/48x48/e2e8f0/a0aec0?text=??';


                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-12 w-12">
                                    <img class="h-12 w-12 rounded-md object-cover border" src="${displayImage}" alt="${product.title || 'Ù…Ù†ØªØ¬'}">
                                </div>
                                <div class="mr-4">
                                    <div class="text-sm font-medium text-gray-900">${product.title}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${defaultVariant.price?.toLocaleString('fr-DZ')} Ø¯.Ø¬</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${totalStock > 0 ? 'text-green-600' : 'text-red-600'} font-medium">${totalStock} ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-left" dir="ltr">
                            <a href="#/admin/products/edit/${product.id}" class="text-blue-600 hover:text-blue-900 transition-colors">ØªØ¹Ø¯ÙŠÙ„</a>
                            <button data-delete-product-id="${product.id}" class="text-red-600 hover:text-red-900 ml-3 transition-colors">Ø­Ø°Ù</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø­Ø°Ù
            newListEl.querySelectorAll('[data-delete-product-id]').forEach(btn => {
                btn.addEventListener('click', async (e) => { // Async for Firestore delete
                    e.preventDefault();
                    const idToDelete = e.currentTarget.dataset.deleteProductId;
                    const productTitle = state.products.find(p => p.id == idToDelete)?.title || 'Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø­Ø¯Ø¯';
                    showModal(`
                        <div class="p-4 text-center">
                             <i data-lucide="alert-triangle" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                             <h3 class="text-lg font-semibold mb-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
                             <p class="text-gray-600 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ "${productTitle}"ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.</p>
                             <div class="flex justify-center space-x-4 space-x-reverse">
                                 <button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-5 rounded-md font-medium hover:bg-red-700 transition-colors">
                                     Ù†Ø¹Ù…ØŒ Ø­Ø°Ù
                                 </button>
                                 <button class="modal-close-btn bg-gray-200 text-gray-800 py-2 px-5 rounded-md font-medium hover:bg-gray-300 transition-colors">
                                     Ø¥Ù„ØºØ§Ø¡
                                 </button>
                             </div>
                         </div>
                    `);
                    document.getElementById('confirm-delete-btn').onclick = async () => {
                         hideModal();
                         showToast('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬...', 'info', 2000);
                         try {
                              const productRef = doc(db, 'products', idToDelete);
                              await deleteDoc(productRef);
                              showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                              // Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ renderAdminProductList() Ù‡Ù†Ø§
                              // onSnapshot Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                         } catch (error) {
                              console.error("Error deleting product:", error);
                              showToast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬.', 'error');
                         }
                    };
                });
            });
             if (typeof lucide !== 'undefined') { // Render icons in the list
                 lucide.createIcons();
             }
        };

        // 6. Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† (ØªÙ‚Ø±Ø£ Ù…Ù† state.orders Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ù† Firestore)
        const renderAdminOrderList = () => {
            const listEl = document.getElementById('admin-order-list');
             if (!listEl) return;

             // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰
             const newListEl = listEl.cloneNode(false); // Clone without children
             listEl.parentNode.replaceChild(newListEl, listEl);

            const sortedOrders = [...state.orders].sort((a, b) => {
                 // Sort by creation time (assuming timestamp field exists)
                 const timeA = a.createdAt?.seconds || 0;
                 const timeB = b.createdAt?.seconds || 0;
                 return timeB - timeA; // Newest first
            });

            if (sortedOrders.length === 0) {
                newListEl.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.</td></tr>`;
                return;
            }

            newListEl.innerHTML = sortedOrders.map(order => {
                const statusInfo = getStatusBadge(order.status);
                // Format date safely
                 let orderDate = 'N/A';
                 if (order.createdAt && order.createdAt.seconds) {
                      try {
                          orderDate = new Date(order.createdAt.seconds * 1000).toLocaleDateString('ar-DZ', { day: 'numeric', month: 'short', year: 'numeric'});
                      } catch (e) { console.error("Error formatting date:", e); }
                 } else if (typeof order.createdAt === 'string') { // Handle ISO string from old localStorage data if needed
                      try {
                          orderDate = new Date(order.createdAt).toLocaleDateString('ar-DZ', { day: 'numeric', month: 'short', year: 'numeric'});
                      } catch(e) { /* ignore */ }
                 }

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">#${order.id.slice(-6)}</td> <!-- Show partial ID -->
                        <td class="px-6 py-4 whitespace-nowrap">
                             <div class="text-sm font-medium text-gray-900">${order.name}</div>
                             <div class="text-sm text-gray-500">${order.phone}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-semibold">${order.grand_total?.toLocaleString('fr-DZ')} Ø¯.Ø¬</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm"><span class="${statusInfo.class} inline-block">${statusInfo.text}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${orderDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-left" dir="ltr">
                             <a href="#/admin/orders/${order.id}" class="text-blue-600 hover:text-blue-900 transition-colors inline-flex items-center space-x-1">
                                 <i data-lucide="eye" class="w-4 h-4"></i>
                                 <span>Ø¹Ø±Ø¶</span>
                             </a>
                        </td>
                    </tr>
                `;
            }).join('');
            if (typeof lucide !== 'undefined') { // Render icons
                lucide.createIcons();
            }
        };

        // 7. Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø£Ø¯Ù…Ù† (ØªÙ‚Ø±Ø£ Ù…Ù† state.orders)
        const renderOrderDetailPage = (orderId) => {
            const pageEl = document.getElementById('page-admin-order-detail');
            if (!pageEl) return;

            const order = state.orders.find(o => o.id == orderId);

            if (!order) {
                pageEl.innerHTML = `<div class="bg-white p-6 rounded-lg shadow text-center"><h1 class="text-2xl font-bold text-red-600 mb-4">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨.</h1><a href="#/admin/orders" class="text-blue-600 hover:underline">&larr; Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a></div>`;
                return;
            }

            const statusInfo = getStatusBadge(order.status);
            const subTotal = order.cart?.reduce((acc, item) => acc + (item.price * item.quantity), 0) ?? 0;
            const orderDate = order.createdAt?.seconds ? new Date(order.createdAt.seconds * 1000).toLocaleString('ar-DZ', { dateStyle: 'full', timeStyle: 'short' }) : 'N/A';

            pageEl.innerHTML = `
                <div class="flex justify-between items-center mb-6 pb-4 border-b">
                    <h1 class="text-2xl lg:text-3xl font-bold text-gray-900">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #${order.id.slice(-6)}</h1>
                    <a href="#/admin/orders" class="text-blue-600 hover:text-blue-800 flex items-center space-x-2 space-x-reverse transition-colors">
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª</span>
                    </a>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù† (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ) -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                                <h3 class="text-lg font-semibold text-gray-800">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</h3>
                                <span class="${statusInfo.class} inline-block">${statusInfo.text}</span>
                            </div>
                            <div class="space-y-4">
                                ${order.cart?.map(item => `
                                    <div class="flex items-center space-x-4 space-x-reverse">
                                        <img src="${item.image_url || 'https://placehold.co/64x80'}" alt="${item.title}" class="w-16 h-20 rounded-md object-cover border flex-shrink-0">
                                        <div class="flex-1 min-w-0">
                                            <p class="font-semibold text-gray-900 truncate">${item.title}</p>
                                            <p class="text-sm text-gray-500 truncate">${item.optionsText}</p>
                                            <p class="text-sm text-gray-500">Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.quantity}</p>
                                        </div>
                                        <div class="text-left flex-shrink-0" dir="ltr">
                                            <p class="font-semibold text-gray-900">${(item.price * item.quantity).toLocaleString('fr-DZ')} Ø¯.Ø¬</p>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.</p>'}
                            </div>
                            <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø¹Ø± -->
                            <div class="mt-6 pt-6 border-t border-gray-200 text-sm" dir="ltr">
                                <div class="flex justify-between text-gray-600">
                                    <span>Subtotal</span>
                                    <span>${subTotal.toLocaleString('fr-DZ')} DZD</span>
                                </div>
                                <div class="flex justify-between text-gray-600 mt-2">
                                    <span>Shipping</span>
                                    <span>${order.shipping_cost?.toLocaleString('fr-DZ')} DZD</span>
                                </div>
                                <div class="flex justify-between text-base font-bold text-gray-900 mt-4 pt-4 border-t border-gray-300">
                                    <span>Total</span>
                                    <span>${order.grand_total?.toLocaleString('fr-DZ')} DZD</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø± (Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ) -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4 pb-4 border-b text-gray-800">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                            <div class="space-y-2 text-sm text-gray-700">
                                <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${order.name}</p>
                                <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <a href="tel:${order.phone}" class="text-blue-600 hover:underline">${order.phone}</a></p>
                                <p><strong>Ø§Ù„ÙˆÙ„Ø§ÙŠØ©:</strong> ${order.wilaya}</p>
                                <p><strong>Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©/Ø§Ù„Ù…ÙƒØªØ¨:</strong> ${order.commune}</p>
                                <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ${order.address}</p>
                                <p><strong>Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> ${order.delivery_type === 'home' ? 'Ù„Ù„Ù…Ù†Ø²Ù„' : 'Ù…ÙƒØªØ¨ Yalidine'}</p>
                                <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</strong> ${orderDate}</p>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4 pb-4 border-b text-gray-800">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h3>
                            <div id="order-actions" class="space-y-3">
                                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‡Ù†Ø§ -->
                                 <div class="loader mx-auto"></div>
                            </div>
                        </div>

                         <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                             <h3 class="text-lg font-semibold mb-4 pb-4 border-b text-gray-800">ØªØªØ¨Ø¹ Ø§Ù„Ø´Ø­Ù† (Ù…Ø­Ø§ÙƒØ§Ø©)</h3>
                             <div id="yalidine-tracking-info" class="space-y-3 text-sm">
                                 <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø­Ù† Ù‡Ù†Ø§ -->
                                  <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª...</p>
                             </div>
                         </div>
                    </div>
                </div>
            `;

            renderOrderActions(order); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
            }
        };

        // 8. Ø¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø·Ù„Ø¨ (ÙƒÙ…Ø§ Ù‡ÙŠ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ØŒ Ø³ØªØ³ØªØ¯Ø¹ÙŠ handleUpdateOrderStatus)
        const renderOrderActions = (order) => {
             const container = document.getElementById('order-actions');
             const trackingContainer = document.getElementById('yalidine-tracking-info');
             if (!container || !trackingContainer) return;

             let buttons = '';
             let trackingInfo = `<p class="text-gray-500">Ù„Ù… ÙŠØªÙ… Ø´Ø­Ù† Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯.</p>`;

             // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
             if (order.status === 'pending') {
                 buttons = `
                     <button data-action="confirmed" class="w-full bg-green-600 text-white py-2 px-4 rounded-md font-medium hover:bg-green-700 flex items-center justify-center space-x-2 space-x-reverse transition-colors">
                         <i data-lucide="check" class="w-4 h-4"></i> <span>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</span>
                     </button>
                     <button data-action="cancelled" class="w-full bg-red-600 text-white py-2 px-4 rounded-md font-medium hover:bg-red-700 flex items-center justify-center space-x-2 space-x-reverse transition-colors">
                         <i data-lucide="x" class="w-4 h-4"></i> <span>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</span>
                     </button>
                 `;
             } else if (order.status === 'confirmed') {
                 buttons = `
                     <button data-action="shipped" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-medium hover:bg-blue-700 flex items-center justify-center space-x-2 space-x-reverse transition-colors">
                         <i data-lucide="truck" class="w-4 h-4"></i> <span>ØªÙ… Ø§Ù„Ø´Ø­Ù† (Ø¥Ù†Ø´Ø§Ø¡ ØªØªØ¨Ø¹ ÙˆÙ‡Ù…ÙŠ)</span>
                     </button>
                      <p class="text-xs text-center text-gray-500 mt-2">Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù… ØªØªØ¨Ø¹ ÙˆÙ‡Ù…ÙŠ.</p>
                     <button data-action="cancelled" class="w-full bg-red-600 text-white py-2 px-4 rounded-md font-medium hover:bg-red-700 flex items-center justify-center space-x-2 space-x-reverse transition-colors mt-2">
                         <i data-lucide="x" class="w-4 h-4"></i> <span>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</span>
                     </button>
                 `;
             } else if (order.status === 'shipped') {
                 buttons = `
                     <button data-action="delivered" class="w-full bg-green-600 text-white py-2 px-4 rounded-md font-medium hover:bg-green-700 flex items-center justify-center space-x-2 space-x-reverse transition-colors">
                         <i data-lucide="check-check" class="w-4 h-4"></i> <span>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</span>
                     </button>
                     <button data-action="returned" class="w-full bg-yellow-600 text-gray-800 py-2 px-4 rounded-md font-medium hover:bg-yellow-500 flex items-center justify-center space-x-2 space-x-reverse transition-colors mt-2">
                         <i data-lucide="rotate-ccw" class="w-4 h-4"></i> <span>Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø·Ù„Ø¨</span>
                     </button>
                 `;
                  if(order.yalidine_tracking_id) {
                      trackingInfo = `
                          <p><strong>Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹:</strong></p>
                          <p class="text-base font-bold text-blue-700 mb-2">${order.yalidine_tracking_id}</p>
                          <p class="text-xs text-gray-500">(Ù‡Ø°Ø§ Ø±Ù‚Ù… ØªØªØ¨Ø¹ ÙˆÙ‡Ù…ÙŠ Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©)</p>
                      `;
                  }
             } else if (order.status === 'delivered') {
                 buttons = `<p class="text-center font-medium text-green-600 py-2 px-4 bg-green-100 rounded-md">âœ… ØªÙ… ØªØ³Ù„ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.</p>`;
                  if(order.yalidine_tracking_id) trackingInfo = `<p><strong>Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹:</strong> ${order.yalidine_tracking_id}</p><p class="text-green-600 font-medium">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</p>`;
             } else if (order.status === 'cancelled') {
                 buttons = `<p class="text-center font-medium text-red-600 py-2 px-4 bg-red-100 rounded-md">âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.</p>`;
                 trackingInfo = `<p class="text-red-600 font-medium">Ù…Ù„ØºÙŠ</p>`
             } else if (order.status === 'returned') {
                 buttons = `<p class="text-center font-medium text-yellow-700 py-2 px-4 bg-yellow-100 rounded-md">â†©ï¸ ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.</p>`;
                  if(order.yalidine_tracking_id) trackingInfo = `<p><strong>Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹:</strong> ${order.yalidine_tracking_id}</p><p class="text-yellow-700 font-medium">ØªÙ… Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹</p>`;
             }

             container.innerHTML = buttons;
             trackingContainer.innerHTML = trackingInfo;
             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             }

             // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø²Ø±Ø§Ø±
             container.querySelectorAll('button[data-action]').forEach(btn => {
                  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ Ø§Ù„Ù…Ø­ØªÙ…Ù„ÙŠÙ†
                  const newBtn = btn.cloneNode(true);
                  btn.parentNode.replaceChild(newBtn, btn);

                 newBtn.addEventListener('click', () => {
                     const newStatus = newBtn.dataset.action;
                     let confirmMsg = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ "${getStatusBadge(newStatus).text}"ØŸ`;
                     if (newStatus === 'cancelled' || newStatus === 'returned') {
                         confirmMsg += "\nØ³ÙŠØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.";
                     }

                     showModal(`
                         <div class="p-4 text-center">
                             <i data-lucide="help-circle" class="w-16 h-16 text-blue-500 mx-auto mb-4"></i>
                             <h3 class="text-lg font-semibold mb-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3>
                             <p class="text-gray-600 mb-6 whitespace-pre-line">${confirmMsg}</p> <!-- Added whitespace-pre-line -->
                             <div class="flex justify-center space-x-4 space-x-reverse">
                                 <button id="confirm-action-btn" class="bg-blue-600 text-white py-2 px-5 rounded-md font-medium hover:bg-blue-700 transition-colors">
                                     Ù†Ø¹Ù…ØŒ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
                                 </button>
                                 <button class="modal-close-btn bg-gray-200 text-gray-800 py-2 px-5 rounded-md font-medium hover:bg-gray-300 transition-colors">
                                     Ø¥Ù„ØºØ§Ø¡
                                 </button>
                             </div>
                         </div>
                     `);
                     document.getElementById('confirm-action-btn').onclick = () => {
                          hideModal();
                          handleUpdateOrderStatus(order.id, newStatus); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«
                     };
                 });
             });
        };

        // 9. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ (Ù…Ø¹ Ù…Ù†Ø·Ù‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†) - Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase
        const handleUpdateOrderStatus = async (orderId, newStatus) => {
             const orderRef = doc(db, 'orders', orderId);
             showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨...', 'info', 2000);

             try {
                 await runTransaction(db, async (transaction) => {
                     const orderSnap = await transaction.get(orderRef);
                     if (!orderSnap.exists()) {
                         throw "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨!";
                     }

                     const orderData = orderSnap.data();
                     const originalStatus = orderData.status;

                     if (originalStatus === newStatus) return; // Ù„Ø§ ØªØºÙŠÙŠØ±

                     const shouldRestoreStock = (newStatus === 'cancelled' || newStatus === 'returned');
                     const wasStockRemoved = (originalStatus !== 'cancelled' && originalStatus !== 'returned' && originalStatus !== 'pending');
                     let trackingId = orderData.yalidine_tracking_id; // Keep existing tracking ID

                      // Generate fake tracking ID if moving to shipped
                      if (newStatus === 'shipped' && !trackingId) {
                           trackingId = `YAL-${Date.now().toString().slice(-7)}`;
                      }

                     // Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                     if (shouldRestoreStock && wasStockRemoved) {
                         // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                         for (const item of orderData.cart) {
                             const productRef = doc(db, 'products', item.product_id);
                             const productSnap = await transaction.get(productRef);
                             if (productSnap.exists()) {
                                  const productData = productSnap.data();
                                  const variantIndex = productData.variants.findIndex(v => v.id == item.variant_id);
                                  if (variantIndex > -1) {
                                       productData.variants[variantIndex].stock_quantity += item.quantity;
                                       transaction.update(productRef, { variants: productData.variants });
                                  } else { console.warn(`Variant ${item.variant_id} not found in product ${item.product_id} for stock restore.`); }
                             } else { console.warn(`Product ${item.product_id} not found for stock restore.`); }
                         }
                         console.log("Stock restored for order:", orderId);
                     } else if (!shouldRestoreStock && !wasStockRemoved && (newStatus === 'confirmed' || newStatus === 'shipped')) {
                         // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¯ ØªÙ… Ø¥Ø²Ø§Ù„ØªÙ‡ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†)
                         // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªØ­Ù‚Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯ØªØŒ Ù„ÙƒÙ†Ù†Ø§ Ø³Ù†ÙØªØ±Ø¶ Ø£Ù†Ù‡ ØªÙ… Ø¨Ø§Ù„ÙØ¹Ù„
                         console.log("Stock assumed to be already reduced for order:", orderId);
                     }

                     // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙˆØ±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹ Ø¥Ù† ÙˆØ¬Ø¯
                     transaction.update(orderRef, {
                          status: newStatus,
                          yalidine_tracking_id: trackingId // Update tracking ID if generated
                     });
                 });

                 showToast(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰: ${getStatusBadge(newStatus).text}`, 'success');
                  // onSnapshot Ø³ÙŠÙ‡ØªÙ… Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
                 // renderOrderDetailPage(orderId); // No longer needed
             } catch (error) {
                 console.error("Error updating order status:", error);
                 showToast(`ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: ${error}`, 'error');
             }
        };


        // 10. Ø¹Ø±Ø¶ Ø´Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© (Badge) - ÙƒÙ…Ø§ Ù‡ÙŠ
        const getStatusBadge = (status) => {
            const statuses = {
                 pending: { class: 'px-3 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800 border border-yellow-300', text: 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' },
                 confirmed: { class: 'px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800 border border-blue-300', text: 'Ù…Ø¤ÙƒØ¯' },
                 shipped: { class: 'px-3 py-1 text-xs font-medium rounded-full bg-indigo-100 text-indigo-800 border border-indigo-300', text: 'ØªÙ… Ø§Ù„Ø´Ø­Ù†' },
                 delivered: { class: 'px-3 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800 border border-green-300', text: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' },
                 cancelled: { class: 'px-3 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800 border border-red-300', text: 'Ù…Ù„ØºÙŠ' },
                 returned: { class: 'px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800 border border-gray-300', text: 'Ù…Ø±ØªØ¬Ø¹' }
            };
            return statuses[status] || { class: 'px-3 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800 border border-gray-300', text: status };
        };


        // ==========================================
        // Ù…Ù†Ø·Ù‚ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ (Product Form Logic) - Ù…Ø¹ Firebase
        // ==========================================

        let currentProductId = null; // Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø¶ÙŠÙ Ø£Ùˆ Ù†Ø¹Ø¯Ù„
        let currentGeneralImages = []; // { id: '...', url: 'base64...' }
        let currentColorSpecificData = {}; // { "#ffffff": { images: [], sizes: [] } }
        let currentSelectedColors = []; // [ { name: "White", hex: "#ffffff" } ]

        const PREDEFINED_COLORS = [
             { name: "White", hex: "#FFFFFF" }, { name: "Black", hex: "#000000" }, { name: "Red", hex: "#FF0000" },
             { name: "Green", hex: "#008000" }, { name: "Blue", hex: "#0000FF" }, { name: "Yellow", hex: "#FFFF00" },
             { name: "Purple", hex: "#800080" }, { name: "Pink", hex: "#FFC0CB" }, { name: "Orange", hex: "#FFA500" },
             { name: "Brown", hex: "#A52A2A" }, { name: "Gray", hex: "#808080" }, { name: "Beige", hex: "#F5F5DC" },
             // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯
         ];
        const SIZES = ['STANDARD', 'S', 'M', 'L', 'XL', 'XXL', 'XXXL']; // Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©

        // 1. Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„ÙÙˆØ±Ù… (Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„) - ØªØ­ØªØ§Ø¬ Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ¹Ø¯ÙŠÙ„
        const renderProductForm = async (productIdOrNull = null) => {
            const pageEl = document.getElementById('page-admin-product-form');
             if (!pageEl) return;
             pageEl.innerHTML = '<div class="flex justify-center items-center h-64"><div class="loader"></div></div>'; // Loader

            let productToEdit = null;
            currentProductId = productIdOrNull; // Set current ID for saving later

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
            currentGeneralImages = [];
            currentColorSpecificData = {};
            currentSelectedColors = [];

            if (currentProductId) {
                 // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ - Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Firestore
                 try {
                     const productRef = doc(db, 'products', currentProductId);
                     const productSnap = await getDoc(productRef);
                     if (productSnap.exists()) {
                         productToEdit = { ...productSnap.data(), id: productSnap.id };
                     } else {
                         showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„.', 'error');
                         goTo('#/admin/products');
                         return;
                     }
                 } catch (error) {
                     console.error("Error fetching product to edit:", error);
                     showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬.', 'error');
                     goTo('#/admin/products');
                     return;
                 }
            }

             // --- Ø¨Ù†Ø§Ø¡ HTML Ù„Ù„ÙÙˆØ±Ù… (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø·ÙˆÙŠÙ„ Ù‡Ù†Ø§) ---
             // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ØŒ Ø³Ø£Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø·ÙÙŠÙØ© Ø¬Ø¯Ø§Ù‹
             pageEl.innerHTML = `
                 <form id="product-form" class="space-y-6">
                      <div class="flex justify-between items-center mb-6 pb-4 border-b">
                           <h1 id="product-form-title" class="text-2xl lg:text-3xl font-bold text-gray-900">${productToEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯'}</h1>
                           <div>
                                <a href="#/admin/products" class="text-gray-600 hover:text-gray-900 mr-4 transition-colors">Ø¥Ù„ØºØ§Ø¡</a>
                                <button type="submit" id="save-product-btn" class="bg-blue-600 text-white py-2 px-5 rounded-md font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-600 transition-colors inline-flex items-center justify-center">
                                     <span class="btn-text">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</span>
                                     <div class="loader btn-loader hidden ml-2" style="width: 20px; height:20px; border-width: 3px;"></div>
                                </button>
                           </div>
                      </div>

                      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                           <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù† (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ) -->
                           <div class="lg:col-span-2 space-y-6">
                               <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
                               <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                                   <h3 class="text-lg font-semibold mb-4 text-gray-800">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                                    <div class="mb-4">
                                        <label for="product-title" class="block text-sm font-medium text-gray-700 mb-1">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ <span class="text-red-600">*</span></label>
                                        <input type="text" id="product-title" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                                    </div>
                                    <div>
                                        <label for="product-description" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙˆØµÙ</label>
                                        <textarea id="product-description" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                                    </div>
                               </div>

                               <!-- Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¹Ø§Ù…Ø© -->
                               <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                                   <h3 class="text-lg font-semibold mb-3 text-gray-800">Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
                                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-3 mb-3 rounded-r-md text-sm" role="alert">
                                         <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ± ÙƒØ¨ÙŠØ§Ù†Ø§Øª Base64 Ù…Ø¨Ø§Ø´Ø±Ø©. Ù‡Ø°Ø§ Ù‚Ø¯ ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø¨Ø·Ø¡ ÙˆØ¨Ù„ÙˆØº Ø­Ø¯ÙˆØ¯ Ø­Ø¬Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙÙŠ Firestore Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª. Ø§Ù„Ø­Ù„ Ø§Ù„Ø£Ù…Ø«Ù„ Ù‡Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase Storage (ØºÙŠØ± Ù…Ø·Ø¨Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹).
                                    </div>
                                   <div id="general-image-dropzone" class="border-2 border-dashed border-gray-300 rounded-md p-6 text-center hover:border-blue-500 transition-colors">
                                       <label for="general-image-upload" class="cursor-pointer">
                                           <i data-lucide="upload-cloud" class="w-10 h-10 text-gray-400 mx-auto mb-2"></i>
                                           <span class="text-blue-600 font-medium">Ø§Ø®ØªØ± ØµÙˆØ±Ù‹Ø§</span>
                                           <p class="text-xs text-gray-500 mt-1">Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡Ø§ ÙˆØ£ÙÙ„ØªÙ‡Ø§ Ù‡Ù†Ø§ (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 5MB Ù„Ù„ØµÙˆØ±Ø©)</p>
                                           <input type="file" id="general-image-upload" multiple class="hidden" accept="image/*">
                                       </label>
                                   </div>
                                   <div id="general-image-preview" class="mt-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                                       <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ù‡Ù†Ø§ -->
                                   </div>
                               </div>

                               <!-- Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ù‚Ø§Ø³Ø§Øª) -->
                               <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                                   <h3 class="text-lg font-semibold mb-4 text-gray-800">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Variants)</h3>
                                   <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
                                   <div class="mb-5">
                                       <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
                                       <div id="color-picker-container" class="flex flex-wrap gap-3 items-center">
                                           <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù‡Ù†Ø§ -->
                                       </div>
                                       <div class="mt-3">
                                           <label for="custom-color-input" class="inline-flex items-center space-x-2 space-x-reverse text-sm text-gray-600 cursor-pointer hover:text-blue-600">
                                                <input type="color" id="custom-color-input" class="w-7 h-7 border-none p-0 cursor-pointer rounded-full shadow" title="Ø§Ø®ØªØ± Ù„ÙˆÙ† Ù…Ø®ØµØµ">
                                                <span>Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† Ù…Ø®ØµØµ</span>
                                           </label>
                                       </div>
                                   </div>

                                   <!-- Ø­Ø§ÙˆÙŠØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù„ÙˆÙ† -->
                                   <div id="color-variant-managers" class="space-y-5 mt-6 pt-5 border-t border-gray-200">
                                       <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù…Ø¯ÙŠØ± ÙƒÙ„ Ù„ÙˆÙ† Ù‡Ù†Ø§ -->
                                   </div>
                               </div>
                           </div>

                           <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø± (Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ) -->
                           <div class="lg:col-span-1 space-y-6">
                               <!-- Ø§Ù„ØªØ³Ø¹ÙŠØ± ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† -->
                               <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                                   <h3 class="text-lg font-semibold mb-4 text-gray-800">Ø§Ù„ØªØ³Ø¹ÙŠØ± ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
                                   <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø£Ù„ÙˆØ§Ù†) -->
                                   <div id="variants-table-container" class="hidden">
                                       <p class="text-xs text-gray-500 mb-3">Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± ÙˆÙƒÙ…ÙŠØ© ÙƒÙ„ Ù…ØªØºÙŠØ± Ù…ØªØ§Ø­.</p>
                                       <div class="overflow-x-auto max-h-96">
                                           <table class="min-w-full text-sm border-collapse border border-gray-200">
                                               <thead class="bg-gray-100 sticky top-0">
                                                   <tr>
                                                       <th class="p-2 text-right border border-gray-200">Ø§Ù„Ù…ØªØºÙŠØ±</th>
                                                       <th class="p-2 text-right border border-gray-200">Ø§Ù„Ø³Ø¹Ø± (Ø¯Ø¬) <span class="text-red-600">*</span></th>
                                                       <th class="p-2 text-right border border-gray-200">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† <span class="text-red-600">*</span></th>
                                                   </tr>
                                               </thead>
                                               <tbody id="variants-table-body" class="divide-y divide-gray-200">
                                                   <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„ØµÙÙˆÙ Ù‡Ù†Ø§ -->
                                                   <tr><td colspan="3" class="p-3 text-center text-gray-500 text-xs">Ø§Ø®ØªØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.</td></tr>
                                               </tbody>
                                           </table>
                                       </div>
                                   </div>
                                   <!-- ØªØ³Ø¹ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¨Ø³ÙŠØ· (ÙŠØ¸Ù‡Ø± Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£Ù„ÙˆØ§Ù†) -->
                                   <div id="simple-pricing-container" class="space-y-4">
                                        <div>
                                            <label for="simple-price" class="block text-sm font-medium text-gray-700 mb-1">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø¯Ø¬) <span class="text-red-600">*</span></label>
                                            <input type="number" id="simple-price" step="0.01" min="0" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        </div>
                                        <div>
                                            <label for="simple-stock" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† <span class="text-red-600">*</span></label>
                                            <input type="number" id="simple-stock" min="0" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        </div>
                                   </div>
                               </div>
                           </div>
                      </div>
                 </form>
             `;

             // --- Ù…Ù„Ø¡ Ø§Ù„ÙÙˆØ±Ù… Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) ---
             const titleInput = document.getElementById('product-title');
             const descInput = document.getElementById('product-description');
             if (productToEdit) {
                  titleInput.value = productToEdit.title || '';
                  descInput.value = productToEdit.description || '';
                  currentGeneralImages = [...(productToEdit.generalImages || [])];
                  currentColorSpecificData = JSON.parse(JSON.stringify(productToEdit.variantSpecificData || {}));
                  currentSelectedColors = [...(productToEdit.product_options?.find(opt => opt.name === 'Couleur')?.values.map(v => ({name: v.value, hex: v.hex_code})) || [])];
             }

             // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù„Ù„ÙÙˆØ±Ù… Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
             renderImagePreview('#general-image-preview', currentGeneralImages, 'general');
             renderColorPicker();
             renderColorVariantManagers(); // Ø³ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ currentSelectedColors
             updatePricingUI(); // Ø³ÙŠØ¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø£Ùˆ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø¨Ø³ÙŠØ· ÙˆÙŠÙ…Ù„Ø§Ù’ Ø§Ù„Ù‚ÙŠÙ…

             // --- Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„ÙÙˆØ±Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
             const newForm = document.getElementById('product-form');
             newForm?.addEventListener('submit', handleProductFormSubmit);
             document.getElementById('general-image-upload')?.addEventListener('change', (e) => handleImageUpload(e, 'general'));
             document.getElementById('custom-color-input')?.addEventListener('change', handleAddCustomColor);

             // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             }
        };

        // 2. Ø¹Ø±Ø¶ Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£Ù„ÙˆØ§Ù† - ÙƒÙ…Ø§ Ù‡ÙŠ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
        const renderColorPicker = () => {
             const container = document.getElementById('color-picker-container');
             if (!container) return;
             const selectedHex = new Set(currentSelectedColors.map(c => c.hex));

             container.innerHTML = PREDEFINED_COLORS.map(color => `
                 <button type="button" class="color-swatch ${selectedHex.has(color.hex) ? 'selected' : ''}" style="background-color: ${color.hex};" data-color-hex="${color.hex}" data-color-name="${color.name}" title="${color.name}">
                     ${selectedHex.has(color.hex) ? `<i data-lucide="check" class="w-4 h-4 pointer-events-none" style="color: ${['#FFFFFF', '#FFFF00'].includes(color.hex) ? '#000' : '#FFF'};"></i>` : ''}
                 </button>
             `).join('');

             // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø®ØµØµØ© Ø§Ù„ØªÙŠ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§ (Ø¥Ù† ÙˆØ¬Ø¯Øª)
             currentSelectedColors.filter(c => !PREDEFINED_COLORS.find(p => p.hex === c.hex)).forEach(color => {
                 container.innerHTML += `
                     <button type="button" class="color-swatch selected" style="background-color: ${color.hex};" data-color-hex="${color.hex}" data-color-name="${color.name}" title="${color.name}">
                         <i data-lucide="check" class="w-4 h-4 pointer-events-none" style="color: ${calculateContrastColor(color.hex)};"></i>
                     </button>
                 `;
             });

             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             }

             // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ù„ÙˆØ§Ù†
             container.querySelectorAll('.color-swatch').forEach(swatch => {
                 swatch.addEventListener('click', (e) => {
                     e.preventDefault();
                     const hex = e.currentTarget.dataset.colorHex;
                     const name = e.currentTarget.dataset.colorName;
                     toggleColor({ name, hex });
                 });
             });
        };

        // Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ù„ÙˆÙ† Ø§Ù„ØªØ¨Ø§ÙŠÙ† - ÙƒÙ…Ø§ Ù‡ÙŠ
        const calculateContrastColor = (hex) => {
             if (!hex || hex.length < 7) return '#ffffff'; // Added length check
             try {
                  const r = parseInt(hex.slice(1, 3), 16);
                  const g = parseInt(hex.slice(3, 5), 16);
                  const b = parseInt(hex.slice(5, 7), 16);
                  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                  return luminance > 0.5 ? '#000000' : '#ffffff';
             } catch (e) {
                  console.error("Error calculating contrast color for:", hex, e);
                  return '#ffffff';
             }
        };

        // 3. Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† Ù…Ø®ØµØµ - ÙƒÙ…Ø§ Ù‡ÙŠ
        const handleAddCustomColor = (e) => {
             const hex = e.target.value.toUpperCase(); // Ensure uppercase hex
             const name = `Ù„ÙˆÙ† Ù…Ø®ØµØµ ${hex}`;
             const exists = currentSelectedColors.some(c => c.hex === hex) || PREDEFINED_COLORS.some(c => c.hex === hex);
             if (!exists) {
                 toggleColor({ name, hex });
             } else {
                 showToast('Ù‡Ø°Ø§ Ø§Ù„Ù„ÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.', 'info');
             }
        };

        // 4. ØªØ¨Ø¯ÙŠÙ„ (Ø¥Ø¶Ø§ÙØ©/Ø¥Ø²Ø§Ù„Ø©) Ù„ÙˆÙ† - ÙƒÙ…Ø§ Ù‡ÙŠ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
        const toggleColor = (color) => {
             const index = currentSelectedColors.findIndex(c => c.hex === color.hex);
             if (index > -1) {
                 // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø²Ø§Ù„Ø©
                 showModal(`
                     <div class="p-4 text-center">
                          <i data-lucide="alert-triangle" class="w-16 h-16 text-yellow-500 mx-auto mb-4"></i>
                          <h3 class="text-lg font-semibold mb-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø²Ø§Ù„Ø©</h3>
                          <p class="text-gray-600 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù„ÙˆÙ† "${color.name}" ÙˆÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ (Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…Ù‚Ø§Ø³Ø§Øª)ØŸ</p>
                          <div class="flex justify-center space-x-4 space-x-reverse">
                              <button id="confirm-remove-color" class="bg-red-600 text-white py-2 px-5 rounded-md font-medium hover:bg-red-700 transition-colors">
                                  Ù†Ø¹Ù…ØŒ Ø¥Ø²Ø§Ù„Ø©
                              </button>
                              <button class="modal-close-btn bg-gray-200 text-gray-800 py-2 px-5 rounded-md font-medium hover:bg-gray-300 transition-colors">
                                  Ø¥Ù„ØºØ§Ø¡
                              </button>
                          </div>
                      </div>
                 `);
                  document.getElementById('confirm-remove-color').onclick = () => {
                      currentSelectedColors.splice(index, 1);
                      delete currentColorSpecificData[color.hex];
                      hideModal();
                      refreshProductFormUI(); // ØªØ­Ø¯ÙŠØ« ÙƒØ§Ù…Ù„ Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙÙˆØ±Ù…
                  };
             } else {
                 // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„ÙˆÙ†
                 currentSelectedColors.push(color);
                 if (!currentColorSpecificData[color.hex]) {
                     currentColorSpecificData[color.hex] = { images: [], sizes: [] };
                 }
                 refreshProductFormUI(); // ØªØ­Ø¯ÙŠØ« ÙƒØ§Ù…Ù„ Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙÙˆØ±Ù…
             }
        };

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙÙˆØ±Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ - ÙƒÙ…Ø§ Ù‡ÙŠ
        const refreshProductFormUI = () => {
             renderColorPicker();
             renderColorVariantManagers();
             updatePricingUI();
        };

        // 5. Ø¹Ø±Ø¶ Ù…Ø¯ÙŠØ±ÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ù„ÙƒÙ„ Ù„ÙˆÙ†) - ÙƒÙ…Ø§ Ù‡ÙŠ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
        const renderColorVariantManagers = () => {
             const container = document.getElementById('color-variant-managers');
              if (!container) return;

             if (currentSelectedColors.length === 0) {
                 container.innerHTML = '<p class="text-sm text-center text-gray-500 py-4">Ø§Ø®ØªØ± Ù„ÙˆÙ†Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø¯Ø§Ø±Ø© ØµÙˆØ±Ù‡ ÙˆÙ…Ù‚Ø§Ø³Ø§ØªÙ‡.</p>';
                 return;
             }

             // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù‚ÙŠÙ… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ø¤Ù‚ØªØ©
             const tempVariantData = {};
             document.querySelectorAll('#variants-table-body tr[data-variant-key]').forEach(row => {
                 const key = row.dataset.variantKey;
                 tempVariantData[key] = {
                     price: row.querySelector('[data-variant-input="price"]')?.value, // Added safe navigation
                     stock: row.querySelector('[data-variant-input="stock"]')?.value // Added safe navigation
                 };
             });


             container.innerHTML = currentSelectedColors.map(color => {
                 const data = currentColorSpecificData[color.hex] || { images: [], sizes: [] };
                 return `
                     <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
                         <div class="flex justify-between items-center p-3 bg-gray-50 border-b border-gray-200" style="border-right: 4px solid ${color.hex};">
                             <h4 class="font-semibold text-gray-700">Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„ÙˆÙ†: ${color.name} (${color.hex})</h4>
                             <button type="button" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100" data-remove-color="${color.hex}" title="Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ù„ÙˆÙ† ÙˆÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡">
                                 <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                             </button>
                         </div>
                         <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                             <!-- Ù‚Ø³Ù… Ø§Ù„ØµÙˆØ± Ù„Ù„ÙˆÙ† -->
                             <div>
                                 <h5 class="text-sm font-medium text-gray-700 mb-2">ØµÙˆØ± Ù‡Ø°Ø§ Ø§Ù„Ù„ÙˆÙ†</h5>
                                 <label class="border-2 border-dashed border-gray-300 rounded-md p-4 text-center block cursor-pointer text-blue-600 hover:border-blue-500 hover:bg-blue-50 transition-colors text-sm">
                                      <i data-lucide="image-plus" class="w-6 h-6 mx-auto mb-1 text-gray-400"></i>
                                     + Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±
                                     <input type="file" class="hidden" multiple accept="image/*" data-color-hex-upload="${color.hex}">
                                 </label>
                                 <div class="mt-4 grid grid-cols-3 gap-3" data-image-preview-for="${color.hex}">
                                     ${data.images.map((img, index) => `
                                         <div class="relative group image-preview-item">
                                             <img src="${img.url}" class="w-full h-24 object-cover rounded-md border border-gray-200">
                                             <button type="button" class="remove-image-btn" data-remove-image="${color.hex}" data-image-id="${img.id}">
                                                 <i data-lucide="x" class="w-4 h-4 pointer-events-none"></i>
                                             </button>
                                         </div>
                                     `).join('')}
                                      ${data.images.length === 0 ? '<p class="col-span-3 text-xs text-center text-gray-400">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ØµÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ù„ÙˆÙ†.</p>' : ''}
                                 </div>
                             </div>
                             <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ù„Ù„ÙˆÙ† -->
                             <div>
                                 <h5 class="text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù„ÙˆÙ†</h5>
                                 <div class="flex flex-wrap gap-2">
                                     ${SIZES.map(size => `
                                         <button type="button" class="size-tag ${data.sizes?.includes(size) ? 'selected' : ''}" data-size="${size}" data-color-hex-size="${color.hex}">
                                             ${size}
                                         </button>
                                     `).join('')}
                                 </div>
                                  ${SIZES.length === 0 ? '<p class="text-xs text-gray-400 mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ø³Ø§Øª Ù…Ø­Ø¯Ø¯Ø©.</p>' : ''}
                             </div>
                         </div>
                     </div>
                 `;
             }).join('');

             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             }

             // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
             container.querySelectorAll('[data-remove-color]').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.preventDefault();
                     const hex = e.currentTarget.dataset.removeColor;
                     const color = currentSelectedColors.find(c => c.hex === hex);
                     if (color) toggleColor(color); // toggleColor now handles confirmation
                 });
             });

             container.querySelectorAll('[data-color-hex-upload]').forEach(input => {
                 input.addEventListener('change', (e) => handleImageUpload(e, e.currentTarget.dataset.colorHexUpload));
             });

             container.querySelectorAll('[data-remove-image]').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.preventDefault();
                     const hex = e.currentTarget.dataset.removeImage;
                     const imgId = e.currentTarget.dataset.imageId;
                      if(currentColorSpecificData[hex]) {
                          currentColorSpecificData[hex].images = currentColorSpecificData[hex].images.filter(img => img.id != imgId);
                           // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ù…Ø¯ÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù„ÙˆÙ† ÙÙ‚Ø·
                           renderSingleColorVariantManager(hex);
                      }
                 });
             });

             container.querySelectorAll('[data-color-hex-size]').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.preventDefault();
                     const hex = e.currentTarget.dataset.colorHexSize;
                     const size = e.currentTarget.dataset.size;
                      if(currentColorSpecificData[hex]) {
                          const sizes = currentColorSpecificData[hex].sizes || [];
                          const sizeIndex = sizes.indexOf(size);
                          if (sizeIndex > -1) {
                              sizes.splice(sizeIndex, 1); // Remove size
                          } else {
                              sizes.push(size); // Add size
                              sizes.sort((a, b) => SIZES.indexOf(a) - SIZES.indexOf(b)); // Keep order consistent
                          }
                          currentColorSpecificData[hex].sizes = sizes;
                          e.currentTarget.classList.toggle('selected');
                          updateVariantsTable(tempVariantData); // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…
                      }
                 });
             });
              // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚ÙŠÙ… Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
             updateVariantsTable(tempVariantData);
        };

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ù…Ø¯ÙŠØ± Ù…ØªØºÙŠØ±Ø§Øª Ù„ÙˆÙ† ÙˆØ§Ø­Ø¯ - ÙƒÙ…Ø§ Ù‡ÙŠ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
        const renderSingleColorVariantManager = (hex) => {
             const managerDiv = document.querySelector(`[style*="border-right: 4px solid ${hex}"]`)?.closest('.border.border-gray-200');
              if (!managerDiv) return;

             const color = currentSelectedColors.find(c => c.hex === hex);
             if (!color) return; // Should not happen if div exists

             const data = currentColorSpecificData[color.hex] || { images: [], sizes: [] };

             // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…Ù‚Ø§Ø³Ø§Øª ÙÙ‚Ø· Ù„Ù‡Ø°Ø§ Ø§Ù„Ù„ÙˆÙ†
             const imagePreviewContainer = managerDiv.querySelector(`[data-image-preview-for="${hex}"]`);
             const sizeContainer = managerDiv.querySelector(`[data-color-hex-size="${hex}"]`)?.parentElement; // Get the flex container

             if (imagePreviewContainer) {
                 imagePreviewContainer.innerHTML = data.images.map((img, index) => `
                     <div class="relative group image-preview-item">
                         <img src="${img.url}" class="w-full h-24 object-cover rounded-md border border-gray-200">
                         <button type="button" class="remove-image-btn" data-remove-image="${color.hex}" data-image-id="${img.id}">
                             <i data-lucide="x" class="w-4 h-4 pointer-events-none"></i>
                         </button>
                     </div>
                 `).join('') + (data.images.length === 0 ? '<p class="col-span-3 text-xs text-center text-gray-400">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ØµÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ù„ÙˆÙ†.</p>' : '');

                  // Re-attach listeners for remove buttons within this specific preview
                  imagePreviewContainer.querySelectorAll('[data-remove-image]').forEach(btn => {
                      btn.addEventListener('click', (e) => {
                          e.preventDefault();
                          const currentHex = e.currentTarget.dataset.removeImage;
                          const imgId = e.currentTarget.dataset.imageId;
                          if(currentColorSpecificData[currentHex]) {
                              currentColorSpecificData[currentHex].images = currentColorSpecificData[currentHex].images.filter(img => img.id != imgId);
                              renderSingleColorVariantManager(currentHex); // Re-render this section again
                          }
                      });
                  });
             }

             if (sizeContainer) {
                  sizeContainer.innerHTML = SIZES.map(size => `
                      <button type="button" class="size-tag ${data.sizes?.includes(size) ? 'selected' : ''}" data-size="${size}" data-color-hex-size="${color.hex}">
                          ${size}
                      </button>
                  `).join('');
                  // Re-attach listeners for size buttons within this specific container
                  sizeContainer.querySelectorAll('[data-color-hex-size]').forEach(btn => {
                      btn.addEventListener('click', (e) => {
                           e.preventDefault();
                           const currentHex = e.currentTarget.dataset.colorHexSize;
                           const currentSize = e.currentTarget.dataset.size;
                            if(currentColorSpecificData[currentHex]) {
                                const sizes = currentColorSpecificData[currentHex].sizes || [];
                                const sizeIndex = sizes.indexOf(currentSize);
                                if (sizeIndex > -1) sizes.splice(sizeIndex, 1);
                                else {
                                     sizes.push(currentSize);
                                     sizes.sort((a, b) => SIZES.indexOf(a) - SIZES.indexOf(b));
                                }
                                currentColorSpecificData[currentHex].sizes = sizes;
                                e.currentTarget.classList.toggle('selected');

                                // Preserve existing table data before updating
                                const tempVariantData = {};
                                 document.querySelectorAll('#variants-table-body tr[data-variant-key]').forEach(row => {
                                     const key = row.dataset.variantKey;
                                     tempVariantData[key] = {
                                         price: row.querySelector('[data-variant-input="price"]')?.value,
                                         stock: row.querySelector('[data-variant-input="stock"]')?.value
                                     };
                                 });
                                updateVariantsTable(tempVariantData);
                            }
                      });
                  });
             }
              if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
              }
        };

        // 6. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± - ÙƒÙ…Ø§ Ù‡ÙŠ
        const handleImageUpload = (event, type) => {
            const files = event.target.files;
            if (!files) return;

            const MAX_SIZE = 5 * 1024 * 1024; // 5MB limit per image

            for (const file of files) {
                 if (file.size > MAX_SIZE) {
                     showToast(`Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ${file.name} ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (5MB).`, 'error');
                     continue; // Skip this file
                 }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const url = e.target.result; // Base64 Data URL
                    const id = Date.now() + '-' + Math.random().toString(36).substring(2, 9); // Unique ID
                    const image = { id, url };

                    if (type === 'general') {
                        currentGeneralImages.push(image);
                        renderImagePreview('#general-image-preview', currentGeneralImages, 'general');
                    } else { // type is hex
                        if(currentColorSpecificData[type]) {
                            currentColorSpecificData[type].images.push(image);
                             renderSingleColorVariantManager(type); // Update specific color manager
                        }
                    }
                };
                 reader.onerror = (error) => {
                     console.error("FileReader error: ", error);
                     showToast(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ${file.name}.`, 'error');
                 };
                reader.readAsDataURL(file);
            }

            // Reset input field
            event.target.value = null;
        };

        // 7. Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØµØºØ±Ø© - ÙƒÙ…Ø§ Ù‡ÙŠ
        const renderImagePreview = (containerSelector, images, type) => {
             const container = document.querySelector(containerSelector);
             if (!container) return;

             container.innerHTML = images.map(img => `
                 <div class="relative group image-preview-item">
                     <img src="${img.url}" class="w-full h-24 object-cover rounded-md border border-gray-200">
                     <button type="button" class="remove-image-btn" data-remove-image-id="${img.id}" data-type="${type}" title="Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©">
                         <i data-lucide="x" class="w-4 h-4 pointer-events-none"></i>
                     </button>
                 </div>
             `).join('');
             // Message if list is empty
              if (images.length === 0 && type === 'general') {
                  container.innerHTML = '<p class="col-span-full text-xs text-center text-gray-400 py-4">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ØµÙˆØ± Ø¹Ø§Ù…Ø©.</p>';
              } else if (images.length === 0) {
                  // Message for color manager is in renderSingleColorVariantManager
              }


             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             }

             // Re-attach delete listeners for this container only
             container.querySelectorAll('[data-remove-image-id]').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.preventDefault();
                     const id = e.currentTarget.dataset.removeImageId;
                     const imgType = e.currentTarget.dataset.type;

                     if (imgType === 'general') {
                         currentGeneralImages = currentGeneralImages.filter(img => img.id != id);
                         renderImagePreview('#general-image-preview', currentGeneralImages, 'general'); // Re-render only general previews
                     } else { // imgType is hex
                          if(currentColorSpecificData[imgType]) {
                              currentColorSpecificData[imgType].images = currentColorSpecificData[imgType].images.filter(img => img.id != id);
                               renderSingleColorVariantManager(imgType); // Re-render specific color manager
                          }
                     }
                 });
             });
        };

        // 8. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ± - Ù…Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ù‚ÙŠÙ… Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        const updatePricingUI = () => {
            const hasVariants = currentSelectedColors.length > 0;
            const tableContainer = document.getElementById('variants-table-container');
            const simpleContainer = document.getElementById('simple-pricing-container');

             if (!tableContainer || !simpleContainer) return;

             tableContainer.classList.toggle('hidden', !hasVariants);
             simpleContainer.classList.toggle('hidden', hasVariants);

            let tempVariantData = {}; // To store values to fill table/simple fields

             // If editing, try to get existing values from product data
             if (currentProductId) {
                  const product = state.products.find(p => p.id == currentProductId);
                  if (product && product.variants) {
                       if (product.variants.length === 1 && product.variants[0].is_default && !hasVariants) {
                            // Simple product being edited
                            tempVariantData['simple'] = {
                                 price: product.variants[0].price || '',
                                 stock: product.variants[0].stock_quantity || ''
                            };
                       } else {
                            // Product with variants being edited
                            product.variants.forEach(variant => {
                                 const colorName = variant.options?.Couleur;
                                 const sizeName = variant.options?.Taille;
                                 const color = product.product_options?.find(opt => opt.name === 'Couleur')
                                                            ?.values.find(v => v.value === colorName);
                                 if (color) {
                                      const key = `${color.hex_code}|${sizeName || ''}`;
                                      tempVariantData[key] = {
                                           price: variant.price || '',
                                           stock: variant.stock_quantity ?? '' // Use ?? for 0 stock
                                      };
                                 }
                            });
                       }
                  }
             }


            if (hasVariants) {
                 // Preserve currently entered table data if it exists (overrides fetched data)
                 document.querySelectorAll('#variants-table-body tr[data-variant-key]').forEach(row => {
                      const key = row.dataset.variantKey;
                      const currentPrice = row.querySelector('[data-variant-input="price"]')?.value;
                      const currentStock = row.querySelector('[data-variant-input="stock"]')?.value;
                      if (currentPrice || currentStock) { // Only override if user entered something
                           tempVariantData[key] = { price: currentPrice, stock: currentStock };
                      }
                 });
                 updateVariantsTable(tempVariantData);
            } else {
                 // Fill simple fields if editing simple or just cleared variants
                 document.getElementById('simple-price').value = tempVariantData['simple']?.price || '';
                 document.getElementById('simple-stock').value = tempVariantData['simple']?.stock || '';
            }
        };


        // 9. ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† - ÙƒÙ…Ø§ Ù‡ÙŠ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
        const updateVariantsTable = (previousData = {}) => {
             const tableBody = document.getElementById('variants-table-body');
             if (!tableBody) return;

             const generatedVariants = [];
             let showSizeColumn = false;

             currentSelectedColors.forEach(color => {
                 const sizes = currentColorSpecificData[color.hex]?.sizes || [];
                 if (sizes.length > 0) {
                     showSizeColumn = true;
                     sizes.forEach(size => {
                         generatedVariants.push({
                             key: `${color.hex}|${size}`,
                             colorName: color.name,
                             sizeName: size,
                             options: { Couleur: color.name, Taille: size }
                         });
                     });
                 } else {
                     // Color without specific sizes (e.g., STANDARD or only color option)
                     generatedVariants.push({
                         key: `${color.hex}|`, // Empty size part in key
                         colorName: color.name,
                         sizeName: null, // No size name
                         options: { Couleur: color.name }
                     });
                      // Check if ANY color has sizes to determine if size column is needed
                      if (Object.values(currentColorSpecificData).some(data => data.sizes && data.sizes.length > 0)) {
                           showSizeColumn = true;
                      }
                 }
             });

              // Sort variants for consistent order (by color name, then size)
              generatedVariants.sort((a, b) => {
                   if (a.colorName < b.colorName) return -1;
                   if (a.colorName > b.colorName) return 1;
                   // If colors are the same, sort by size index
                   const sizeAIndex = a.sizeName ? SIZES.indexOf(a.sizeName) : -1;
                   const sizeBIndex = b.sizeName ? SIZES.indexOf(b.sizeName) : -1;
                   return sizeAIndex - sizeBIndex;
              });


             // Update table headers
             const thead = tableBody.closest('table')?.querySelector('thead tr');
             if(thead) {
                 const oldSizeTh = thead.querySelector('.size-column');
                 if(oldSizeTh) oldSizeTh.remove(); // Remove if exists

                 if(showSizeColumn) {
                      const sizeTh = document.createElement('th');
                      sizeTh.className = 'p-2 text-right border border-gray-200 size-column';
                      sizeTh.textContent = 'Ø§Ù„Ù…Ù‚Ø§Ø³';
                      thead.children[0].insertAdjacentElement('afterend', sizeTh); // Insert after Color column
                 }
             }

             if (generatedVariants.length === 0) {
                 const colspan = showSizeColumn ? 4 : 3;
                 tableBody.innerHTML = `<tr><td colspan="${colspan}" class="p-3 text-center text-gray-500 text-xs">Ø§Ø®ØªØ± Ù„ÙˆÙ†Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.</td></tr>`;
                 return;
             }

             tableBody.innerHTML = generatedVariants.map(variant => {
                 const prev = previousData[variant.key] || { price: '', stock: ''};
                 const rowContent = `
                      <td class="p-2 align-top border border-gray-200">${variant.colorName}</td>
                      ${showSizeColumn ? `<td class="p-2 align-top border border-gray-200">${variant.sizeName || '-'}</td>` : ''}
                      <td class="p-2 align-top border border-gray-200">
                          <input type="number" data-variant-input="price" value="${prev.price}" class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:border-blue-500 focus:ring-blue-500" placeholder="0.00" required step="0.01" min="0">
                      </td>
                      <td class="p-2 align-top border border-gray-200">
                          <input type="number" data-variant-input="stock" value="${prev.stock}" class="w-full px-2 py-1 border border-gray-300 rounded-md text-xs focus:border-blue-500 focus:ring-blue-500" placeholder="0" required min="0" step="1">
                      </td>
                 `;
                  return `<tr data-variant-key="${variant.key}">${rowContent}</tr>`;
             }).join('');
        };

        // 10. Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ (Submit - Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„) - Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase
        const handleProductFormSubmit = async (e) => {
             e.preventDefault();
             const saveBtn = document.getElementById('save-product-btn');
             const btnText = saveBtn?.querySelector('.btn-text');
             const btnLoader = saveBtn?.querySelector('.btn-loader');

             // Disable button and show loader
             if(saveBtn) saveBtn.disabled = true;
             if(btnText) btnText.classList.add('hidden');
             if(btnLoader) btnLoader.classList.remove('hidden');

             const titleInput = document.getElementById('product-title');
             const descriptionInput = document.getElementById('product-description');

             if (!titleInput.value.trim()) {
                 showToast('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø·Ù„ÙˆØ¨!', 'error');
                 titleInput.focus();
                 if(saveBtn) saveBtn.disabled = false;
                 if(btnText) btnText.classList.remove('hidden');
                 if(btnLoader) btnLoader.classList.add('hidden');
                 return;
             }

             const hasVariants = currentSelectedColors.length > 0;
             const productData = {
                 // ID Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© Firestore Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©ØŒ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… currentProductId Ù„Ù„ØªØ­Ø¯ÙŠØ«
                 title: titleInput.value.trim(),
                 description: descriptionInput.value.trim(),
                 generalImages: currentGeneralImages, // Array of { id, url: base64 }
                 variantImages: {}, // Object: { "#hex": [ { id, url: base64 } ] }
                 variantSpecificData: JSON.parse(JSON.stringify(currentColorSpecificData)), // Store sizes linked to colors
                 product_options: [],
                 variants: [],
                  createdAt: serverTimestamp(), // Add server timestamp
                  updatedAt: serverTimestamp()
             };

             if (hasVariants) {
                 // --- Build options ---
                 productData.product_options.push({
                     name: 'Couleur',
                     values: currentSelectedColors.map(c => ({ value: c.name, hex_code: c.hex }))
                 });
                 const allSizes = [...new Set(Object.values(currentColorSpecificData).flatMap(d => d.sizes || []))];
                  if (allSizes.length > 0) {
                     allSizes.sort((a, b) => SIZES.indexOf(a) - SIZES.indexOf(b)); // Sort sizes
                     productData.product_options.push({
                         name: 'Taille',
                         values: allSizes.map(s => ({ value: s }))
                     });
                 }

                 // --- Build variants ---
                 const variantRows = document.querySelectorAll('#variants-table-body tr[data-variant-key]');
                 if (variantRows.length === 0 && currentSelectedColors.length > 0) {
                     showToast('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙØ§ØµÙŠÙ„ (Ø³Ø¹Ø± ÙˆÙ…Ø®Ø²ÙˆÙ†) Ù„Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©.', 'error');
                     if(saveBtn) saveBtn.disabled = false;
                     if(btnText) btnText.classList.remove('hidden');
                     if(btnLoader) btnLoader.classList.add('hidden');
                     return;
                 }

                 for (const row of variantRows) {
                     const key = row.dataset.variantKey;
                     const priceInput = row.querySelector('[data-variant-input="price"]');
                     const stockInput = row.querySelector('[data-variant-input="stock"]');
                     const price = parseFloat(priceInput.value);
                     const stock = parseInt(stockInput.value);
                     const variantLabel = row.querySelector('td:first-child')?.textContent || `Ù…ØªØºÙŠØ± ${key}`;

                     if (!priceInput.value || isNaN(price) || price < 0) {
                         showToast(`Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ØµØ­ÙŠØ­ Ù„Ù„Ù…ØªØºÙŠØ± ${variantLabel}`, 'error'); priceInput.focus();
                         if(saveBtn) saveBtn.disabled = false;
                         if(btnText) btnText.classList.remove('hidden');
                         if(btnLoader) btnLoader.classList.add('hidden');
                         return;
                     }
                      if (stockInput.value === '' || isNaN(stock) || stock < 0) { // Allow 0 stock, check for empty string
                         showToast(`Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø®Ø²ÙˆÙ† ØµØ­ÙŠØ­ (0 Ø£Ùˆ Ø£ÙƒØ«Ø±) Ù„Ù„Ù…ØªØºÙŠØ± ${variantLabel}`, 'error'); stockInput.focus();
                         if(saveBtn) saveBtn.disabled = false;
                         if(btnText) btnText.classList.remove('hidden');
                         if(btnLoader) btnLoader.classList.add('hidden');
                         return;
                     }

                     const [hex, size] = key.split('|');
                     const colorName = currentSelectedColors.find(c => c.hex === hex)?.name;
                     const options = {};
                     if (colorName) options.Couleur = colorName;
                     if (size) options.Taille = size;

                     productData.variants.push({
                         id: 'v-' + (currentProductId || 'new') + '-' + key.replace('|','-'), // Generate consistent variant ID
                         options: options,
                         price: price,
                         purchase_price: 0, // Placeholder
                         stock_quantity: stock,
                         is_default: false
                     });
                 }
                  // --- Build variant images ---
                 for (const hex of Object.keys(currentColorSpecificData)) {
                      if (currentSelectedColors.some(c => c.hex === hex)) {
                         productData.variantImages[hex] = currentColorSpecificData[hex].images;
                      }
                 }

                 // Set default if only one variant exists
                 if (productData.variants.length === 1) {
                     productData.variants[0].is_default = true;
                 } else if (productData.variants.length > 1) {
                      // Optionally, set the first variant as default if none is explicitly marked
                      const hasDefault = productData.variants.some(v => v.is_default);
                      if (!hasDefault) {
                           productData.variants[0].is_default = true;
                      }
                 }


             } else {
                 // --- Simple product ---
                 const priceInput = document.getElementById('simple-price');
                 const stockInput = document.getElementById('simple-stock');
                 const price = parseFloat(priceInput.value);
                 const stock = parseInt(stockInput.value);

                  if (!priceInput.value || isNaN(price) || price < 0) {
                     showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ØµØ­ÙŠØ­ Ù„Ù„Ù…Ù†ØªØ¬.', 'error'); priceInput.focus();
                     if(saveBtn) saveBtn.disabled = false;
                     if(btnText) btnText.classList.remove('hidden');
                     if(btnLoader) btnLoader.classList.add('hidden');
                     return;
                 }
                  if (stockInput.value === '' || isNaN(stock) || stock < 0) { // Allow 0 stock
                     showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø®Ø²ÙˆÙ† ØµØ­ÙŠØ­ (0 Ø£Ùˆ Ø£ÙƒØ«Ø±) Ù„Ù„Ù…Ù†ØªØ¬.', 'error'); stockInput.focus();
                     if(saveBtn) saveBtn.disabled = false;
                     if(btnText) btnText.classList.remove('hidden');
                     if(btnLoader) btnLoader.classList.add('hidden');
                     return;
                 }

                 productData.variants.push({
                     id: 'v-' + (currentProductId || 'new') + '-default',
                     options: {},
                     price: price,
                     purchase_price: 0,
                     stock_quantity: stock,
                     is_default: true
                 });
                 productData.product_options = [];
                 productData.variantImages = {};
                 productData.variantSpecificData = {};
             }

             // --- Save product to Firestore ---
             try {
                  if (currentProductId) {
                       // Update existing product
                       const productRef = doc(db, 'products', currentProductId);
                       await setDoc(productRef, { ...productData, updatedAt: serverTimestamp() }, { merge: true }); // Use setDoc with merge to update or overwrite
                       showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                  } else {
                       // Add new product
                       const docRef = await addDoc(productsCollection, productData);
                       console.log("Product added with ID: ", docRef.id);
                       showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                  }
                  goTo('#/admin/products');
             } catch (error) {
                  console.error("Error saving product to Firestore:", error);
                  showToast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.', 'error');
                  if(saveBtn) saveBtn.disabled = false;
                  if(btnText) btnText.classList.remove('hidden');
                  if(btnLoader) btnLoader.classList.add('hidden');
             }
        };

        // ==========================================
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Customer Logic) - ÙŠÙ‚Ø±Ø£ Ù…Ù† state (Firestore)
        // ==========================================

        // 1. Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ØªÙ‚Ø±Ø£ Ù…Ù† state.products)
        const renderShopPage = () => {
             const listEl = document.getElementById('product-list');
             const shopLoader = document.getElementById('shop-loader');
             const noProductsMsg = document.getElementById('no-products-message');
             if (!listEl || !shopLoader || !noProductsMsg) return;

             // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ø¥Ù† ÙˆØ¬Ø¯Øª)
             listEl.innerHTML = ''; // Clear previous content

             if (!state.appReady) { // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù… ØªØ­Ù…Ù„ Ø¨Ø¹Ø¯
                  shopLoader.classList.remove('hidden');
                  noProductsMsg.classList.add('hidden');
                  return;
             }

             shopLoader.classList.add('hidden');

             if (state.products.length === 0) {
                  noProductsMsg.innerHTML = `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹. ${isAdmin() ? '<a href="#/admin/products/new" class="text-blue-600 font-medium hover:underline">Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Ù‹</a>' : ''}`;
                  noProductsMsg.classList.remove('hidden');
                 return;
             }

             noProductsMsg.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ù†ØªØ¬Ø§Øª

             state.products.forEach(product => {
                 const defaultVariant = product.variants?.find(v => v.is_default) || product.variants?.[0] || { price: 0 };
                  const firstGeneralImage = product.generalImages?.[0]?.url;
                  const firstVariantImage = Object.values(product.variantImages || {})?.[0]?.[0]?.url;
                  const displayImage = firstGeneralImage || firstVariantImage || 'https://placehold.co/400x400/f1f5f9/a3a3a3?text=No+Image';
                 const hasOptions = (product.product_options?.length || 0) > 0 || (product.variants?.length || 0) > 1;

                 const productCard = document.createElement('div');
                 productCard.className = "group bg-white rounded-lg shadow border border-gray-200 overflow-hidden flex flex-col transition-shadow hover:shadow-md";
                 productCard.innerHTML = `
                     <a href="#/product/${product.id}" class="block overflow-hidden product-card-image-container">
                          <img src="${displayImage}" alt="${product.title || 'Ù…Ù†ØªØ¬'}" loading="lazy">
                     </a>
                     <div class="p-4 flex flex-col flex-grow">
                          <h3 class="text-base font-semibold text-gray-800 truncate mb-1 flex-grow">
                               <a href="#/product/${product.id}" class="hover:text-blue-600 transition-colors">${product.title}</a>
                          </h3>
                          <p class="text-xl font-bold text-gray-900 mt-1 mb-3">${defaultVariant.price?.toLocaleString('fr-DZ')} Ø¯.Ø¬</p>
                          <a href="#/product/${product.id}" class="block w-full mt-auto bg-gray-800 text-white text-center py-2 px-4 rounded-md font-medium text-sm hover:bg-gray-700 transition-colors">
                               ${hasOptions ? 'Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª' : 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„'}
                          </a>
                     </div>
                 `;
                 listEl.appendChild(productCard);
             });
              if (typeof lucide !== 'undefined') { // Render icons (if any were added)
                  lucide.createIcons();
              }
        };

        // 2. Ø¹Ø±Ø¶ ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ (ØªØ¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù…Ù† state.products)
        const renderProductDetailPage = (productId) => {
            const pageEl = document.getElementById('page-product-detail');
            if (!pageEl) return;
             pageEl.innerHTML = '<div class="flex justify-center items-center h-64"><div class="loader"></div></div>'; // Show loader

            const product = state.products.find(p => p.id == productId);

            if (!state.appReady) { // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù… ØªØ­Ù…Ù„ Ø¨Ø¹Ø¯
                 // ÙŠÙ…ÙƒÙ† Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù€ Loader Ø£Ùˆ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„"
                 return;
            }


            if (!product) {
                pageEl.innerHTML = `<div class="bg-white p-6 rounded-lg shadow text-center"><h1 class="text-2xl font-bold text-red-600 mb-4">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬.</h1><a href="#/" class="text-blue-600 hover:underline">&larr; Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</a></div>`;
                return;
            }

            const colorOption = product.product_options?.find(opt => opt.name === 'Couleur');
            const sizeOption = product.product_options?.find(opt => opt.name === 'Taille');
            const hasOptions = colorOption || sizeOption || (product.variants?.length || 0) > 1;

            const initialColorHex = colorOption?.values[0]?.hex_code;
            const variantImages = product.variantImages || {}; // Ensure it's an object
            const generalImages = product.generalImages || []; // Ensure it's an array

            const initialImagesForThumbnails = (initialColorHex && variantImages[initialColorHex]?.length > 0)
                                          ? variantImages[initialColorHex]
                                          : generalImages;

             // Ensure initialImagesForThumbnails is always an array
             const safeInitialImages = Array.isArray(initialImagesForThumbnails) ? initialImagesForThumbnails : [];

             // Find initial main image: first image from the selected/first color, fallback to first general image
             let initialMainImage = 'https://placehold.co/600x600/f1f5f9/a3a3a3?text=No+Image';
             if (safeInitialImages.length > 0) {
                  initialMainImage = safeInitialImages[0].url;
             } else if (generalImages.length > 0) {
                  initialMainImage = generalImages[0].url; // Fallback to general if variant images were empty
             }


            const defaultVariant = product.variants?.find(v => v.is_default) || product.variants?.[0] || { price: 0, stock_quantity: 0 };

            pageEl.innerHTML = `
                <div class="bg-white p-6 md:p-8 rounded-lg shadow-md border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12">
                        <!-- Ù‚Ø³Ù… Ø§Ù„ØµÙˆØ± -->
                        <div>
                            <div class="aspect-w-1 aspect-h-1 bg-gray-100 rounded-lg overflow-hidden mb-4 border border-gray-200">
                                <img id="main-product-image" src="${initialMainImage}" alt="${product.title}" class="w-full h-full object-cover duration-300 ease-in-out">
                            </div>
                            <!-- ØµÙˆØ± Ù…ØµØºØ±Ø© -->
                            <div id="thumbnail-images" class="grid grid-cols-4 gap-2">
                                ${safeInitialImages.map((img, index) => `
                                    <button class="aspect-w-1 aspect-h-1 block rounded-md overflow-hidden border-2 ${index === 0 ? 'border-blue-500' : 'border-transparent'} hover:border-blue-400 focus:outline-none focus:border-blue-500 transition" data-img-url="${img.url}">
                                        <img src="${img.url}" alt="Thumbnail ${index+1}" class="w-full h-full object-cover" loading="lazy">
                                    </button>
                                `).join('')}
                                 <!-- Fallback to general images if variant images were empty initially -->
                                ${safeInitialImages.length === 0 && generalImages.length > 0 ? generalImages.map((img, index) => `
                                     <button class="aspect-w-1 aspect-h-1 block rounded-md overflow-hidden border-2 ${index === 0 ? 'border-blue-500' : 'border-transparent'} hover:border-blue-400 focus:outline-none focus:border-blue-500 transition" data-img-url="${img.url}">
                                         <img src="${img.url}" alt="Thumbnail ${index+1}" class="w-full h-full object-cover" loading="lazy">
                                     </button>
                                `).join('') : ''}
                                 ${safeInitialImages.length === 0 && generalImages.length === 0 ? '<p class="text-xs text-gray-400 col-span-4 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØµØºØ±Ø©</p>' : ''}
                            </div>
                        </div>

                        <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
                        <div class="py-4">
                            <h1 class="text-2xl lg:text-3xl font-bold text-gray-900 mb-3">${product.title}</h1>
                            <p id="product-price" class="text-3xl font-bold text-gray-800 mb-6">${defaultVariant.price?.toLocaleString('fr-DZ')} Ø¯.Ø¬</p>

                            <form id="add-to-cart-form" class="space-y-6">
                                <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
                                ${colorOption ? `
                                    <div>
                                        <h3 class="text-sm font-medium text-gray-900 mb-2">Ø§Ù„Ù„ÙˆÙ†: <span id="selected-color-name" class="font-normal text-gray-600">Ø§Ø®ØªØ± Ù„ÙˆÙ†Ù‹Ø§</span></h3>
                                        <div id="product-color-options" class="flex flex-wrap gap-3">
                                            ${colorOption.values.map(val => `
                                                <button type="button" class="color-swatch" style="background-color: ${val.hex_code};" data-color-name="${val.value}" data-color-hex="${val.hex_code}" title="${val.value}"></button>
                                            `).join('')}
                                        </div>
                                        <input type="hidden" id="selected-color-hex" name="color_hex">
                                    </div>
                                ` : ''}

                                <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª -->
                                ${sizeOption ? `
                                    <div>
                                         <div class="flex justify-between items-center mb-2">
                                             <h3 class="text-sm font-medium text-gray-900">Ø§Ù„Ù…Ù‚Ø§Ø³: <span id="selected-size-name" class="font-normal text-gray-600">Ø§Ø®ØªØ± Ù…Ù‚Ø§Ø³Ù‹Ø§</span></h3>
                                         </div>
                                        <div id="product-size-options" class="flex flex-wrap gap-2">
                                            ${sizeOption.values.map(val => `
                                                <button type="button" class="size-tag" data-size-name="${val.value}" disabled>
                                                    ${val.value}
                                                </button>
                                            `).join('')}
                                        </div>
                                        <input type="hidden" id="selected-size" name="size">
                                    </div>
                                ` : ''}

                                <!-- Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© -->
                                <div class="pt-4">
                                    <p id="stock-message" class="text-sm text-red-600 mb-2 hidden">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©.</p>
                                    <button type="submit" id="add-to-cart-btn" class="w-full bg-gray-900 text-white py-3 px-6 rounded-md font-medium text-lg hover:bg-gray-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 space-x-reverse" ${!hasOptions && (defaultVariant?.stock_quantity ?? 0) > 0 ? '' : 'disabled'}>
                                         <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                         <span>${hasOptions ? 'Ø§Ø®ØªØ± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹' : ((defaultVariant?.stock_quantity ?? 0) > 0 ? 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©' : 'Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ†')}</span>
                                    </button>
                                </div>
                            </form>

                            <!-- Ø§Ù„ÙˆØµÙ -->
                            <div class="mt-8 pt-6 border-t border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900 mb-3">Ø§Ù„ÙˆØµÙ</h3>
                                <div class="text-gray-600 leading-relaxed whitespace-pre-wrap prose prose-sm max-w-none">${product.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬.'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            setupVariantSelector(product); // ØªØ´ØºÙŠÙ„ Ù…Ù†Ø·Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };


        // 3. Ù…Ù†Ø·Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬ - ÙƒÙ…Ø§ Ù‡ÙŠ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ØŒ ØªÙ‚Ø±Ø£ Ù…Ù† product
        const setupVariantSelector = (product) => {
             const form = document.getElementById('add-to-cart-form');
             if (!form) return;

             const colorOption = product.product_options?.find(opt => opt.name === 'Couleur');
             const sizeOption = product.product_options?.find(opt => opt.name === 'Taille');
             const hasOptions = colorOption || sizeOption || (product.variants?.length || 0) > 1;

             const colorButtons = form.querySelectorAll('#product-color-options .color-swatch');
             const sizeButtons = form.querySelectorAll('#product-size-options .size-tag');
             const priceEl = document.getElementById('product-price');
             const stockMsg = document.getElementById('stock-message');
             const addBtn = document.getElementById('add-to-cart-btn');
             const addBtnText = addBtn?.querySelector('span'); // Safe navigation
             const mainImage = document.getElementById('main-product-image');
             const thumbnailContainer = document.getElementById('thumbnail-images');
             const selectedColorNameEl = document.getElementById('selected-color-name');
             const selectedSizeNameEl = document.getElementById('selected-size-name');


             let selectedColor = null; // { name, hex }
             let selectedSize = null; // { name }
              // Find initial default/first variant safely
              let selectedVariant = !hasOptions ? (product.variants?.[0] || null) : null;


             const updateUI = () => {
                 // 1. Find matching variant
                 selectedVariant = null;
                 if (!hasOptions && product.variants?.length > 0) {
                      selectedVariant = product.variants[0];
                 } else if (product.variants) { // Check if variants exist
                     selectedVariant = product.variants.find(v => {
                         const colorMatch = !colorOption || (selectedColor && v.options?.Couleur === selectedColor.name);
                         const sizeMatch = !sizeOption || (selectedSize && v.options?.Taille === selectedSize.name);
                         return colorMatch && sizeMatch;
                     });
                 }


                 // 2. Update price, stock, and button
                  const defaultOrFirstVariant = product.variants?.find(v => v.is_default) || product.variants?.[0];
                  const displayPrice = selectedVariant?.price ?? defaultOrFirstVariant?.price ?? 0;
                  if (priceEl) priceEl.textContent = `${displayPrice.toLocaleString('fr-DZ')} Ø¯.Ø¬`;

                 let canAddToCart = false;
                 let stockMessageText = '';
                 let buttonText = 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©';

                  if (hasOptions && (!selectedColor && colorOption || !selectedSize && sizeOption)) {
                      stockMessageText = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©.';
                      buttonText = 'Ø§Ø®ØªØ± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª';
                  } else if (selectedVariant) {
                      if (selectedVariant.stock_quantity > 0) {
                          stockMessageText = '';
                          canAddToCart = true;
                      } else {
                          stockMessageText = 'Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø±.';
                          buttonText = 'Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ†';
                      }
                  } else if (hasOptions) {
                      stockMessageText = 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø²ÙŠØ¬ Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±.';
                      buttonText = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                  } else if (!selectedVariant && !hasOptions) { // Simple product out of stock (or no variants found)
                       const initialStock = defaultOrFirstVariant?.stock_quantity ?? 0;
                       if (initialStock <=0) {
                            stockMessageText = 'Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬.';
                            buttonText = 'Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ†';
                       } else {
                            // Should not happen if product has a variant, maybe initial loading state?
                            stockMessageText = 'Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹.';
                            buttonText = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
                       }
                  }


                 if (stockMsg) {
                     stockMsg.textContent = stockMessageText;
                     stockMsg.classList.toggle('hidden', !stockMessageText);
                 }
                  if (addBtn) addBtn.disabled = !canAddToCart;
                  if (addBtnText) addBtnText.textContent = buttonText;


                 // 3. Update images based on selected color
                  const variantImages = product.variantImages || {};
                  const generalImages = product.generalImages || [];
                  let imagesToShow = generalImages; // Default to general images
                 if (selectedColor && variantImages[selectedColor.hex]?.length > 0) {
                     imagesToShow = variantImages[selectedColor.hex];
                 }

                  // Ensure imagesToShow is an array
                  const safeImagesToShow = Array.isArray(imagesToShow) ? imagesToShow : generalImages;


                  if (thumbnailContainer) {
                      thumbnailContainer.innerHTML = safeImagesToShow.map((img, index) => `
                          <button class="aspect-w-1 aspect-h-1 block rounded-md overflow-hidden border-2 border-transparent hover:border-blue-400 focus:outline-none focus:border-blue-500 transition" data-img-url="${img.url}">
                              <img src="${img.url}" alt="Thumbnail ${index+1}" class="w-full h-full object-cover pointer-events-none" loading="lazy">
                          </button>
                      `).join('');

                      // Select first thumb
                      const firstThumb = thumbnailContainer.querySelector('button');
                      if (firstThumb) firstThumb.classList.add('border-blue-500');

                      // Add thumb listeners
                      thumbnailContainer.querySelectorAll('button').forEach(thumb => {
                          thumb.addEventListener('click', (e) => {
                              const newUrl = e.currentTarget.dataset.imgUrl;
                              if (mainImage) mainImage.src = newUrl;
                              thumbnailContainer.querySelectorAll('button').forEach(t => t.classList.remove('border-blue-500'));
                              e.currentTarget.classList.add('border-blue-500');
                          });
                      });
                  }

                  // Update main image
                  if (mainImage && safeImagesToShow.length > 0) {
                       // Only update if the current main image isn't already in the new set
                       const currentSrcBase = mainImage.src.split('?')[0]; // Ignore potential query strings
                       const newUrlsBases = safeImagesToShow.map(img => img.url.split('?')[0]);
                       if (!newUrlsBases.includes(currentSrcBase)) {
                            mainImage.src = safeImagesToShow[0].url;
                       }
                  } else if (mainImage && generalImages.length > 0) {
                      // Fallback to first general image if no variant images were found
                      if (!generalImages.map(img => img.url.split('?')[0]).includes(mainImage.src.split('?')[0])) {
                           mainImage.src = generalImages[0].url;
                      }
                  } else if (mainImage) {
                       mainImage.src = 'https://placehold.co/600x600/f1f5f9/a3a3a3?text=No+Image'; // Placeholder
                  }


             };

             // Color selection listener
             colorButtons.forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.preventDefault();
                     colorButtons.forEach(b => {
                          b.classList.remove('selected');
                          b.innerHTML = ''; // Remove checkmark
                     });
                     btn.classList.add('selected');
                      // Add checkmark with correct contrast
                      btn.innerHTML = `<i data-lucide="check" class="w-4 h-4 pointer-events-none" style="color: ${calculateContrastColor(btn.dataset.colorHex)};"></i>`;
                      if (typeof lucide !== 'undefined') { lucide.createIcons(); }

                     selectedColor = { name: btn.dataset.colorName, hex: btn.dataset.colorHex };
                     if (selectedColorNameEl) selectedColorNameEl.textContent = selectedColor.name;

                     // Update available sizes
                     if (sizeOption && product.variants) {
                         sizeButtons.forEach(sizeBtn => {
                             const sizeName = sizeBtn.dataset.sizeName;
                             const isAvailable = product.variants.some(v =>
                                 v.options?.Couleur === selectedColor.name &&
                                 v.options?.Taille === sizeName &&
                                 v.stock_quantity > 0
                             );
                             sizeBtn.disabled = !isAvailable;
                             if (selectedSize && selectedSize.name === sizeName && !isAvailable) {
                                 selectedSize = null;
                                 if (selectedSizeNameEl) selectedSizeNameEl.textContent = 'Ø§Ø®ØªØ± Ù…Ù‚Ø§Ø³Ù‹Ø§';
                                 sizeBtn.classList.remove('selected');
                             } else if (selectedSize && selectedSize.name === sizeName && isAvailable) {
                                 sizeBtn.classList.add('selected'); // Keep selected if still available
                             } else {
                                  sizeBtn.classList.remove('selected'); // Deselect others
                             }
                         });
                          if (!selectedSize && selectedSizeNameEl) selectedSizeNameEl.textContent = 'Ø§Ø®ØªØ± Ù…Ù‚Ø§Ø³Ù‹Ø§';
                     }
                     updateUI();
                 });
             });

             // Size selection listener
             sizeButtons.forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     e.preventDefault();
                     if (btn.disabled) return;
                     sizeButtons.forEach(b => b.classList.remove('selected'));
                     btn.classList.add('selected');
                     selectedSize = { name: btn.dataset.sizeName };
                     if (selectedSizeNameEl) selectedSizeNameEl.textContent = selectedSize.name;
                     updateUI();
                 });
             });

             // Add to cart listener
             form.addEventListener('submit', (e) => {
                 e.preventDefault();
                  // Final validation before adding
                 if (!hasOptions && product.variants?.length > 0) {
                     selectedVariant = product.variants[0];
                 } else {
                      if (colorOption && !selectedColor) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ†.', 'error'); return; }
                      if (sizeOption && !selectedSize) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§Ø³.', 'error'); return; }
                      // Variant should be selected by updateUI if choices are valid
                      if (!selectedVariant) { // Double check if a variant was actually found
                           showToast('Ù‡Ø°Ø§ Ø§Ù„Ù…Ø²ÙŠØ¬ Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹.', 'error');
                           return;
                      }
                 }

                 if (selectedVariant && selectedVariant.stock_quantity > 0) {
                     addItemToCart(product, selectedVariant, 1); // Uses localDb for cart
                 } else if (selectedVariant && selectedVariant.stock_quantity <= 0) {
                     showToast('Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø±.', 'error');
                 } else {
                      showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø®ÙŠØ§Ø±Ø§Øª ØµØ§Ù„Ø­Ø©.', 'error');
                 }
             });

             // Initial UI update and size availability check
             if (!colorOption && sizeOption && product.variants) {
                  sizeButtons.forEach(sizeBtn => {
                      const sizeName = sizeBtn.dataset.sizeName;
                      const isAvailable = product.variants.some(v => v.options?.Taille === sizeName && v.stock_quantity > 0);
                      sizeBtn.disabled = !isAvailable;
                  });
             }
             updateUI(); // Initial UI setup
        };


        // 4. Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø© (ÙŠØ³ØªØ®Ø¯Ù… localDb) - ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø©
        const addItemToCart = (product, variant, quantity) => {
             if (!variant) { showToast('Ø®Ø·Ø£: Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­.', 'error'); return; }

             const stockToCheck = variant.stock_quantity ?? 0; // Handle undefined stock

             if (stockToCheck < quantity) {
                 showToast('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†!', 'error'); return;
             }

             const existingItemIndex = state.cart.findIndex(item => item.variant_id === variant.id);

             if (existingItemIndex > -1) {
                 const existingItem = state.cart[existingItemIndex];
                 const newQty = existingItem.quantity + quantity;
                 if (stockToCheck < newQty) {
                      showToast(`Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ØŒ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù‡Ùˆ ${stockToCheck - existingItem.quantity}.`, 'error'); return;
                 }
                 state.cart[existingItemIndex].quantity = newQty;
             } else {
                  // --- Find image ---
                  let imageUrl = 'https://placehold.co/100x120/f1f5f9/a3a3a3?text=No+Image'; // Placeholder
                  const variantImages = product.variantImages || {};
                  const generalImages = product.generalImages || [];
                  const colorHex = product.product_options?.find(opt => opt.name === 'Couleur')
                                               ?.values.find(v => v.value === variant.options?.Couleur)
                                               ?.hex_code;
                  if (colorHex && variantImages[colorHex]?.length > 0) {
                      imageUrl = variantImages[colorHex][0].url;
                  } else if (generalImages.length > 0) {
                      imageUrl = generalImages[0].url;
                  }

                 const optionsText = Object.entries(variant.options || {})
                                        .map(([key, value]) => value)
                                        .join(' / ');

                 state.cart.push({
                     cartId: variant.id + '-' + Date.now(),
                     variant_id: variant.id,
                     product_id: product.id,
                     title: product.title,
                     price: variant.price,
                     quantity: quantity,
                     image_url: imageUrl,
                     optionsText: optionsText,
                     stock: stockToCheck // Store current stock for checks in cart
                 });
             }

             localDb.set('cart', state.cart); // Save cart to localStorage
             updateCartBadge();
             showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
             if(window.location.hash === '#/cart') {
                 renderCartPage(); // Refresh cart page if currently viewing it
             }
        };

        // 5. ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ù„Ø© (ÙŠÙ‚Ø±Ø£ Ù…Ù† state.cart) - ÙƒÙ…Ø§ Ù‡ÙŠ
        const updateCartBadge = () => {
             const badge = document.getElementById('cart-count-badge');
             if (!badge) return;
             const totalItems = state.cart.reduce((acc, item) => acc + item.quantity, 0);
             badge.textContent = totalItems > 9 ? '9+' : totalItems; // Limit display
             badge.classList.toggle('hidden', totalItems === 0);
        };

        // 6. Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø³Ù„Ø© (ØªÙ‚Ø±Ø£ Ù…Ù† state.cart) - ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ø¹Ø±Ø¶ Loader
        const renderCartPage = () => {
             const pageEl = document.getElementById('page-cart');
             if (!pageEl) return;
             pageEl.innerHTML = ''; // Clear previous listeners and content

             if (state.cart.length === 0) {
                 pageEl.innerHTML = `
                     <div class="text-center bg-white p-10 rounded-lg shadow border border-gray-200">
                         <i data-lucide="shopping-cart" class="w-20 h-20 text-gray-300 mx-auto mb-4"></i>
                         <h2 class="text-2xl font-bold text-gray-800 mb-2">Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ©</h2>
                         <p class="text-gray-500 mb-6">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯.</p>
                         <a href="#/" class="bg-gray-900 text-white py-2 px-6 rounded-md font-medium hover:bg-gray-800 transition-colors inline-block">
                             Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±
                         </a>
                     </div>
                 `;
                 if (typeof lucide !== 'undefined') { lucide.createIcons(); }
                 return;
             }

             const subTotal = state.cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);

             pageEl.innerHTML = `
                 <h1 class="text-2xl lg:text-3xl font-bold text-gray-900 mb-6">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ (${state.cart.reduce((acc, item) => acc + item.quantity, 0)} Ù…Ù†ØªØ¬)</h1>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                     <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
                     <div class="lg:col-span-2 bg-white p-4 sm:p-6 rounded-lg shadow border border-gray-200 space-y-5 divide-y divide-gray-200">
                         ${state.cart.map(item => `
                             <div class="flex items-start sm:items-center pt-5 first:pt-0 flex-col sm:flex-row" data-cart-item-id="${item.cartId}">
                                 <img src="${item.image_url}" alt="${item.title}" class="w-24 h-28 sm:w-20 sm:h-24 object-cover rounded-md border flex-shrink-0 mb-3 sm:mb-0">
                                 <div class="flex-1 mx-0 sm:mx-4 w-full">
                                     <div class="flex justify-between items-start w-full">
                                          <div>
                                              <p class="font-semibold text-gray-900 text-base leading-tight">${item.title}</p>
                                              <p class="text-sm text-gray-500 mt-1">${item.optionsText}</p>
                                          </div>
                                          <p class="font-semibold text-gray-900 text-base sm:hidden">${(item.price * item.quantity).toLocaleString('fr-DZ')} Ø¯.Ø¬</p>
                                     </div>
                                     <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒÙ…ÙŠØ© -->
                                     <div class="flex items-center justify-between sm:justify-start space-x-2 space-x-reverse mt-2">
                                         <div class="inline-flex items-center border border-gray-300 rounded-md">
                                             <button data-action="decrease" class="p-1.5 text-gray-600 hover:bg-gray-100 rounded-r-md disabled:opacity-50 disabled:cursor-not-allowed" ${item.quantity <= 1 ? 'disabled' : ''}>
                                                  <i data-lucide="minus" class="w-4 h-4 pointer-events-none"></i>
                                             </button>
                                             <span class="font-medium w-10 text-center text-sm">${item.quantity}</span>
                                             <button data-action="increase" class="p-1.5 text-gray-600 hover:bg-gray-100 rounded-l-md disabled:opacity-50 disabled:cursor-not-allowed" ${item.quantity >= item.stock ? 'disabled' : ''}>
                                                  <i data-lucide="plus" class="w-4 h-4 pointer-events-none"></i>
                                             </button>
                                         </div>
                                         <button data-action="remove" class="text-xs text-red-600 hover:text-red-800 hover:underline sm:ml-4">
                                             Ø¥Ø²Ø§Ù„Ø©
                                         </button>
                                     </div>
                                      ${item.quantity >= item.stock ? '<p class="text-xs text-red-500 mt-1">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</p>' : ''}
                                 </div>
                                 <div class="text-left flex-shrink-0 hidden sm:block" dir="ltr">
                                     <p class="font-semibold text-gray-900 text-base">${(item.price * item.quantity).toLocaleString('fr-DZ')} Ø¯.Ø¬</p>
                                 </div>
                             </div>
                         `).join('')}
                     </div>

                     <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨ -->
                     <aside class="lg:col-span-1">
                         <div class="bg-white p-6 rounded-lg shadow border border-gray-200 sticky top-24">
                             <h3 class="text-xl font-semibold mb-4 pb-4 border-b text-gray-800">Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3>
                             <div class="space-y-3 text-sm mb-6" dir="ltr">
                                 <div class="flex justify-between">
                                     <span class="text-gray-600">Subtotal</span>
                                     <span class="font-medium text-gray-800">${subTotal.toLocaleString('fr-DZ')} DZD</span>
                                 </div>
                                 <div class="flex justify-between">
                                     <span class="text-gray-600">Shipping</span>
                                     <span class="font-medium text-gray-800">ÙŠÙØ­Ø³Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹</span>
                                 </div>
                                 <div class="flex justify-between text-lg font-bold text-gray-900 mt-4 pt-4 border-t border-gray-300">
                                     <span>Total (Est.)</span>
                                     <span>${subTotal.toLocaleString('fr-DZ')} DZD</span>
                                 </div>
                             </div>
                             <a href="#/checkout" class="block w-full text-center bg-gray-900 text-white py-3 px-6 rounded-md font-medium text-lg hover:bg-gray-800 transition-colors">
                                 Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø¯ÙØ¹
                             </a>
                              <a href="#/" class="block text-center mt-4 text-sm text-blue-600 hover:underline">
                                 Ø£Ùˆ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ³ÙˆÙ‚
                             </a>
                         </div>
                     </aside>
                 </div>
             `;

             if (typeof lucide !== 'undefined') { lucide.createIcons(); }

             // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ù„Ø©
             pageEl.querySelectorAll('[data-cart-item-id]').forEach(itemEl => {
                 const cartId = itemEl.dataset.cartItemId;
                 itemEl.querySelector('[data-action="increase"]')?.addEventListener('click', () => updateCartQuantity(cartId, 1));
                 itemEl.querySelector('[data-action="decrease"]')?.addEventListener('click', () => updateCartQuantity(cartId, -1));
                 itemEl.querySelector('[data-action="remove"]')?.addEventListener('click', () => removeFromCart(cartId));
             });
        };

        // 7. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø© (ÙŠØ³ØªØ®Ø¯Ù… localDb) - ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        const updateCartQuantity = (cartId, change) => {
             const itemIndex = state.cart.findIndex(item => item.cartId === cartId);
             if (itemIndex === -1) return;

             const item = state.cart[itemIndex];
             const newQty = item.quantity + change;

             if (newQty < 1) {
                 removeFromCart(cartId); // Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
                 return;
             }

             // Use the stock stored in the cart item itself
             const currentStock = item.stock ?? 0; // Use stock saved when added

             if (newQty > currentStock) {
                 showToast(`Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (${currentStock})!`, 'error');
                 return;
             }

             state.cart[itemIndex].quantity = newQty;
             localDb.set('cart', state.cart);
             updateCartBadge();
             renderCartPage(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±
        };

        // 8. Ø¥Ø²Ø§Ù„Ø© Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ù„Ø© (ÙŠØ³ØªØ®Ø¯Ù… localDb) - ÙƒÙ…Ø§ Ù‡ÙŠ
        const removeFromCart = (cartId) => {
             const itemToRemove = state.cart.find(item => item.cartId === cartId);
             if (!itemToRemove) return;

             showModal(`
                 <div class="p-4 text-center">
                      <i data-lucide="trash-2" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                      <h3 class="text-lg font-semibold mb-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø²Ø§Ù„Ø©</h3>
                      <p class="text-gray-600 mb-6">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© "${itemToRemove.title}" Ù…Ù† Ø§Ù„Ø³Ù„Ø©ØŸ</p>
                      <div class="flex justify-center space-x-4 space-x-reverse">
                          <button id="confirm-remove-item" class="bg-red-600 text-white py-2 px-5 rounded-md font-medium hover:bg-red-700 transition-colors">
                              Ù†Ø¹Ù…ØŒ Ø¥Ø²Ø§Ù„Ø©
                          </button>
                          <button class="modal-close-btn bg-gray-200 text-gray-800 py-2 px-5 rounded-md font-medium hover:bg-gray-300 transition-colors">
                              Ø¥Ù„ØºØ§Ø¡
                          </button>
                      </div>
                  </div>
             `);
              document.getElementById('confirm-remove-item').onclick = () => {
                  state.cart = state.cart.filter(item => item.cartId !== cartId);
                  localDb.set('cart', state.cart);
                  updateCartBadge();
                  renderCartPage(); // Refresh cart page
                  hideModal();
                  showToast('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ù„Ø©.');
              };
        };

        // 9. Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ (Checkout) - ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        const renderCheckoutPage = async () => {
             const pageEl = document.getElementById('page-checkout');
              if (!pageEl) return;
              pageEl.innerHTML = '<div class="flex justify-center items-center h-64"><div class="loader"></div></div>'; // Loader

             const subTotal = state.cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);

             if (state.cart.length === 0) {
                 goTo('#/cart'); // Redirect if cart becomes empty
                 return;
             }

             let wilayas = [];
             let wilayasError = null;
             try {
                  const wilayaData = await fetchYalidineData('wilayas');
                  wilayas = wilayaData?.data || [];
                  wilayas.sort((a, b) => a.id - b.id);
             } catch (error) {
                  console.error("Failed to load wilayas:", error);
                  wilayasError = `Ø®Ø·Ø£ (${error.message || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}) ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.`;
             }

             pageEl.innerHTML = `
                 <h1 class="text-2xl lg:text-3xl font-bold text-gray-900 mb-8 text-center">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</h1>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">
                     <!-- Ø§Ù„ÙÙˆØ±Ù… -->
                     <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow border border-gray-200">
                         <h3 class="text-xl font-semibold mb-5 text-gray-800">1. Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</h3>
                         <form id="checkout-form" class="space-y-4">
                             <div>
                                 <label for="checkout-name" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ <span class="text-red-600">*</span></label>
                                 <input type="text" id="checkout-name" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                             </div>
                             <div>
                                 <label for="checkout-phone" class="block text-sm font-medium text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ <span class="text-red-600">*</span></label>
                                 <input type="tel" id="checkout-phone" name="phone" inputmode="tel" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500" required pattern="^(05|06|07)\\d{8}$" title="ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø±Ù‚Ù… Ø¨Ù€ 05, 06, Ø£Ùˆ 07 Ùˆ ÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…">
                             </div>

                             <h3 class="text-xl font-semibold mb-1 pt-4 text-gray-800">2. Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</h3>
                             ${wilayasError ? `<p class="text-red-600 bg-red-100 p-3 rounded-md text-sm">${wilayasError}</p>` : ''}
                              <!-- Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØµÙŠÙ„ -->
                             <div class="radio-card-group grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                                  <label id="delivery-office-label" class="disabled">
                                      <input type="radio" name="delivery_type" value="office" disabled>
                                      <div class="radio-card">
                                           <div class="icon">
                                                <!-- Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…ÙƒØªØ¨/Ù…Ø¨Ù†Ù‰ -->
                                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                           </div>
                                           <span class="font-semibold text-gray-800">Ù…ÙƒØªØ¨ Yalidine</span>
                                           <small class="text-xs text-gray-500 mt-1">Ø§Ø³ØªÙ„Ù… Ù…Ù† Ø£Ù‚Ø±Ø¨ Ù…ÙƒØªØ¨</small>
                                           <span id="desk-fee-display" class="text-sm font-bold text-blue-600 mt-2"></span>
                                      </div>
                                  </label>
                                   <label id="delivery-home-label" class="disabled">
                                       <input type="radio" name="delivery_type" value="home" disabled>
                                       <div class="radio-card">
                                           <div class="icon">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                           </div>
                                           <span class="font-semibold text-gray-800">ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„</span>
                                            <small class="text-xs text-gray-500 mt-1">ØªÙˆØµÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ø¨Ø§Ø¨ Ù…Ù†Ø²Ù„Ùƒ</small>
                                            <span id="home-fee-display" class="text-sm font-bold text-blue-600 mt-2"></span>
                                       </div>
                                   </label>
                             </div>

                             <div>
                                 <label for="checkout-wilaya" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙˆÙ„Ø§ÙŠØ© <span class="text-red-600">*</span></label>
                                 <select id="checkout-wilaya" name="wilaya_id" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white focus:border-blue-500 focus:ring-blue-500" required ${wilayas.length === 0 ? 'disabled' : ''}>
                                      <option value="">-- ${wilayasError ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„' : 'Ø§Ø®ØªØ± ÙˆÙ„Ø§ÙŠØªÙƒ'} --</option>
                                     ${wilayas.map(w => `<option value="${w.id}" data-name="${w.name}">${w.id} - ${w.name}</option>`).join('')}
                                 </select>
                             </div>

                              <div id="commune-or-center-container">
                                  <label id="commune-or-center-label" for="checkout-commune-center" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© / Ø§Ù„Ù…ÙƒØªØ¨ <span class="text-red-600">*</span></label>
                                  <select id="checkout-commune-center" name="commune_or_center_name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white focus:border-blue-500 focus:ring-blue-500" required disabled>
                                       <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ --</option>
                                  </select>
                                   <p id="commune-center-loading" class="text-xs text-blue-600 mt-1 hidden">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª...</p>
                                   <p id="commune-center-error" class="text-xs text-red-600 mt-1 hidden"></p>
                              </div>

                             <div id="address-container" class="hidden">
                                 <label for="checkout-address" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ (Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹...) <span class="text-red-600">*</span></label>
                                                                    <input type="text" id="checkout-address" name="address" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                            </form>
                        </div>

                        <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨ -->
                        <aside class="lg:col-span-1">
                            <div class="bg-white p-6 rounded-lg shadow border border-gray-200 sticky top-24">
                                <h3 class="text-xl font-semibold mb-4 pb-4 border-b text-gray-800">Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3>
                                <!-- Cart Items Mini View -->
                                <div class="space-y-3 max-h-48 overflow-y-auto mb-4 pr-2 border-b pb-4">
                                    ${state.cart.map(item => `
                                        <div class="flex items-center space-x-3 space-x-reverse">
                                            <div class="relative flex-shrink-0">
                                                <img src="${item.image_url}" alt="${item.title}" class="w-12 h-14 object-cover rounded-md border">
                                                <span class="absolute -top-2 -right-2 bg-gray-600 text-white text-[10px] font-bold rounded-full h-4 w-4 flex items-center justify-center">${item.quantity}</span>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium text-gray-800 truncate">${item.title}</p>
                                                <p class="text-xs text-gray-500 truncate">${item.optionsText}</p>
                                            </div>
                                            <p class="text-sm font-medium flex-shrink-0" dir="ltr">${(item.price * item.quantity).toLocaleString('fr-DZ')} DZD</p>
                                        </div>
                                    `).join('')}
                                </div>
                                <!-- Totals -->
                                <div class="space-y-3 text-sm pt-4" dir="ltr">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Subtotal</span>
                                        <span class="font-medium text-gray-800">${subTotal.toLocaleString('fr-DZ')} DZD</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Shipping</span>
                                        <span id="shipping-cost" class="font-medium text-gray-800">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</span>
                                    </div>
                                    <div class="flex justify-between text-lg font-bold text-gray-900 mt-4 pt-4 border-t border-gray-300">
                                        <span>Total</span>
                                        <span id="total-cost" class="font-medium">${subTotal.toLocaleString('fr-DZ')} DZD</span>
                                    </div>
                                </div>
                                <button type="submit" form="checkout-form" id="submit-order-btn" class="w-full text-center mt-6 bg-blue-600 text-white py-3 px-6 rounded-md font-medium text-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center" disabled>
                                    <span class="btn-text">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</span>
                                    <div class="loader btn-loader hidden" style="width: 24px; height:24px; border-width: 3px;"></div>
                                </button>
                                 <p class="text-xs text-center text-gray-500 mt-3">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ù…ØªÙˆÙØ±.</p>
                            </div>
                        </aside>
                    </div>
                `;

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶Ù‡Ø§
            setupCheckoutListeners(subTotal);
             // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª
            if (wilayasError) {
                 showToast(wilayasError, 'error', 5000);
            }
        };

        // 10. Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹
        const setupCheckoutListeners = (subTotal) => {
            const form = document.getElementById('checkout-form');
            const wilayaSelect = document.getElementById('checkout-wilaya');
            const communeCenterSelect = document.getElementById('checkout-commune-center');
            const shippingCostEl = document.getElementById('shipping-cost');
            const totalCostEl = document.getElementById('total-cost');
            const addressContainer = document.getElementById('address-container');
            const checkoutAddressInput = document.getElementById('checkout-address');
            const deliveryTypeRadios = form.querySelectorAll('input[name="delivery_type"]');
            const submitBtn = document.getElementById('submit-order-btn');
             const submitBtnText = submitBtn.querySelector('.btn-text');
             const submitBtnLoader = submitBtn.querySelector('.btn-loader');
            const communeCenterLoadingEl = document.getElementById('commune-center-loading');
            const communeCenterErrorEl = document.getElementById('commune-center-error');
             const communeCenterLabel = document.getElementById('commune-or-center-label');
             const officeLabel = document.getElementById('delivery-office-label');
             const homeLabel = document.getElementById('delivery-home-label');
             const officeRadio = officeLabel?.querySelector('input');
             const homeRadio = homeLabel?.querySelector('input');
             const deskFeeDisplay = document.getElementById('desk-fee-display');
             const homeFeeDisplay = document.getElementById('home-fee-display');

            let currentShippingCost = null; // null indicates not calculated yet
            let deliveryFees = { home: null, desk: null }; // Store fees for the selected wilaya

            const updateTotal = () => {
                const calculatedShipping = currentShippingCost ?? 0;
                shippingCostEl.textContent = currentShippingCost !== null ? `${calculatedShipping.toLocaleString('fr-DZ')} DZD` : 'Ø§Ø®ØªØ± Ø§Ù„ØªÙˆØµÙŠÙ„';
                totalCostEl.textContent = `${(subTotal + calculatedShipping).toLocaleString('fr-DZ')} DZD`;
                // Enable submit button only if shipping is calculated (not null) and > 0, and form is potentially valid
                submitBtn.disabled = currentShippingCost === null || currentShippingCost < 0 ; // Allow 0 DZD shipping
            };

             const resetDeliveryOptions = () => {
                 deliveryFees = { home: null, desk: null };
                 currentShippingCost = null;
                 communeCenterSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ --</option>';
                 communeCenterSelect.disabled = true;
                 addressContainer.classList.add('hidden');
                 checkoutAddressInput.required = false;
                 communeCenterLoadingEl.classList.add('hidden');
                 communeCenterErrorEl.classList.add('hidden');
                 // Reset and disable radio buttons and labels
                 if(officeRadio) officeRadio.disabled = true;
                 if(homeRadio) homeRadio.disabled = true;
                 if(officeRadio) officeRadio.checked = false;
                 if(homeRadio) homeRadio.checked = false;
                 officeLabel.classList.add('disabled');
                 homeLabel.classList.add('disabled');
                 if(deskFeeDisplay) deskFeeDisplay.textContent = '';
                 if(homeFeeDisplay) homeFeeDisplay.textContent = '';
                 updateTotal();
             };


            // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
            wilayaSelect.addEventListener('change', async () => {
                 const wilayaId = wilayaSelect.value;
                  resetDeliveryOptions(); // Reset everything related to delivery

                if (!wilayaId) {
                    return;
                }

                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                communeCenterLoadingEl.classList.remove('hidden');
                communeCenterLoadingEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø´Ø­Ù†...';
                communeCenterErrorEl.classList.add('hidden');
                 submitBtn.disabled = true; // Disable submit while loading fees

                try {
                     // Ø¬Ù„Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø´Ø­Ù† Ø£ÙˆÙ„Ø§Ù‹
                     const feesDataResponse = await fetchYalidineData('fees', { to_wilaya_id: wilayaId });
                     console.log("Fees Response:", feesDataResponse);

                      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª per_commune (Ù‡ÙŠÙƒÙ„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù‚Ø¯ ØªØ®ØªÙ„Ù)
                      // Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ PHPØŒ Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒØ§Ø¦Ù† per_commune
                      const feesData = feesDataResponse?.per_commune;

                     if (feesData && Object.keys(feesData).length > 0) {
                         // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ø³ÙˆÙ… Ø£ÙˆÙ„ Ø¨Ù„Ø¯ÙŠØ© ÙƒÙ…Ø«Ø§Ù„ (ÙƒÙ…Ø§ ÙÙŠ ÙƒÙˆØ¯ PHP)
                          // ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ÙØ§ØªÙŠØ­ `express_home` Ùˆ `express_desk` Ù…ÙˆØ¬ÙˆØ¯Ø©
                         const firstCommuneFeesKey = Object.keys(feesData)[0];
                         const firstCommuneFees = feesData[firstCommuneFeesKey];

                         if (firstCommuneFees) {
                             deliveryFees.home = firstCommuneFees.express_home ?? null; // Use null if undefined
                             deliveryFees.desk = firstCommuneFees.express_desk ?? null;

                             // ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©
                             if (deliveryFees.desk !== null && deliveryFees.desk >= 0) {
                                 officeRadio.disabled = false;
                                 officeLabel.classList.remove('disabled');
                                 deskFeeDisplay.textContent = `${deliveryFees.desk.toLocaleString('fr-DZ')} Ø¯Ø¬`;
                             } else {
                                 deskFeeDisplay.textContent = 'ØºÙŠØ± Ù…ØªØ§Ø­';
                             }
                             if (deliveryFees.home !== null && deliveryFees.home >= 0) {
                                 homeRadio.disabled = false;
                                 homeLabel.classList.remove('disabled');
                                 homeFeeDisplay.textContent = `${deliveryFees.home.toLocaleString('fr-DZ')} Ø¯Ø¬`;
                             } else {
                                 homeFeeDisplay.textContent = 'ØºÙŠØ± Ù…ØªØ§Ø­';
                             }

                             // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£Ø±Ø®Øµ (Ø£Ùˆ Ø§Ù„Ù…ÙƒØªØ¨) ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
                             if (deliveryFees.desk !== null && deliveryFees.desk >= 0) {
                                 officeRadio.checked = true;
                                 officeRadio.dispatchEvent(new Event('change', { bubbles:true })); // Trigger change event
                             } else if (deliveryFees.home !== null && deliveryFees.home >= 0) {
                                 homeRadio.checked = true;
                                 homeRadio.dispatchEvent(new Event('change', { bubbles:true })); // Trigger change event
                             } else {
                                 // No options available
                                 communeCenterLoadingEl.classList.add('hidden');
                                 communeCenterErrorEl.textContent = 'Ø§Ù„Ø´Ø­Ù† ØºÙŠØ± Ù…ØªÙˆÙØ± Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©.';
                                 communeCenterErrorEl.classList.remove('hidden');
                             }

                         } else {
                             throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø´Ø­Ù† Ù„Ù„Ø¨Ù„Ø¯ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰.");
                         }
                     } else {
                         // Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£ Ù‚Ø¯ ÙŠØ¹Ù†ÙŠ Ø£Ù† API key Ø®Ø·Ø£ Ø£Ùˆ Ø£Ù† Yalidine Ù„Ø§ ØªØ¯Ø¹Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
                          console.error("Fees data 'per_commune' is missing or empty.", feesDataResponse);
                         throw new Error(feesDataResponse?.message || "Ø§Ù„Ø´Ø­Ù† ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©. (e:2)");
                     }

                } catch (error) {
                     console.error("Error fetching/processing shipping fees:", error);
                     resetDeliveryOptions();
                     communeCenterLoadingEl.classList.add('hidden');
                     communeCenterErrorEl.textContent = error.message || "Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø´Ø­Ù†.";
                     communeCenterErrorEl.classList.remove('hidden');
                      showToast(error.message || "Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø´Ø­Ù†.", 'error');
                }
            });

            // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØµÙŠÙ„
            deliveryTypeRadios.forEach(radio => {
                radio.addEventListener('change', async () => {
                    const selectedType = form.querySelector('input[name="delivery_type"]:checked').value;
                    const wilayaId = wilayaSelect.value;
                     currentShippingCost = null; // Reset cost until communes/centers are loaded and selected
                     communeCenterSelect.innerHTML = '<option value="">-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª --</option>';
                     communeCenterSelect.disabled = true;
                     addressContainer.classList.add('hidden');
                     checkoutAddressInput.required = false; // Reset address requirement
                     communeCenterLoadingEl.classList.remove('hidden');
                     communeCenterLoadingEl.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª...';
                     communeCenterErrorEl.classList.add('hidden');
                     submitBtn.disabled = true; // Disable submit while loading options

                     let options = [];
                     let errorMsg = null;

                     try {
                         if (selectedType === 'home') {
                             communeCenterLabel.textContent = 'Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© *';
                             communeCenterSelect.name = 'commune_or_center_name'; // Use appropriate name
                             addressContainer.classList.remove('hidden');
                             checkoutAddressInput.required = true;
                             currentShippingCost = deliveryFees.home; // Set cost directly

                             const communeData = await fetchYalidineData('communes', { wilaya_id: wilayaId });
                             options = communeData?.data || [];
                             if (options.length === 0) errorMsg = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø¯ÙŠØ§Øª Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©.';

                         } else { // office
                             communeCenterLabel.textContent = 'Ù…ÙƒØªØ¨ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… *';
                             communeCenterSelect.name = 'commune_or_center_name'; // Use appropriate name
                             // Address is not required for office delivery
                             currentShippingCost = deliveryFees.desk; // Set cost directly

                             const centerData = await fetchYalidineData('centers', { wilaya_id: wilayaId });
                             options = centerData?.data || [];
                             if (options.length === 0) errorMsg = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØ§ØªØ¨ Ø§Ø³ØªÙ„Ø§Ù… Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©.';
                         }

                         // Populate dropdown
                         communeCenterSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± --</option>';
                         if (options.length > 0) {
                             options.sort((a, b) => a.name.localeCompare(b.name, 'ar')); // Sort alphabetically
                             options.forEach(opt => {
                                 // For centers, the 'name' is the commune name where the center is located
                                 communeCenterSelect.innerHTML += `<option value="${opt.name}">${opt.name}</option>`;
                             });
                             communeCenterSelect.disabled = false;
                         } else {
                             communeCenterSelect.innerHTML = `<option value="">${errorMsg || '-- Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ÙŠØ§Ø±Ø§Øª --'}</option>`;
                             if (errorMsg) {
                                 communeCenterErrorEl.textContent = errorMsg;
                                 communeCenterErrorEl.classList.remove('hidden');
                             }
                         }

                    } catch (error) {
                         console.error(`Error fetching ${selectedType === 'home' ? 'communes' : 'centers'}:`, error);
                         errorMsg = `Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© ${selectedType === 'home' ? 'Ø§Ù„Ø¨Ù„Ø¯ÙŠØ§Øª' : 'Ø§Ù„Ù…ÙƒØ§ØªØ¨'}.`;
                         communeCenterSelect.innerHTML = `<option value="">${errorMsg}</option>`;
                         communeCenterErrorEl.textContent = errorMsg;
                         communeCenterErrorEl.classList.remove('hidden');
                         showToast(errorMsg, 'error');
                    } finally {
                         communeCenterLoadingEl.classList.add('hidden');
                         updateTotal(); // Update total cost (might enable submit button if options loaded and selected)
                    }
                });
            });

             // Update total when commune/center is selected (ensure shipping cost is applied)
             communeCenterSelect.addEventListener('change', () => {
                 updateTotal(); // Just recalculate total and button state
             });


            // Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ±Ù…
             form.addEventListener('submit', (e) => handleCheckoutSubmit(e, subTotal)); // Pass subTotal
        };

        // 11. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Checkout Submit) - Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase Transaction
        const handleCheckoutSubmit = async (e, subTotal) => {
            e.preventDefault();
            const form = e.target;
            const submitBtn = document.getElementById('submit-order-btn');
            const submitBtnText = submitBtn.querySelector('.btn-text');
            const submitBtnLoader = submitBtn.querySelector('.btn-loader');

            // Basic form validation (HTML5 required should handle most)
            if (!form.checkValidity()) {
                showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.', 'error');
                form.reportValidity(); // Show browser's default validation messages
                return;
            }
             // Validate delivery type selection
             const selectedDeliveryType = form.querySelector('input[name="delivery_type"]:checked');
             if (!selectedDeliveryType) {
                 showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØµÙŠÙ„.', 'error');
                 return;
             }
             // Validate commune/center selection
             const communeCenterSelect = document.getElementById('checkout-commune-center');
             if (!communeCenterSelect.value) {
                 showToast(`ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ${selectedDeliveryType.value === 'home' ? 'Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©' : 'Ù…ÙƒØªØ¨ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…'}.`, 'error');
                 communeCenterSelect.focus();
                 return;
             }
             // Validate address if home delivery
             const addressInput = document.getElementById('checkout-address');
             if (selectedDeliveryType.value === 'home' && !addressInput.value.trim()) {
                 showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ø§Ù„ØªÙØµÙŠÙ„.', 'error');
                 addressInput.focus();
                 return;
             }

            if(submitBtn) submitBtn.disabled = true;
            if(submitBtnText) submitBtnText.classList.add('hidden');
            if(submitBtnLoader) submitBtnLoader.classList.remove('hidden');

             // Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø­Ø³ÙˆØ¨
             const finalShippingCostText = document.getElementById('shipping-cost').textContent;
             const finalShippingCostMatch = finalShippingCostText.match(/([\d,]+(?:\.\d+)?)/); // Extract number
             const finalShippingCost = finalShippingCostMatch ? parseFloat(finalShippingCostMatch[1].replace(',', '.')) : null; // Handle potential locale differences

             if (finalShippingCost === null || finalShippingCost < 0) {
                 showToast('Ø®Ø·Ø£ ÙÙŠ Ø³Ø¹Ø± Ø§Ù„Ø´Ø­Ù†. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©.', 'error');
                 if(submitBtn) submitBtn.disabled = false;
                 if(submitBtnText) submitBtnText.classList.remove('hidden');
                 if(submitBtnLoader) submitBtnLoader.classList.add('hidden');
                 return;
             }

             // --- Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Firebase Transaction) ---
             try {
                 const wilayaOption = document.querySelector(`#checkout-wilaya option[value="${form.wilaya_id.value}"]`);
                 const orderData = {
                     // Ù„Ø§ Ù†Ø¶Ø¹ ID Ù‡Ù†Ø§ØŒ Firestore Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡
                     createdAt: serverTimestamp(), // Use server timestamp
                     name: form.name.value,
                     phone: form.phone.value,
                     wilaya: wilayaOption ? wilayaOption.dataset.name : `ID: ${form.wilaya_id.value}`, // Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
                     commune: form.commune_or_center_name.value, // Ø§Ø³Ù… Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© Ø£Ùˆ Ø§Ù„Ù…ÙƒØªØ¨
                     address: selectedDeliveryType.value === 'home' ? form.address.value : `Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ù…ÙƒØªØ¨ Yalidine (${form.commune_or_center_name.value})`, // Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…ÙƒØªØ¨
                     delivery_type: selectedDeliveryType.value, // 'home' or 'office'
                     cart: state.cart.map(item => ({ // Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù„Ø§Ø²Ù…Ø©
                         ...item,
                         selectedOptions: item.optionsText ? item.optionsText.split(' / ').map(opt => ({ value: opt })) : [] // Ù„Ù„Ø­ÙØ¸
                     })),
                     shipping_cost: finalShippingCost,
                     grand_total: subTotal + finalShippingCost,
                     status: 'pending', // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
                     yalidine_tracking_id: null,
                     userId: userId // Ø±Ø¨Ø· Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ù…Ø¬Ù‡ÙˆÙ„Ø§Ù‹)
                 };

                 // ØªÙ†ÙÙŠØ° Transaction Ù„Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                 await runTransaction(db, async (transaction) => {
                     // 1. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ¬Ù„Ø¨ Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                     const productRefsToUpdate = new Map(); // Map<string, {ref: DocumentReference, data: any}>
                     for (const item of orderData.cart) {
                         const productRef = doc(db, 'products', item.product_id);
                         const productSnap = await transaction.get(productRef);

                         if (!productSnap.exists()) {
                             throw new Error(`Ø§Ù„Ù…Ù†ØªØ¬: ${item.title} Ù„Ù… ÙŠØ¹Ø¯ Ù…ØªÙˆÙØ±Ø§Ù‹!`);
                         }

                         const productData = productSnap.data();
                         const variantIndex = productData.variants.findIndex(v => v.id == item.variant_id);

                         if (variantIndex === -1) {
                             throw new Error(`Ø§Ù„Ø®ÙŠØ§Ø±: ${item.optionsText} Ù„Ù„Ù…Ù†ØªØ¬ ${item.title} Ù„Ù… ÙŠØ¹Ø¯ Ù…ØªÙˆÙØ±Ø§Ù‹!`);
                         }

                         const variant = productData.variants[variantIndex];
                         if (variant.stock_quantity < item.quantity) {
                              throw new Error(`Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ù… ÙŠØ¹Ø¯ ÙƒØ§ÙÙŠØ§Ù‹ Ù„Ù„Ù…Ù†ØªØ¬: ${item.title} (${item.optionsText}). Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${variant.stock_quantity}`);
                         }

                         // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªØ­Ø¯ÙŠØ«
                         productData.variants[variantIndex].stock_quantity -= item.quantity;
                         productRefsToUpdate.set(item.product_id, { ref: productRef, data: productData });
                     }

                     // 2. Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                     const newOrderRef = doc(collection(db, "orders")); // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¬Ø¹ Ù„Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                     transaction.set(newOrderRef, orderData);
                     orderData.id = newOrderRef.id; // Ø­ÙØ¸ Ø§Ù„Ù€ ID Ù„Ø¹Ø±Ø¶Ù‡ ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ (Ù…Ø¤Ù‚ØªØ§Ù‹)

                     // 3. ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø²ÙˆÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                     productRefsToUpdate.forEach(updateInfo => {
                         transaction.update(updateInfo.ref, { variants: updateInfo.data.variants, updatedAt: serverTimestamp() });
                     });
                 });

                 // --- Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ù€ Transaction ---
                 console.log("Order submitted successfully!");

                 // 4. Ø¥ÙØ±Ø§Øº Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                 state.cart = [];
                 localDb.set('cart', []);
                 updateCartBadge();

                 // 5. Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                 showModal(`
                     <div class="p-4 text-center">
                         <i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto mb-4"></i>
                         <h3 class="text-2xl font-bold mb-2">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</h3>
                         <p class="text-gray-600 mb-6">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ…. Ø³Ù†ØªØµÙ„ Ø¨ÙƒÙ… Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨. Ø±Ù‚Ù… Ø·Ù„Ø¨Ùƒ Ù‡Ùˆ <strong class="font-bold text-gray-900">#${orderData.id.slice(-6)}</strong>.</p>
                         <button class="modal-close-btn w-full bg-gray-900 text-white py-2 px-4 rounded-md font-medium hover:bg-gray-800 transition-colors">
                             Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ³ÙˆÙ‚
                         </button>
                     </div>
                 `, 'max-w-md'); // Larger modal for success

                 // 6. Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                 document.querySelector('#modal-container .modal-close-btn').addEventListener('click', () => {
                     hideModal();
                     goTo('#/');
                 });

            } catch (error) {
                 console.error("Checkout failed:", error);
                 showToast(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨.', 'error', 5000);
                 if(submitBtn) submitBtn.disabled = false; // Re-enable button on error
                 if(submitBtnText) submitBtnText.classList.remove('hidden');
                 if(btnLoader) btnLoader.classList.add('hidden');
            }
        };


        // ==========================================
        // Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        // ==========================================
        // Ø§Ø¨Ø¯Ø£ Ø¨ØªÙ‡ÙŠØ¦Ø© FirebaseØŒ Ø§Ù„Ø°ÙŠ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø¯ÙˆØ±Ù‡ Ø¨ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        initializeFirebase();

    </script>

</body>
</html>
